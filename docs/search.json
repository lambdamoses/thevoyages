[
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "",
    "text": "Seurat is the standard package to analyze single cell and spatial -omics data in R, and Scanpy is the standard in Python. There has long been the R vs.¬†Python debate in data science, though many, including myself, would say both R and Python though I use them for different data analysis tasks. However, many people do prefer one language to the other for a variety of reasons. I‚Äôm not here to add fuel to the flame war. Rather, I‚Äôm elaborating on the observation that the choice of language can greatly affect biological conclusions, because Seurat and Scanpy have different defaults and internals most users may be unaware of, so by using the default settings of the de facto standard single cell and spatial -omics package in our language of choice, we inadvertently end up with different conclusions, which is bad news for reproducibility. For example, Seurat and Scanpy give quite different log fold changes for marker genes:\nFor the R package Voyager, we try to avoid this. Our collaborators in Iceland are working on a Python implementation of Voyager for those who prefer Python, and are writing ‚Äúcompatibility tests‚Äù to make sure that the R and Python implementations of Voyager give consistent results for core functionalities, such as those in the most introductory vignettes of R Voyager that don‚Äôt go beyond Moran‚Äôs I in spatial analysis. However, on the long run, we don‚Äôt expect the R and Python implementations to match everywhere, since some tools may be available in only one of R and Python, such as statistical tools specific to R and deep learning tools specific to Python. It turns out that with default settings, the same data normalization, and same list of highly variable genes, R and Python Voyagers gave different PCA results, because of a cryptic difference that R divides by n-1 (unbiased estimate when mean is unknown) while Scipy divides by n (maximum likelihood estimate) when computing variance. For better reproducibility, these hidden defaults should be made transparent. This made us wonder if ‚Äì using default settings ‚Äì whether Seurat and Scanpy give consistent PCA results."
  },
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#variance-explained",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#variance-explained",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "Variance explained",
    "text": "Variance explained\nSeurat‚Äôs elbow plot plots standard deviation explained by each PC while Scanpy‚Äôs elbow plot plots variance ratio. Here I compute the variance ratio explained by each PC in Seurat:\n\ntot_variance <- Misc(Reductions(seu, \"pca\"))[[\"total.variance\"]]\nvar_explained <- Stdev(seu, reduction = \"pca\")^2/tot_variance\n\n\nvar_explained_py <- py$adata$uns[\"pca\"][\"variance_ratio\"][[1]]\n\nHere we plot the variance explained by each PC by Seurat and Scanpy in the same plot:\n\nplot_var_explained <- function(ve_r, ve_py, npcs = 20, title = NULL) {\n    pcs_ve <- tibble(Seurat = ve_r,\n                 Scanpy = ve_py,\n                 PC = seq_len(npcs)) |> \n        pivot_longer(cols = Seurat:Scanpy, names_to = \"package\", values_to = \"value\")\n    ggplot(pcs_ve, aes(PC, value, color = package, shape = package)) +\n        geom_point() +\n        scale_color_manual(values = c(Seurat = \"#198CE7\", Scanpy = \"#3572A5\")) +\n        scale_x_continuous(breaks = scales::breaks_width(2)) +\n        labs(y = \"Proportion of variance explained\", \n             title = title)\n}\n\n\nplot_var_explained(var_explained, var_explained_py,\n                   title = \"PC variance explained, default settings\")\n\n\n\n\nWhereas Scanpy does divide by n-1 when calculating the variance when scaling the data (see source code), the variance explained by the PCs don‚Äôt match. I did not regress out any variable when scaling data with Seurat. I will later find out what causes this discrepancy, but for now, let‚Äôs also look at the discrepancies in spot embeddings and gene loadings."
  },
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#embeddings",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#embeddings",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "Embeddings",
    "text": "Embeddings\n\nPCAPlot(seu) + theme(legend.position = \"none\")\n\n\n\n\n\nsc.pl.pca(adata)\n\n/Users/lambda/.virtualenvs/r-reticulate/lib/python3.10/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  cax = scatter(\n\n\n\n\n\nThe overall patterns are the same. Scanpy‚Äôs PC2 is flipped, but that‚Äôs OK, because an eigenvector scaled by a scalar is still an eigenvector with the same eigenvalue.\nHere I flip Scanpy‚Äôs PC2 and plot the embeddings in the first 2 PCs from Seurat and Scanpy together:\n\npca_embeddings <- Embeddings(seu, reduction = \"pca\")\npca_embeddings_py <- py$adata$obsm[\"X_pca\"]\ncolnames(pca_embeddings_py) <- colnames(pca_embeddings)\n\n\nplot_pca_compare <- function(embeddings_r, embeddings_py, pcs = 1:2, \n                             title = NULL) {\n    # See if needs to be flipped\n    for (i in pcs) {\n        v <- c(max(embeddings_r[,i] - embeddings_py[,i]), \n               max(embeddings_r[,i] + embeddings_py[,i]))\n        if (which.min(v) == 2L) # do flip\n            embeddings_py[,i] <- -embeddings_py[,i]\n    }\n    df_seu <- as_tibble(embeddings_r[,pcs]) |> \n        mutate(package = \"Seurat\",\n               ID = seq_len(nrow(embeddings_r)))\n    df_adata <- as_tibble(embeddings_py[,pcs]) |> \n        mutate(package = \"Scanpy\",\n               ID = seq_len(nrow(embeddings_r)))\n    names(df_seu)[1:2] <- names(df_adata)[1:2] <- c(\"x\", \"y\")\n    df_seu$package <- \"Seurat\"\n    df_adata$package <- \"Scanpy\"\n    df <- rbind(df_seu, df_adata)\n    df2 <- df |> \n        pivot_wider(names_from = package, values_from = c(x, y))\n    ggplot(df) +\n        geom_point(aes(x, y, color = package, shape = package), alpha = 0.4) +\n        geom_segment(data = df2, aes(x = x_Seurat, y = y_Seurat,\n                                     xend = x_Scanpy, yend = y_Scanpy)) +\n        scale_color_manual(values = c(Seurat = \"#198CE7\", Scanpy = \"#3572A5\")) +\n        labs(x = paste0(\"PC\", pcs[1]), y = paste0(\"PC\", pcs[2]),\n             title = title) +\n        guides(color = guide_legend(override.aes = list(alpha = 1)))\n}\n\n\nplot_pca_compare(pca_embeddings, pca_embeddings_py,\n                 title = \"PCA embeddings, Seurat vs. Scanpy\")\n\n\n\n\nHere while the spot embeddings in the first 2 PCs largely agree, some discrepancies are visible. The black segments in the plot connect corresponding points from Seurat and Scanpy embeddings. If the discrepancy is sizable, then the segment will be visible, which is sometimes the case, especially for spots with high PC1 values in this plot. Also see PCs 3-4:\n\nplot_pca_compare(pca_embeddings, pca_embeddings_py, pcs = 3:4,\n                 title = \"PCA embeddings, Seurat vs. Scanpy\")\n\n\n\n\nThe discrepancies are larger in PCs 3-4, with the segment visible almost everywhere and longer among points with higher absolute values on PC4. Since more than 4 PCs are typically used for clustering, and the clusters are then used for differential expression, such discrepancies might manifest in different biological conclusions.\nSince it‚Äôs not easy to plot all 20 PCs as scatter plots, we compare the PCA embeddings numerically:\n\nplot_r_py_pc_diffs <- function(mat_r, mat_py, npcs = 20, title = NULL) {\n    diffs <- numeric(npcs)\n    for (i in seq_len(npcs)) {\n        pc_r <- mat_r[,i]\n        pc_py <- mat_py[,i]\n        diffs[i] <- min(mean(abs(pc_r - pc_py)), mean(abs(pc_r + pc_py))) # flipped\n    }\n    tibble(difference = diffs,\n           PC = seq_len(npcs)) |> \n        ggplot(aes(PC, difference)) +\n        geom_line() +\n        geom_hline(yintercept = sqrt(.Machine$double.eps), linetype = 2) +\n        scale_y_log10() +\n        scale_x_continuous(breaks = scales::breaks_width(2)) +\n        annotation_logticks(sides = \"l\") +\n        labs(title = title, y = \"Mean absolute difference\")\n}\n\nBecause the PCs can be flipped, we compare the PCs one by one:\n\nplot_r_py_pc_diffs(pca_embeddings, pca_embeddings_py, \n                   title = \"Differences in embeddings, Seurat vs. Scanpy\")\n\n\n\n\nThe differences are large, and get larger with PCs that explain less variance, far beyond epsilon explainable by machine precision (dashed horizontal line), which is around 1.5e-8. The mean absolute difference across spots rises from about 0.01 for PC1 to 1 and higher after PC9."
  },
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#gene-loadings",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#gene-loadings",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "Gene loadings",
    "text": "Gene loadings\nHow about gene loadings?\n\npca_loadings2 <- Loadings(seu2, reduction = \"pca\")\n\nAgain, because of the flipping, we compare the loadings for each PC one by one, taking into account the flipping.\n\nplot_r_py_pc_diffs(pca_loadings2, pca_loadings_py, \n                   title = \"Differences in loadings, Seurat vs. Scanpy, no clipping\")\n\n\n\n\nJust like for the embeddings, the differences are generally not large, but get larger for the PCs that explain less variance, rising from about 6e-9 at PC1 to around 1e-5 at PC20. The dashed line is sqrt(.Machine$double.eps), which is around 1.5d-8. Only the first 3 PCs have loadings with less than epsilon in mean absolute difference between Seurat and Scanpy."
  },
  {
    "objectID": "posts/2023-02-20-east-side-riders/index.html",
    "href": "posts/2023-02-20-east-side-riders/index.html",
    "title": "East Side Riders",
    "section": "",
    "text": "Captain‚Äôs Log, stardate 100712.73. Earth date 02/11/2023, but it took me a while to write the Captain‚Äôs Log. To support free and open source software (FOSS), I put my photos on Pixelfed, a FOSS alternative to Instagram that can be self-hosted, though they‚Äôre not well-organized there; Captain‚Äôs Log is where you find their contexts but you can dig through all my photos on Pixelfed. I wish that there‚Äôs a FOSS alternative to Strava. It‚Äôs probably not difficult to implement. However, I haven‚Äôt completely quit corporate mass surveillance social media because many people and organizations I follow are only on corporate social media. I‚Äôve been pretty satisfied with Mastodon so far. Still new to Pixelfed so can‚Äôt comment much yet. Mastodon, Pixelfed, and many other social network apps are part of the Fediverse. Please give Fediverse a shot!\n\n\n\nFlyer for this ride; I‚Äôm not the only person calling bike rides ‚Äúvoyages‚Äù.\n\n\n‚ÄúI probably can‚Äôt make it,‚Äù I said to myself, as I just snoozed for 20 minutes. Now I‚Äôm blessed with flexible work schedule, but if I keep on living this way, then I‚Äôll be doomed once I lose this flexibility after I graduate. I kept on getting up too late, until I need to yank myself out of bed to either conform to an earlier social schedule of events or maximize daylight time for a voyage. Because without Frozen Turkey, I often have trouble stopping what I‚Äôm doing, ending up staying up. Willowbrook is kind of far from Pasadena. Taking into account traffic lights and the slow and chaotic part of DTLA, it would realistically take me about 1 and a half hours to ride hard and fast to cover the 21 miles to get to Willowbrook, where this family friendly East Side Rider ride took place. I only had less than 1:15 left. Anyway, if I still feel tired, then I‚Äôll go elsewhere, like re_ grocery first and then Monrovia. Or worst case scenario, they leave without me, and I‚Äôll just continue on my own adventure, to check out some murals and interesting places on Central Ave that I blew past last time in CicLAvia last December. Or perhaps, just like the Tour de North Carson last March, I rode hard but still arrived 2 minutes late, only to find out that they wouldn‚Äôt roll until half an hour later, so I had quite a bit of time to kill, talking to other riders.\n\n\n\n\n\nOn the way to Willowbrook\nThe slow part of DTLA began, slow because of frequent stops, from traffic lights, and because cars and shared scooters not being ridden often block the bike lane. My usual route through DTLA takes the N Spring St bike lane. The part of Spring St by the LA City Hall was closed, for an Iranian protest, presumably against the official celebration of the 44th anniversary of the Iranian ‚ÄúIslamic‚Äù Republic. The protest hadn‚Äôt started yet. But Boo! Lots of Iranian Imperial flags. Maybe monarchists there. Death to monarchy, and death to all forms of authoritarianism! Anyway, I was running late. No time to take photos or to talk to people. While the road was closed, I could ride on the sidewalk, just more slowly. Meanwhile ‚Äì not to downplay the atrocities committed by the blasphemous Iranian government ‚Äì I wonder, on January 21, why couldn‚Äôt we close the road when we protested against the death of 312 people from traffic violence in LA City in 2022, which was overshadowed by the Monterey Park shooting that night in the news? Why couldn‚Äôt we close the road to protest against climate suicide as the car and fossil fuel industries resist climate action? Even many progressives don‚Äôt question car culture.\n\n\n\nStreets Are For Everyone (SAFE) die in on January 21, 2023, photo from BikinginLA. I‚Äôm the person next to the Grim Reaper and beneath the Vision Zero is Dying sign, holding the Cars Kill Chidren sign. Senator Portantino is at the lower right corner, in white and red. I talked to the person in the Grim Reaper costume. She has lived in LA for 7 years without a car. There‚Äôs the claim that most residential areas in LA are mostly flat, and with the nice weather, there‚Äôs no excuse for LA not to be a bike mecca. I think from my personal experience, the mostly flat claim is mosty true, but I need to do a formal analysis to see how true it is.\n\n\nInitially I planned to take a detour at 52nd street and Avalon Blvd to see the murals at Dr.¬†Maya Angelou Community High School (where the ‚ÄúHate has caused a lot of problems‚Ä¶‚Äù comes from) on the way to Willowbrook, but decided to go there on the way back instead because I was running late and my traffic light luck wasn‚Äôt great. There were many murals and walls full of graffiti in this region. Having been fascinated with graffiti since 2008 due to my first trip to LA, I put these graffiti walls in Highland Park in my Hall of Fame, but there were too many here for me to keep track. While it‚Äôs nice to have a protected bike lane, it‚Äôs annoying when it‚Äôs often blocked by cars (now I need to dodge the bollards) and when there‚Äôs more trash and potentially flat causing debris in the bike lane. I passed several cyclists, most likely local, riding cheap mountain or commuter bikes, often riding on the sidewalk, a very different culture from that of the rich middle aged men in Lycra (MAMILs). I wonder what those cyclists thought when I passed them. While I don‚Äôt really feel like I fit into the MAMIL culture, as if my voyages (especially the urban adventures) is a completely different sport, I certainly did dress the MAMIL way, adjusted for gender and age. It was cold, but I rode hard enough to work up a sweat.\n\n\nKill some time before rolling\nFinally, left turn at 120th St.¬†I just rode over 120 blocks! Somehow that sounded impressive. Actually more than 120, because there are streets with the same number but different suffices, such as 52nd St and 52nd Pl. Here‚Äôs an imperfect explanation for the duplicates. I was at least 15 minutes late. I was right. When I got to Central Ave, I saw a bunch of cyclists at the parking lot at the East Side Riders bike shop and co-op, haven‚Äôt departed yet. This is a family friendly ride, not meant for speed craving road warriors. But everyone was welcome. This shop really likes fat-tired lowrider bikes. It also sold skates, which I also see used in CicLAvia. I also saw cruiser style e-bikes, and two Razor mini electric motorcycles without pedals. Nor was I the only roadiot there. There was at least one recent model road bike, and a few vintage ones.\n\n\n\nLowrider and cruiser bikes at the ESR bike shop\n\n\n\n\n\nThe lowrider bike depicted on that high vis vest, and the skates\n\n\nWhile I enjoy the thrill of speed, I did not come here for speed. Rather, I came to learn about the culture of South LA, in solidarity with this working class neighborhood of color. True, there are more dangerous roads and gangs, but I tend to find poor neighborhoods more vibrant and edgy than rich ones and graffiti is part of it. It‚Äôs precisely the edge that I like. A long term goal of the voyages is to learn about the different cultures of each region of LA, as well as different cycling cultures. Travel doesn‚Äôt have to be out of town. As an environmentalist, I try my best not to fly. So far the diverse nooks and crannies of LA have been sufficient to keep me mentally stimulated and made me more connected to the land and care more about local politics and history. That‚Äôs one of my favorite aspects of LA. I have participated in various types of cycling culture, such as the MAMIL roadie culture and road racing culture at my main club Pasadena Athletic Association (PAA), track racing culture at the Carson velodrome, advocacy culture with Bike LA (formerly LACBC), Pasadena Complete Streets Coalition, CicLAvia, Active SGV and Critical Mass, and bikepacking and touring culture.\nI came to this specific ride, of the advocacy culture (and I suppose lowrider culture as well), which I heard about from BikeLA‚Äôs newsletter, because I admire the missions of East Side Riders (ESR), which started off handing out food to the less fortunate by bike and has improved bike safety in Watts so ‚Äúgang members know not to bother folks on bikes‚Äù, and People for Mobility Justice, which advocates for active transport in poor neighborhoods of color. I‚Äôm fascinated with murals and there are many in South Central (some I visited in this trip); that started with People for Mobility Justice‚Äôs Eastside mural ride guide. These murals document community history that may not be told in ‚Äúofficial‚Äù history written by those in power, and they continue to influence my life, especially the ‚ÄúWe are NOT a Minority‚Äù mural at Estrada Courts on Olympic from the Chicano Moratorium, which gave me confidence and hope in the rebellious movements behind the thin veneer engineered by those in power to show the tourists.\n\n\n\nIndeed, ride for love\n\n\nMost riders I saw were Black or Hispanic, but there were a few Asian and White riders. With my real camera, I could probably pass as the official photographer. I met two other guys with real cameras, at least one was the real official photographer, whose camera had a microphone attached to the hot shoe. He greeted me with a special sense of camaraderie as he saw me taking photos with my real camera.\nIt turned out that I wasn‚Äôt the one who came the furthest. One of the ride marshals drove all the way from Riverside. Maybe not the best for the environment, but he grew up around Willowbrook and Watts and misses the community here, so most likely he would rather live here rather than Riverside if possible. This reminds me of many students who fly across the continent or abroad several times a year to see their families. We need more systemic changes to save our planet, so those who wish to live together can more easily do so, and so plutocratic developers don‚Äôt undemocratically displace people from their deeply rooted communities at whim. Of course, a prerequisite is to liberate ourselves from egotistical microfascism and oppressive systems of beliefs, so we don‚Äôt end up like White NIMBYs protesting a Black neighbor moving in. LA is losing Black people, from gentrification of Black neighborhoods, pushing them to Antelope Valley and Inland Empire.\n\n\n\nThe Razor electric mini motorcycle. Earlier someone crashed it as it accelerated too quickly and she lost control.\n\n\n\n\nRide 4 love\nIt was almost 11 am. Finally ready to roll! It was so slow that I shifted to the small chain ring. Again, just like in Critical Mass, sometimes I would ride faster, getting way ahead of the ‚Äúpeloton‚Äù, to take photos of them coming, or I may stop by the side to take photos from behind and later catch up. We took up an entire lane, with the confidence and courage from safety in numbers, mostly riding outside the bike lane, where it‚Äôs only practical to ride single file. At intersections, the ride marshals in high vis vests would hold up traffic when the light turned red, so we could remain in one bloc. At one point (forgot exactly where) holding up traffic made the drivers quite furious, with horns blaring, but most of the time nobody complained and the traffic wasn‚Äôt heavy anyway.\n\n\n\nA few announcements before we roll. Those are the Ride 4 Love sweater, with two bike wheels forming a heart shape.\n\n\n\n\n\nWe took up an entire lane, heading north on Central\n\n\nNot having the route, I didn‚Äôt know the length of the ride, but I overheard someone saying about 12 miles. Riding 12 miles at this pace is no problem for me without refreshment, but we stopped a few times for refreshment and group photos, to cater to all fitness levels. I think that‚Äôs nice, because back in January 2021, I was so out of shape after years of unhealthy lifestyle that left me underweight that biking 2 miles or up a 2% hill could feel challenging. Each rest stop was quite long, which I spent in part talking to other riders.\n\n\n\nLowrider at the first rest stop at the plaza around Central and 109th St, with public art\n\n\n\n\n\nGathering for the first group photo\n\n\n\n\n\nI looked elsewhere while others posed for the group photo\n\n\nThese are some riders I talked to: Jenny from West Hollywood, and Maru from southeast LA. Jenny is an art student who often rides with various groups in the edgy fixie culture. She likes fixies and single speed bikes because of their simplicity and the challenge to climb on too hard a gear. Also, these bikes tend to be cheap and less attractive to thieves. She biked up Griffith Park and Elysian Park hills on a single speed bike and knows a group that does the Griffith Park ride at 6:30 am on fixies. I have met a fixie group at the scenic turnout in Griffith Park at dusk, probably a different group. Impressive, as I used my small chain ring for the climb. At the Tour de North Carson ride, I also met some fixie riders, one wearing an aero time trial helmet and fascinated with track racing while also riding a fixie with high gear ratio on the road.\nWe agree that South Central isn‚Äôt very safe to ride in, despite the Avalon bike lane, because of aggressive drivers, probably aggressive because the road designed for speed invites the aggression. Poor neighborhoods of color are often turned into highways, leading to more dangerous roads and worse pollution. Here we have the wide and fast roads, Avalon, Central, Florence, El Segundo, Firestone, Century Blvd, Imperial Hwy, and etc. crisscrossing the neighborhoods. In Santa Monica, Pasadena, and Boyle Heights, freeways have destroyed neighborhoods of color, while White neighborhoods were more likely to fight off planned freeways. How many highways are there in San Marino? Huntington Dr and Sierra Madre Blvd, and the part in San Marino isn‚Äôt that bad, with a lot of greenery. No freeways. I should do a more formal analysis of length of freeways and multi lane highways with high speed limit in different regions of LA and how that relates to redlining.\nWe also both like Highland Park, for her a climb, for me mostly bombing down the hills but I have to climb on the way back. While I learnt to ride a fixie at the Carson velodrome, I would only ride one in the velodrome as I can‚Äôt be sure to stop promptly at each intersection. What I learnt from the fixie is the track racing culture, which is very different from the urban fixie culture, such as that the track racers I met were overwhelmingly White while urban fixie riders I met tend to be more diverse, and that the urban fixie riders tend to show more of a rebellious vibe than track racers. However, from that Carson rider, there may be some overlap. I‚Äôm not sure if the Bahati Foundation that grew out of Compton is relevant to the intersection. On city streets, I have also witnessed the BMX culture, but I have never participated in it so I don‚Äôt know anything about it. See, I really think it would take years of research and a PhD thesis to write a book to comprehensively document all those different bike cultures in different regions of LA.\nMaru introduced me to the Pave Commute app which in theory has employers or sponsoring companies pay us for bike commutes. I signed up with the CiBiC LA group. I used the app a few times this week and got quite some ‚Äúcoins‚Äù, but I don‚Äôt yet know what I can use those coins for. It‚Äôs supposed to match people with similar routes to form group to commute together. I haven‚Äôt gotten a group yet, probably because I don‚Äôt go to my office on a fixed schedule and the app caters more to regions adjacent to DTLA and Lincoln Heights though it allowed me to join from Pasadena. We exchanged phone numbers, if we wish to ride together or if we want to go to CicLAvia and Critical Mass.\nWatts isn‚Äôt what I thought it is. We rode through a brand new seemingly posh and mostly uninhabited neighborhood around Century Blvd west of Alameda and we stopped at the Starbucks there, where I got some water. However, soon after, we saw much less posh Estrada Courts style apartment complexes. This is the Jordan Downs redevelopment and the shopping plaza with this Starbucks and Nike is also part of the redevelopment. The uninhabited buildings were probably not completed yet. Just like Estrada Courts, Jordan Downs is a public housing project initially built to house World War II workers. The new buildings are the redeveloped region, with a mix of market rate and affordable units, though the website doesn‚Äôt say exactly how many units are affordable. As of writing, the website says the rent of a one bedroom apartment is $673 and that of a two bedroom apartment is $1330, which does sound like an affordable rate, by Pasadena and Westside standards. Bummer: no pets üòø. The Estrada Courts style buildings are the old Jordan Downs. Burning question, does the redevelopment cause gentrification? Whichever case, even if it‚Äôs meant for gentrification, I see how it‚Äôs absorbing the surrounding culture, such as the mural at Starbucks, a style I don‚Äôt see in shopping centers targeting richer people in Pasadena, Glendale, Century City, and Beverly Hills.\n\n\n\nStarbucks mural\n\n\n\n\n\nNew Jordan Downs\n\n\n\n\n\nOld Jordan Downs\n\n\n\n\n\nThis is more typical of Watts, and see that lowrider in action. I tend to see more people riding bikes for errands in poor neighborhoods, and the bike on the sidewalk is unrelated to this ride.\n\n\nNext stop was Watts Towers, which I have visited twice before, first after the Tour de North Carson, and then in CicLAvia last December.\n\n\n\n\n\n\n\n\n\n\n\n\n\nThe crowd at the Watts Towers plaza\n\n\n\n\n\nArts Center buliding\n\n\nThe sun was behind the towers when seen from the plaza, making some photos facing the sun challenging. But it can be a feature rather than a bug when I realized that the shadows cast by the towers are a feature.\n\n\n\nAbout to roll again\n\n\nAlso because of the direction of the sun, I got a better look up close at the other side of Watts Towers.\n\nThen we rode down Willowbrook Ave, next to the railroad, before the last rest stop at the Willowbrooks/Rosa Parks transit center. The ride leader said we were behind schedule and would make a shortcut to go back to the bike shop. I don‚Äôt know what the original plan was. Here Jenny took off, heading back to West Hollywood.\n\n\n\nThe mini motorcycles in action on Willowbrook Ave\n\n\nOh, I forgot to mention. We had a DJ, though I didn‚Äôt hear the music much because the peloton was so spread out. Here I caught the DJ bike in action:\n\n\n\nThe DJ bike, and look at what good time they‚Äôre having!\n\n\n\n\n\nSee her big smile mirroring mine\n\n\nBack at the bike shop. What did I learn? Well, that sounds too much like a school field trip and I‚Äôm too old for that. I did experience this community and culture and had fun. It‚Äôs only once, so not in depth. The ESR holds a ride every month, and I may come back. Let the experience ferment and influence me in subtle and subconscious ways, and let this thread of experience be woven into my tapestry of worldview. Oh, actually I can put some of what I learn to words: Thank you, ESR, for making Watts more awesome! I know that Watts has a bad reputation as one of the most dangerous neighborhoods in LA. It‚Äôs not my first time here though I always preferred to visit in a group for safety reasons (like I rode with the Carson fixie riders to Watts back in March and CicLAvia already has a group pretext), but this event further showed that Watts has a cool and vibrant culture and made me want to learn more about it. My visits humanized this much avoided neighborhood.\nI was hungry and asked the locals to recommend a restaurant. They recommended Mariscos Las Palmas on 120th St, which they go all the time. It specializes in seafood, but I saw some vegetarian options on their menu so I went. I ordered a veggie burrito, but when I started eating, I realized that I got fish, due to a misunderstanding. Anyway, I went vegetarian to reduce my carbon footprint and I don‚Äôt claim that God absolutely forbids eating meat, so I didn‚Äôt complain, especially that the fish burrito was really good.\n\n\n\nMariscos Las Palmas restaurant\n\n\n\n\n\nCrossing Compton Creek on 120th St\n\n\n\n\nSolo adventure of South Central\nThen I began to head back north on Central Ave, to check out some cool places I blew past last December in CicLAvia. While Central isn‚Äôt bike friendly, and true, it didn‚Äôt feel good to ride on, it didn‚Äôt feel too bad either. OK, it‚Äôs bad. Just look at how little space I had in the photo below.\n\n\n\nAlmost back at Imperial and then 114th St, where we already rode as a group\n\n\nI stopped by Chuco‚Äôs Justice Center at 76th St whose murals I greatly admire, one of which says ‚ÄúFight for your freedom‚Äù. This is an aspect of the vibrancy of poor neighborhoods of color that I like, which I greatly relate to. I also love the rebellious wild type graffiti font, which I find more elegant than aristocratic curly letters, as the former signals solidarity from below while the latter signals snobbery. I used to take regular walks in the rich suburban city San Marino right south of the Caltech campus (even Lincoln Heights feels more like a city; this is probably why ‚ÄúLA‚Äù usually does not strictly refer to LA City and I‚Äôll elaborate in another blog post). True, it‚Äôs pretty, but nothing is going on, no graffiti, backyard parties, music blaring audible from the street, yard sales, people working on bikes and cars, or kids giving out lemonade that I saw in poorer regions. Also, the security tech signs signaling invisible fences and some actual super elaborate fences guarding obscenely huge mansions made me feel unwelcome.\n\n\n\nChuco mural\n\n\n\n\n\nThe Fight for Your Freedom mural I was referring to, not a good photo but it has the necessary info\n\n\nAlong the way, I saw some more murals on Central.\n\n\n\nMural at northeast corner of Central and 76th Place, I think by the same artist as a mural on 1st St near Mariachi Plaza and at the La Canasta restaurant on Whittier Blvd\n\n\nThen I made a detour west on 54th St to see the murals at Dr.¬†Maya Angelou Community High School and another mural that I saw on the Mural Conservancy. Thank you, Mural Conservancy of LA (MCLA), for your great work! I looked at the MCLA website to find murals enroute, and this is one of them, the Wesley United Methodist Church mural at 52nd St and Main, Beacon of Hope. Unfortunately, when I got there, the lower half of the mural was whitewashed, probably because of graffiti. The full mural can be seen on the MCLA website; that‚Äôs a precious photo now as the mural is partially lost. Which is why I really should stop to take photos of murals that I like wherever I go, of course when it‚Äôs safe to stop, because of the precarious situation murals are in, so if I don‚Äôt take a photo now it might no longer be there in my next trip to this region.\nI just finished reading the Murales Rebeldes book, about Chicano murals in LA and Orange Counties, often with rebellious contents, being censored and erased. Most murals featured in the book are no longer extant. Now this mural joined the rank. According to the book, Chicano murals subvert the commodified notion of indivual authorship of art as the murals are often collectively painted by students and community members. Murals document history of local communities of color that may not be otherwise written, and boldly claims public space, not to glorify the powerful as often done by public art, but to inspire rebellion.\n\n\n\nBeacon of Hope, partially whitewashed\n\n\nThere‚Äôs a mural around 53rd St and Main:\n\n\n\nMural at northeast corner of 53rd St and Main\n\n\nThen I wonder, is it common for kids here to drop out of school? According to Mapping LA, only 3.4% of people in this neighborhood has a four year college degree, low in the county, and the largest group has less than high school education, high in the county. Is it because of the younger population here or higher rates of dropping out or both? Maybe both, because the data does show younger age, and this mural suggests that dropping out is a problem. If this is true, then the message of the Maya Angelou High School mural really brings me hope. I grew up in schools with messaging of patriotism and obedience, not universal love and justice. I wish that I get these murals in my high school.\nHaving been in school for so long ‚Äì mostly private school ‚Äì and still in school now, I have never thought about anywhere where dropping out is common. Then this is one of the strange new worlds with respect to myself, and I don‚Äôt have to travel far to get there. Ah, I often don‚Äôt look backwards. There‚Äôs another mural at this intersection that I found on February 18, so I won‚Äôt include that here.\nThen I headed to the Maya Angelou high school. There are actually numerous murals, but I focused on the most prominent one. Here‚Äôs a statement by the artist and a much better photo of the mural than mine. I arrived too late for the right sun angle so the mural was in the shade, but I just documented my trip as is. Nor did I have access to a higher viewpoint. From the photo on the artist statement, there used to be murals on the side of the building as well, which are now gone.\n\n\n\nMaya Angelou Rise Above mural\n\n\n\n\n\nZooming into the Maya Angelou quote\n\n\nThen I returned to Central and continued north, seeing more murals along the way. I stopped by Jesus Bike Shop at 49th St, and a mural at 42nd St.¬†That‚Äôs a very different kind of bike shop from Incycle which caters to MAMILs. Jesus Bike Shop is really cramped with cruiser and commuter style bikes and rims they use, while Incycle is very spacious and mostly sells high end racing bikes and clothing.\n\n\n\nJesus Bike Shop storefront\n\n\n\n\n\nMural on storefront; I vaguely remember that there were more murals flanking the store last December. If I remember right, then they have been destroyed and I terribly regret for stopping for a photo.\n\n\n\n\n\nInside the store\n\n\nAnother cool mural on 42nd St and Central, La Cultura Cura, which according to Google Translate, means culture heals. It shows the Black Panther, and struggle from the jail most likely signifying the high incarceration rate of Black men. It also depicts a Black hand holding a White hand. Is it in contest of strength, or in friendship to seek healing in the racial divide, or both?\n\n\n\nLa Cultura Cura mural\n\n\n\n\n\nI find the reflection on the car pretty cool. One of the reasons why cars suck is that they take up so much unnecessary space, space that could have been used for affordable housing and community farms, but this time I turned a bug into a feature.\n\n\nFurther north on Central, Cyberpunk DTLA drew close. Cyberpunk indeed, of the high-tech, low life. There‚Äôre the skyscrapers housing offices of powerful corporations and new luxury hotels and apartments. Yet I have seen people sleeping on the streets right beneath the skyscrapers. Skid Row is within walking distance away. This part of Central isn‚Äôt that far, so the skyscrapers loom above this sketchy neighborhood, like in the Neo-Tokyo song.\n\nThe Neo-Tokyo song says ‚Äúdreams of a life inside while we escape just to survive‚Äù. Though to be honest, I don‚Äôt even want to be inside, I mean the institutions signified by the lofty places in the skyscrapers, because I don‚Äôt want to become the monster we despise so much and sought to destroy. Our goal is to eliminate the monster, not to become it. Architecture and urban planning are informed by ideology. According to the book Lifted: A Cultural History of the Elevator, the skyscraper is informed by hierarchy, so the physically higher places are higher in hierarchy, opposite to the hierarchical vertical structures prior to the advent of elevators. Burning question: what to do with the existing skyscrapers, and for that matter, freeways, built with hierarchy and segregation in mind, when we achieve an egalitarian and classless society with direct democracy in harmony with nature?\n\n\nEastside\nI took the new 6th St bridge to go to Boyle Heights, to check out the Otomisan Restaurant, a legacy Japanese restaurant, which signifies layers of history of the diverse Boyle Heights, where ethnic minorities who couldn‚Äôt live elsewhere lived, though it‚Äôs now mostly Latino. The layers of history I see in geographical space makes me wonder, in histological space, if RNA velocity uses unspliced mRNAs to give a glimpse into the future, then what can we use to get a glimpse into the past? There‚Äôs lineage tracing, but would something endogenous to the cell tell something about its past?\n\n\n\nOtomisan Restaurant, unfortunately it was closed when I got there.\n\n\nI have been to Eastside many times. To boldly go somewhere I have never gone before: East LA College (ELAC). Because of the continuity in vibe, often I have no idea when I cross neighborhood and city boundaries. I always thought that ELAC is in in unincorporated region of East LA, but it turns out that it‚Äôs actually in Monterey Park.\n\n\n\nELAC\n\n\nThe reason why I visited is again Murales Rebeldes, which features a great mural by Roberto Chavez, The Path to Knowledge and the False University, that adorned the facade of the Rosco C. Ingalls Auditorium from 1974 to 1979 when it was whitewashed, disapproved by the administration, as the mural blended in cubist and surrealist styles, not always using typical Chicano styles and icons, and not imposing a single interpretation. Another mural depicting an uncontroversial history of Chicano murals is in the lobby of the auditorium, which I got a glimpse of.\n\n\n\nThe Rosco Auditorium where the mural still sits behind white paint\n\n\n\n\n\nThe mural inside the lobby, with style more typical of Chicano murals; I couldn‚Äôt get inside so this is the best I did to take a peek.\n\n\n\n\n\nSculpture at ELAC\n\n\n\n\nMonterey Park\nThen I climbed the Monterey Park hills back to the San Gabriel Valley (SGV). Geography shapes the demography and culture, as the hills (here) and rivers pose transportation challenges. The vibe changes very rapidly as the hill began, from Chicano to Chinese. Somewhat discrete spatial regions are real. Meanwhile, other spatial features, such as weather, change more continuously. To delineate spatial regions, it‚Äôs really important to clarify the question asked to find these regions, and which features or variables are relevant and which are not. You see why my favorite weather is when the sky is clearing up but still partially cloudy after rain. When descending north, into the SGV, I got a great view, which was enhanced by the clouds.\n\n\n\nLooking north from Huntington Ave, a little south of Barnes Memorial Park, Monterey Park\n\n\nThe LA County Public Works building in Alhambra is a fine Corporate Modernist landmark from 1971, more info here.\n\n\n\nLooking northwest from that same hill. That teal glass cube is now the LA County Public Works building in Alhambra.\n\n\nOn January 21, I dressed in all black for the Streets Are For Everyone die in, and passed through Monterey Park on the way back. I was already home by 10 pm, and then there was the mass shooting at Star Dance. It was Chinese New Year‚Äôs Eve. Did I bring bad luck to the neighborhood because I should really dress in red while black is associated with death and is unlucky for this occasion? Maybe not. I don‚Äôt really believe in luck, so any reference to it is figurative. I stopped by Star Dance on Garfield and Garvey. The site was still full of flowers, with a table with incense, in the Buddhist tradition. There were cards and pens to write notes. I wrote in Arabic and English, ‚Äúwe are of God and to Him we return.‚Äù I have good intentions, though in the back of my mind I wonder if some Islamophobe would misinterpret it. I also wonder if my act of taking photos would get misinterpreted, as photography is often not allowed in mausoleums. But if I make beautiful and artistic photos, then why not? Because it‚Äôs beautiful, I don‚Äôt find it disrespectful.\n\n\n\nStar Dance, full of flowers\n\n\n\n\n\nTable with incense to bless the dead\n\n\n\n\nAlhambra\nI have been to Alhambra many times, yet somehow I had never been to the Civic Center and the heart of Downtown. I passed by the City Hall. The other dance studio, Lai Lai, where the shooter was disarmed by witnesses, was across the street from the City Hall. Many city halls have cool architecture (LA City, Pasadena, Downey, Compton, Glendale, Inglewood, and etc.), but I wasn‚Äôt impressed by the one in Alhambra (or the one in San Marino, Montebello, Covina, Claremont, and etc.). In terms of architecture (not governance), my favorite city hall thus far is the one of Pasadena. But I like downtown Alhambra, again, the intimate artisan vibe with lively modern businesses occupying historical buildings, those with up to 3 stories and Spanish revival, Art Deco, and vernacular styles so characteristic of LA (looks like mostly vernacular in this photo).\n\n\n\nQuick red light shot. OK, I got a better one when a pedestrian walking, but because autofocus doesn‚Äôt work that well in lower light, it‚Äôs out of focus. Downtown Alhambra, 1st St and Main St\n\n\nLast time I passed by a Mari Naomi Stop Anti-Asian Hate mural on Alhambra Rd around Electric Ave. This time I made sure to stop for a better look. It‚Äôs the same content as the one at Garvey Park, Rosemead, but smaller and rearranged.\n\n\n\nMari Naomi mural in Alhambra\n\n\nBecause I stopped for photos quite often, dusk was drawing near, and the clouds were glowing in the golden hour. I went on a concrete barrier separating out the right lane at Huntington Dr and Garfield Ave. I think one of the advantages of biking or walking is that it‚Äôs easy to stop for photos because we don‚Äôt take up much space when stopped. Also, being open in the air and traveling slower make us observe our surroundings better.\n\n\n\nLooking east, towards the mountains, at Huntington Dr and Camden Ave\n\n\n\n\n\nLooking west, at the palm tree silhouettes, note the airplane\n\n\n\n\n\nSome 1970s brutalist building\n\n\n\n\nBack to Pasadena\nLast place where I have never gone before: a part of Raymond Hill, where the Raymond Hotel used to be, which gave this hill and the road the name. The hotel caught fire from ember in 1895 and was rebuilt. Later it was eclipsed by the Huntington Hotel and the Great Depression spelled its doom. Historical photos of the first and second Raymond Hotel can be seen here. An apartment building on the hill bears a mural depicting the second Raymond Hotel.\n\n\n\nRaymon Hotel mural on Raymond Hill\n\n\n\n\n\nView from Raymond Hill, looking south. Again, see the LA County Public Works building in Alhambra\n\n\nAs the sun was setting, my trip was coming to a close. And thank you, Wayne Thom! I took inspiration from his CNA Tower photo with the building reflecting the cloud while the background is clear. Now the Art Center building on Raymond Ave was reflecting some clouds and the twilight.\n\n\n\nArt Center at Raymond and Glenarms\n\n\n\n\nEpilogue\nFinally, is it true that ‚Äúhate has caused a lot of problems in the world, but has not solved one yet‚Äù? I haven‚Äôt read this sentence in its original context, so here‚Äôs just my speculation. I suppose, yes and no. Yes, because in our culture, what we call ‚Äúhate‚Äù often has a power dynamic, of a dominant group oppressing a less dominant one, and is often associated with discrimination based on certain characteristics. Oppression, inherently unjust, only causes problems and doesn‚Äôt solve any. At a smaller scale, hate also often originates from egotistical envy and arrogance. No, because how about hating injustice and the system and institutions that perpetuate injustice? Certain things are justifiably hated, but nor is it pure hate, because we hate injustice because we love justice. In contrast, the kind of sinful hate may seem to be motivated by some kind of love, such as nationalism and tribalism, but that‚Äôs neither true love nor love of truth, but parochial and egotistical envy."
  },
  {
    "objectID": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html",
    "href": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html",
    "title": "Where the big jet engines roar",
    "section": "",
    "text": "paste(\"South\", c(\"Central\", \"Bay\"))\n\n[1] \"South Central\" \"South Bay\"\nCaptain‚Äôs Log, stardate 100732.45, or Earth date February 18, 2023.\nDid you know that LAX has an official song? And there are two versions of lyrics. Cool and ethical are different concepts. I find many things cool but unethical, such as pretty much everything aerospace designed by and for the military industrial complex. Also, while I can‚Äôt help but find jetliners cool and I enjoy flying, especially the thrill of acceleration when taking off and the view from above, I try not to fly because it‚Äôs bad for the environment. So LA International Airport, where the big jet engines roar, says the first version of the LAX song. Cool, I like that song. But meanwhile, the roar of your engines belongs to the trash can of history.\nThere‚Äôs no tl;dr, because there‚Äôs a lot to see over 90 miles."
  },
  {
    "objectID": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#sofi-stadium",
    "href": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#sofi-stadium",
    "title": "Where the big jet engines roar",
    "section": "SoFi Stadium",
    "text": "SoFi Stadium\nI have mixed feelings about the SoFi Stadium. On the one hand, it has caused gentrification. On the other hand, when I visited, I found it a great feat of engineering and a nice park where many people and birds enjoy.\n\n\n\nTouchdown. What an apposite road name! Though as a nerd, I don‚Äôt care about football whatsoever. I don‚Äôt even care that much about competitive cycling. Again, LAX.\n\n\nLove. Really? I don‚Äôt think gentrification is an expression of love. Yesterday, I listened to this online interview on love in the Islamic tradition. In short, in the pre-colonial era, love was central to Islam and what we now call Sufism was mainstream Islam. That Islam is an arid legalistic orthopraxy is a colonial construct, and our colonial overlords want Wahhabism, which fits that description, to become orthodox, so as a result, many Muslims today say Sufism is haram. Colonialism, White Man‚Äôs Duty, claims to spread love, liberty, and justice, but does anything but. The hypocrisy led many people today to lose faith in those ideals. So in Khaled About El Fadl‚Äôs law school class at UCLA, 99% of students these days no longer believe that justice is possible. I feel like this sign saying ‚Äúlove‚Äù looks like commodifying and hence making a mockery of love. I mean by commodify when we pretend that love is represented by items that can be bought and sold. Otherwise don‚Äôt displace the poor. In late capitalism, what isn‚Äôt a commodity?\n\n\n\nFirst glimpse of the lake\n\n\nYet I somehow found this place cool. It‚Äôs designed to look beautiful. A central theme of this trip is cool but unethical.\n\n\nThe parking lots are larger than the stadium itself. Again, cars suck because they take up so much unnecessary space, to the point of driving up rent. Imagine how many people such space can house and how much food we can grow once we abolish car culture. Across a parking lot is the Kia Forum, whose building I find cool.\n\n\n\nKia Forum"
  },
  {
    "objectID": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#downtown-flea-market",
    "href": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#downtown-flea-market",
    "title": "Where the big jet engines roar",
    "section": "Downtown flea market",
    "text": "Downtown flea market\nIt was already past 1 pm. I wasn‚Äôt hungry yet, but I was running late. Next up: Downtown Inglewood. Initially I planned to ride on Locust St, but decided to check out Market St instead when I saw the flea market, to experience the city and interact with locals. I had to walk there, pulling down my average speed for the trip.\n\n\n\nInglewood flea market\n\n\nI heard about Malik Books, an independent Black bookstore in the Baldwin Hills Crenshaw Plaza. It brought its mobile bookstore here.\n\n\n\nMalik Books\n\n\nI stumbled upon the MLK day celebration. The Mayor and some council members were speaking.\n\nAero Collective. As a cyclist, even if I‚Äôm not a racer, ‚Äúaero‚Äù catches my attention. Turns out that it‚Äôs for architects.\n\nThere‚Äôre some interesting historical buildings here, from Spanish revival to 1970s brutalist. Inglewood has many great 1970s architecture.\n\n\n\nInteresting building\n\n\n\n\n\nInteresting ad mural\n\n\n\n\n\nIt turns out that that cool building is a garage. Look at the obscene amount of space dedicated to parking.\n\n\nAnother abandoned historical theatre! This is the Fox Theatre, closed since the 1980s. See historical photos here.\n\n\n\nThe historical Fox Theatre\n\n\n\n\n\nNow boarded up. I wonder how they got inside to take photos in 2014.\n\n\nOne of the coolest things in this trip: these lowrider bikes are definitely works of art! Here‚Äôs the Instagram of the those who built the bikes. I was wondering if the bikes were ridable. They are. One of the makers said he rode the bike all the way from Vermont, presumably Manchester and Vermont. Both bikes have speakers behind.\n\n\n\nLowrider bikes\n\n\nIt was 2 pm, and I was hungry. I saw someone juggling a Soul Food sign and decided to eat at that restaurant. There was a line, but I didn‚Äôt want takeout because I wanted to avoid single use plastics. So I waited, which got me behind schedule. I got red beans, black eyed peas, rice, cabbage, which came with complementary cornbread. I tried to get whole foods. It was well seasoned and good value by Pasadena standards.\n\n\n\n\nVoyager leaning on the wall in the restaurant"
  },
  {
    "objectID": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#civic-center",
    "href": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#civic-center",
    "title": "Where the big jet engines roar",
    "section": "Civic Center",
    "text": "Civic Center\nI already got a glimpse of the 1970s style Inglewood City Hall from Market Street. Not all city halls in LA County have great architecture, but the Inglewood one is among the great ones, again, in terms of architecture, as I don‚Äôt know much about their local politics. Again, I wonder, why do so many cities have 1970s style city halls?\n\n\n\nNew Opportunities Charter, City Hall, and Kaiser Permanente seen from Market St\n\n\n\n\n\nNew Opportunities Charter\n\n\n\n\n\nKaiser Permanente\n\n\n\n\n\nCity Hall and LA County Superior Court\n\n\nWhat‚Äôs to the right of the handrails? It‚Äôs a sculpture called Skedans.\n\nLooking down, with my shadow\n\nI then returned to Manchester Ave. The part around Civic Center didn‚Äôt feel as terrifying. I checked out the Public Library and the adjacent Health Center 1970s building.\n\n\n\nOne Manchester\n\n\n\n\n\nInglewood Public Library\n\n\n\n\n\nThe Health Center\n\n\nMore murals! Inglewood High School across Manchester sports a mural, showing a Native American‚Äôs face, and the Civic Center and traditional sandstone buildings, signaling change. The palm trees have grown taller since the photo was taken for the webpage about the mural linked here.\n\n\n\nInglewood High School mural\n\n\n\n\n\nThe Moderne high school building\n\n\nThere‚Äôs another long mural in the Grevillea Park across Manchester, History of Transportation, from horses and oxens to 1940s airplanes.\n\n\n\nHistory of Transportation"
  },
  {
    "objectID": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#randys-donuts",
    "href": "posts/2023-02-21-where-the-big-jet-engines-roar/index.html#randys-donuts",
    "title": "Where the big jet engines roar",
    "section": "Randy‚Äôs Donuts",
    "text": "Randy‚Äôs Donuts\nActually, I originally planed this trip to see the FAA building in Hawthorne, but kept on delaying the trip because of weather and other trips. The first version of the route didn‚Äôt go to downtown Inglewood. I changed my mind when our new lab manager brought two boxes of Randy‚Äôs donuts to lab meeting and I really liked them. I found that the original Randy‚Äôs Donuts is in Inglewood, sort of en route to Hawtorne, so I added this detour and a few more miles.\n\n\n\nRandy‚Äôs Donuts Programmatic building\n\n\nBefore heading to LAX, I saw another cool Googie car wash. I could see the snowy peak of Mt San Antonio in the distance.\n\n\n\nThe car wash, and looking back at the donut\n\n\nHowever much I hate car culture, I admire the beautiful monuments it has inspired, including these Googie car washes, the 1929 Bullock building on Wilshire whose main entrance faces the parking lot rather than Wilshire, and the Baldwin Hills Crenshaw Plaza that kicked off suburban shopping centers. Meanwhile, as I know that there are vibrant bike cultures, what are the monuments for bike cultures that deserve to be called art? In LA, it would be the new Taylor Yard Bridge, North Atwater Bridge, Spoke Bicycle Cafe, Rivers of the World mural, and Bicycle Kitchen‚Äôs artwork. Not historical. Yet. I‚Äôm sure that there are great historical monuments for bike cultures in the Netherlands, as 1970s buildings do count as historical these days. Time flies!"
  },
  {
    "objectID": "posts/2023-02-14-watercolor-sky/index.html",
    "href": "posts/2023-02-14-watercolor-sky/index.html",
    "title": "Watercolor sky",
    "section": "",
    "text": "In v1, I wrote often lengthy descriptions of the voyage and thoughts from the voyage in the Strava description field of each activity, which I call Captain‚Äôs Log. I‚Äôll explain my quirky terminology in another blog post. I also put photos there. However, I can‚Äôt run R code there, and adding references is more difficult, since Strava‚Äôs description isn‚Äôt really meant for my kind of Aspie overthinking about the activities. I had a blog before, made with blogdown, but I haven‚Äôt touched it for over 3 years, in part because I don‚Äôt have the web development expertise to deal with the 3rd party theme and over time I got more and more security alerts from GitHub urging me to update the dependencies, and I got some breaking changes. Eventually I decided to revive my blog here with Quarto, because from my experiences with pkgdown R package documentation websites based on bootswatch themes, I find the bootswatch themes much easier to deal with without web development experiences. Furthermore, my Captain‚Äôs Logs are often the length of blog posts, so I already have a de facto blog on Strava. So here we go, this is my Captain‚Äôs Log for today‚Äôs voyage:\n\n\n\n\nI didn‚Äôt bring my real camera, because initially I intended to do C++ style to save some time. However, I couldn‚Äôt resist my inner useR; I couldn‚Äôt help but stopped for photos. Why waste the opportunity when it‚Äôs so beautiful out there? So I took some photos with my phone. Anyway, with to many stop signs and turns, because I want to (not so) boldly go into the nooks and crannies I have never gone before, it‚Äôs impossible to ride hard and fast all the time C++ style. Why not soak in the scenery?\nFirst new addition to my Hall of Fame: W Montecito Ave, between Michilinda Ave to the west and Lima St to the east, in Sierra Madre. I enjoyed the solitude and the flower scent, presumably from those little white flowers. I really can‚Äôt decide what my favorite region of LA is, because they are so different. While I like this quiet and posh area, it doesn‚Äôt have the edge of Boyle Heights.\n\n\n\nW Montecito Ave, Sierra Madre\n\n\nNext I rode through the periphery of downtown Sierra Madre, then to the heart of Monrovia on Myrtle Ave, climbing all the way to the top, through the posh and seemingly quite new neighborhood called Gold Hills. That‚Äôs a wall, much of which is over 17%. I was gasping for air. In the last 13% steep part, after the worse 17% wall, I got a strong headwind coming from above, making the climb more challenging. Indeed with hardship comes ease! There isn‚Äôt really a spectacular view near the top. The cool part is just recognizing familiar places from afar, such as the Santa Fe Dam to the east, and Monrovia High School, which I just passed, to the southeast. I didn‚Äôt stop at the top but immediately descended.\nWhich brought me to the next new addition to my Hall of Fame, as if one turn led me into another world, which is why I‚Äôm fascinated with negative spatial autocorrelation: N Hidden Valley Rd, for its quiet greenery of wilderness.\n\n\n\nN Alta Vista Rd, Monrovia\n\n\nLook at the clouds! That‚Äôs what I mean when I say ‚Äúwatercolor sky‚Äù. The white tower in the mid lower left of the photo below should be Monrovia High School. The steep switchback descent soon after this spot isn‚Äôt easy. I would like to climb this part in a another trip. It‚Äôs steep and hence challenging, but I get to spend more time in this awesome view.\n\n\n\nA little down N Alta Vista Ave Rd\n\n\nThe wind was getting stronger. Fortunately I didn‚Äôt pump up the tires, as the part of Huntington Dr in the heart of Arcadia was wet. It must have rained earlier when I was indoors, and I felt a few drops of rain during this ride.\nIt‚Äôs been a while since I last visited the LA County Arboretum area. The last trip was in September 2021, before my first group ride with the Women on Wheels (WoW) group of the Pasadena Athletic Association (PAA). I just bought Voyager early September, 2021. I rode my commuter bike, Enterprise, to the Arboretum, to visit the Santa Anita Park and the Arboretum. That area is not bike friendly. I don‚Äôt really dare to ride on that part of Baldwin Ave, and there was no bike rack, so I had to lock up Enterprise on a sign, which is not best practice since it‚Äôs easier to break the thin perforated metal pole of the sign than a real bike rack, as the pole is meant to break when hit by a car. I had to walk quite a bit into the Santa Anita Park, by the shopping mall and vast parking lots, as I read on the park‚Äôs website that bikes weren‚Äôt allowed inside. But I had a nice trip, since that was my first time watching racing horses galloping and I love the Art Deco building of the facility. That said, there have been animal cruelty scandals in horse racing.\nI coined the term ‚Äúcyborg jockey‚Äù to refer to cyclists, because of the Victorian ‚Äúmechanical horse‚Äù expression to refer to a bike, and because I wondered if the best racing horse raced the best human time trialist, who would win? The answer is the human cyborg jockey. The Guiness World Record of horse speed, over 402 meters, is 43.97 mph. The human powered speed record on a flat course without drafting, over 200 meters, is 89.59 mph, achieved in a fully faired recumbent bike. While the human speed record is over a shorter distance, I‚Äôm sure that the rider must have been much faster than 50 mph soon before and after the 200 m flying start time trial, so I think the human wins. I went there the morning before that group ride because I‚Äôm a night owl and I‚Äôm not used to getting up so early for the group ride, so I would spend more time in the sunshine to hack my circadian rhythm.\nAnyway, enough of 2021 digression about this location. I rode on Hugo Reid Dr south of the Arboretum. Again, many peacocks. They were introduced by Elias ‚ÄúLucky‚Äù Baldwin in the 1880s, founder of City of Arcadia, from India, and have remained since. Sometimes I even see them in Pasadena and San Marino. And why Hugo Reid Dr? Because long before Arcadia was incorporated in 1903, and when California was part of Mexico, Hugo Reid was awarded Rancho Santa Anita in 1841. Hugo Reid married Tongva widow Victoria Reid, and wrote about the Tongva in his letters to Los Angeles Star, which to this day are precious resources on pre-colonial Tongva.\n\n\n\nOn Hugo Reid Dr, Arcadia, with peacocks on the lawn\n\n\nThen back to Pasadena. According to my Strava personal heatmap, southeast Pasadena and unincorporated East Pasadena are underexplored, so I went there on purpose.\n\n\n\nRose Villa St and Allen Ave, Pasadena\n\n\nThe watercolor cloud was southeast of Pasadena, behind the palm trees in the photo below. I looked back at it from Pasadena Community College (PCC).\n\n\n\nPCC parking lot on Hill Ave\n\n\nIn the earlier photo from the Monrovia foothill, the clouds were above the mountains. The strong wind from the north blew the clouds away from the mountains.\n\n\n\nMountains now clear, from PCC\n\n\nIf I learnt anything from English classes, it is ‚Äúshow, don‚Äôt tell‚Äù. Now behold the wind blowing the palm trees, as I was riding on Cordova to the west. I felt like flying an airplane in turbulence, but Voyager doesn‚Äôt have seat belts.\n\n\n\nCordova, almost to Lake Ave\n\n\nThat‚Äôs it for the trip. I‚Äôll continue writing the R package Voyager."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "These R the Voyages",
    "section": "",
    "text": "ActiveSGV Puente Hill ride and hike\n\n\n\n\n\n\n\ncycling\n\n\n\n\n\n\n\n\n\n\n\nMay 12, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nVoyager 1.2.0\n\n\n\n\n\n\n\nR\n\n\nspatial-omics\n\n\n\n\n\n\n\n\n\n\n\nApr 26, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nA faster implementation of MULTISPATI PCA\n\n\n\n\n\n\n\nR\n\n\nspatial-omics\n\n\n\n\n\n\n\n\n\n\n\nMar 25, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n  \n\n\n\n\nSpatially informed PCA\n\n\n\n\n\n\n\nR\n\n\nspatial-omics\n\n\n\n\n\n\n\n\n\n\n\nMar 17, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDo Seurat and Scanpy give consistent PCA results?\n\n\n\n\n\n\n\nR\n\n\nspatial-omics\n\n\n\n\n\n\n\n\n\n\n\nMar 5, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n  \n\n\n\n\nPalm trees, snowy peaks, and Sepulveda mud\n\n\n\n\n\n\n\ncycling\n\n\n\n\n\n\n\n\n\n\n\nFeb 26, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n  \n\n\n\n\nWhere the big jet engines roar\n\n\n\n\n\n\n\ncycling\n\n\n\n\n\n\n\n\n\n\n\nFeb 21, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n  \n\n\n\n\nEast Side Riders\n\n\n\n\n\n\n\ncycling\n\n\n\n\n\n\n\n\n\n\n\nFeb 20, 2023\n\n\nLambda Moses\n\n\n\n\n\n\n  \n\n\n\n\nWatercolor sky\n\n\n\n\n\n\n\ncycling\n\n\n\n\n\n\n\n\n\n\n\nFeb 14, 2023\n\n\nLambda Moses\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "Lambda Moses",
    "section": "",
    "text": "Space, the current frontier, where ‚Äúspace‚Äù means geospatial as often assumed in spatial statistics. These are the voyages of the starship Voyager. Its ongoing mission, to explore strange new worlds, to seek out new views and new neighborhoods, to boldly go where Lambda has never gone before.\nMy name is Lambda, she/her. I live in Hahamongna, Tongva/Kizh/Gabrieleno territory, or in Anglo terms, Pasadena, Los Angeles (LA) County. One of my favorite aspects of LA is that there are many crazy people, crazy in cool ways. Hopefully I‚Äôm one of them. I‚Äôm a left-wing heterodox Muslim convert Aspie cultural rebel zero waster living in LA without a car for over 9 years.\nThis blog is about Voyager. On the one hand, data analyses related to the R package Voyager, bringing decades of glorious tradition of spatial data analysis to the relatively new field of spatial -omics. On the other hand, the starship Voyager, which is my human powered ship that made me learn about the different cultures and landscapes of LA. Starship Voyager also made me think about spatial statistics and inspired many ideas in the R package Voyager project. This is the personal side of the ‚Äúfrom geospatial to spatial -omics‚Äù on R package Voyager‚Äôs documentation website.\n\n\nCalifornia Institute of Technology | Pasadena, CA | PhD in Biology | Sept 2017 - present\nUniversity of California, Los Angeles | Los Angeles, CA | B.S. in Molecular, Cell, and Developmental Biology, and Computation and Systems Biology, summa cum laude | Sept 2013 - June 2017\nORCID\n\n\n\nVoyager | From geospatial to spatial -omics based on SFE\nSpatialFeatureExperiment (SFE) | S4 class using Simple Features to represent geometries for spatial -omics data based on SpatialExperiment and SingleCellExperiment\nSFEData | Example datasets for Voyager and SFE\nspatialDE | R wrapper of SpatialDE\nBUSpaRse | R utilities for kallisto bustools from their early days; kept for historical reasons, use the newest version of kallisto and bustools instead of this package.\n\n\n\nMuseum of spatial transcriptomics. Moses L, Pachter L. Nature Methods. 2022 May;19(5):534-546. doi: 10.1038/s41592-022-01409-2. Epub 2022 Mar 10. Erratum in: Nature Methods. 2022 Apr 19;: PMID: 35273392.\nModular, efficient and constant-memory single-cell RNA-seq preprocessing. Melsted P, Booeshaghi AS, Liu L, Gao F, Moses L, Min KHJ, da Veiga Beltrame E, Hj√∂rleifsson KE, Gehring J, Pachter L. Nature Biotechnology. 2021 Jul;39(7):813-818. doi: 10.1038/s41587-021-00870-2. Epub 2021 Apr 1. PMID: 33795888.\n\n\n\n2023 | Invited talk: From geospatial to spatial -omics with SpatialFeatureExperiment and Voyager, Advanced Biomedical Computation series, Brigham & Women‚Äôs Hospital, Harvard Medical School\n2022 | Package demo: SpatialFeatureExperiment: An S4 Class Bringing Geospatial Tools To Spatial Omics, Bioconductor Conference (video)\n2020 | Short talk: Museum of Spatial Transcriptomics, Bioconductor Conference (video)"
  },
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#loadings",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#loadings",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "Loadings",
    "text": "Loadings\nNext we compare gene loadings.\n\nVizDimLoadings(seu, dims = 1:2, nfeatures = 20, balanced = TRUE)\n\n\n\n\n\nsc.pl.pca_loadings(adata, components = \"1,2\", n_points = 20)\n\n\n\n\nThe plots are too visually different to compare visually. Here we compare the gene loadings numerically:\n\npca_loadings <- Loadings(seu, reduction = \"pca\")\n# Make sure the gene orders match\ngene_ind <- match(rownames(pca_loadings), rownames(seu))\npca_loadings_py <- py$adata$varm[\"PCs\"][gene_ind,]\npca_loadings <- unname(pca_loadings)\n\n\nplot_r_py_pc_diffs(pca_loadings, pca_loadings_py, \n                   title = \"Differences in loadings, Seurat vs. Scanpy\")\n\n\n\n\nAgain, the differences are orders of magnitude greater than epsilon, rising from about 2e-4 at PC1 to over 0.01 after PC9."
  },
  {
    "objectID": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#embeddings-1",
    "href": "posts/2023-03-05-seurat-vs-scanpy-pca/index.html#embeddings-1",
    "title": "Do Seurat and Scanpy give consistent PCA results?",
    "section": "Embeddings",
    "text": "Embeddings\nNext we compare the spot projections in PCA space, with the second Seurat object without clipping.\n\npca_embeddings2 <- Embeddings(seu2, reduction = \"pca\")\n\n\nplot_pca_compare(pca_embeddings2, pca_embeddings_py,\n                 title = \"PCA embeddings, Seurat vs. Scanpy, no clipping\")\n\n\n\n\nHere the segments connecting corresponding spots from Seurat and Scanpy are all invisible, indicating that the embeddings are very similar in the first 2 PCs. Also see PC3 and PC4:\n\nplot_pca_compare(pca_embeddings2, pca_embeddings_py, pcs = 3:4,\n                 title = \"PCA embeddings, Seurat vs. Scanpy, no clipping\")\n\n\n\n\nThe segments are still invisible in PCs 3-4, indicate high similarity. Now we compare the embeddings of all 20 PCs computed numerically:\n\nplot_r_py_pc_diffs(pca_embeddings2, pca_embeddings_py, \n                   title = \"Differences in embeddings, Seurat vs. Scanpy, no clipping\")\n\n\n\n\nAccounting for the flips, the differences are generally small, but get larger for the PCs that explain less variance, rising from around 5e-6 at PC1 to less than 1e03 at PC20. The dashed line is sqrt(.Machine$double.eps), around 1.5e-8, so while the magnitude of the difference may not seem great, it‚Äôs greater than can be accounted for by machine precision although much smaller than when the Seurat scaled data is clipped. Seurat uses implicitly restarted Lanczos bidiagonalization algorithm (IRLBA) for PCA, which performs approximate singular value decomposition (SVD) and is much faster and memory efficient than base R prcomp(), while Scanpy by default uses ARPACK, which also uses the implicitly restarted Lanczos method for symmetric matrices. That this method computes approximate SVD might be responsible for the discrepancy."
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "",
    "text": "Captain‚Äôs Log, stardate 100753.94, Earth date February 26, 2023, though it took me weeks to finish writing it.\nLA got a blizzard warning, the first time since 1989, as the cold storm came on Thursday, February 23. I was in my office and saw hail bouncing off the metal strip beneath the window. Friday saw an entire day of heavy rain, hence grouding starship Voyager. The rain became lighter on Saturday, but still lasted until the night. The rain forced me to rest and recover. In other words, get more work done. Internet feels like oxygen these days. The storm on Friday night caused a wifi outage. Not wanting to ride in the rain, I stayed at home on Saturday. What to do without wifi? Life continued. I read papers I had already downloaded and wrote some code. My impulse to check Mastodon and search random stuff was foregrounded and checked ‚Äì I lived without it totally fine. I could better focus. Today, the rain stopped and the sun came out, though the forecast says that the rain will resume next Monday to Wednesday. As if God bless CicLAvia, in the Valley, from Reseda to Canoga Park.\nI mean, the other valley:\nThe San Fernando Valley (SFV), which had its own mission and a distinctive dialect of the Tataviam people, mutually intelligible with the Tongva language elsewhere in LA. It was the mission that gave rise to a unified Tongva/Gabrieleno identity, as many modern members trace their lineages from the San Gabriel Mission. The SFV had the Mission San Fernando Rey de Espa√±a. I wonder whether SFV‚Äôs mission led to a distinctive Tataviam identity today, as I‚Äôm pretty sure that Tongva people from so called SGV and those from so called South Bay spoke somewhat different dialects.\nThough apparently not everyone agrees that Pasadena is in the San Gabriel Valley (SGV), probably because the Raymond Dyke fault separates Pasadena (actually also Sierra Madre and Aradia north of Huntington Dr) from the rest of the SGV, forming the hills in San Marino and between Pasadena and South Pasadena. Mapping LA considers Pasadena part of the Verdugos rather than SGV. Since ‚ÄúSFV‚Äù is reminiscent of the acronym of my R package SpatialFeatureExperiment (SFE), I thought about giving this blog the name SpatialGenomicValley (SGV), but the current name was more popular among those I asked."
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#from-pasadena-to-burbank",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#from-pasadena-to-burbank",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "From Pasadena to Burbank",
    "text": "From Pasadena to Burbank\nIt‚Äôs certainly not my first time seeing snow on the southern slope of Mt Wilson, but this time the amount of snow made it almost look like the Alps.\n\n\n\nMt Wilson with unusual amount of snow, from Los Robles and Corson in Pasadena\n\n\nI was trying to make it to the Friends of CicLAvia lunch starting at 11:30 am in Reseda. Nevertheless, I couldn‚Äôt help but stopped for photos of some cool buildings and the snowy peaks along the way. I was sure that nobody shows up on time anyway.\n\n\n\nGlendale skyline seen from the Geneva bridge crossing Verdugo Wash\n\n\n\n\n\nGlendale Holy Trinity Armenian Church with Art Deco motifs\n\n\nAs I rode through Glendale and Burbank, I saw the Verdugo mountains in snow, the first time in my life. I also encountered a MAMIL riding a gravel bike, and couldn‚Äôt help but race him. I passed him initially but he passed me when I stopped for photos. Anyway, eventually I won, before I made a left on Magnolia in Burbank.\n\n\n\nVerdugo mountain snow, from Glenoaks and Western in Burbank"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#north-hollywood",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#north-hollywood",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "North Hollywood",
    "text": "North Hollywood\nI descended Magnolia through the heart of Burbank, before getting to the Chandler bike path in Burbank and North Hollywood Arts District where there are some cool murals. See some of the murals from previous trips on PixelFed.\n\n\n\nChandler bike path mural\n\n\nThe Little Tujunga mountains also got snowy peaks, which can be seen from the North Hollywood Metro station and Tujunga Wash, while they‚Äôre normally not tall enough to get snow.\n\n\n\nNorth Hollywood Station, note the snowy peaks in the distance\n\n\n\n\n\nTujunga Wash, see snowy peaks in the distance\n\n\nWhile the Pacific Electric is long gone, many of its relics are preserved, such as the Lankershim depot near modern North Hollywood Station. If they could build great transit over 100 years ago, then why can‚Äôt they do it now?\n\n\n\nLankershim depot near North Hollywood Station"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#orange-line-bike-path",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#orange-line-bike-path",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Orange Line bike path",
    "text": "Orange Line bike path\nIn my original plan, I wanted to ride on as much of bike paths along tributaries of LA River as possible, including on the Tujunga Wash, with the Great Wall of LA mural, which I visited last January. Considering that I certainly couldn‚Äôt make it to Reseda by 11:30 am, I skipped most of that part, only taking a glimpse of the mural. I saw a great photo of the mural reflected in the water below at the LA Public Library and wanted to reproduce it, with the soft morning light. However, that didn‚Äôt work because the water was flowing too fast and with too many wavelets to form a visible reflection of the mural. There‚Äôs an airplane in that photo, heading east, probably to the Bob Hope airport in Burbank. I have been to upstream parts of Tujunga Wash, including Hansen Dam, Big Tujunga Creek, Little Tujunga Creek, and Pacoima Wash in previous voyages. These voyages weave together like a fabric, weaving together my experience and love of LA.\n\n\n\nGreat Wall of LA\n\n\nThen 6 miles of Orange Line bike path. On the bike path, I encountered several others which I speculated to be heading to CicLAvia. Likewise, they wondered if I was also heading to CicLAvia. One part of the Orange Line bike path was flooded. We all confirmed that we were heading to CicLAvia on our way out of the Sepulveda Basin, about to leave the Orange Line bike path. I had to ride on the road, on White Oak Ave and Sherman Way, before getting to CicLAvia. Fortunately there was a bike lane. As I arrived on Sherman Way but before getting to CicLAvia, I saw more cyclists, presumably also heading the same way.\n\n\n\nOrange Line bike path\n\n\n\n\n\nPart of the bike path was flooded, at Sepulveda Basin\n\n\n\n\n\nFallen tree on the bike path\n\n\nThis region is most likely the Siutcanga village of the Tataviam. According to the O My Ancestors book, back in the 1980s, developers around here found an Indigenous burial ground, and the then new lawyer Michael Barthelemy, of the Tongva leader family of David, Sparky, Art, and Anthony Morales, was contacted to negotiate reburial. As a then new lawyer, he couldn‚Äôt stop the development, but managed a reburial. The site is around Victory and Balboa Blvds.\n\n\n\nVictory and Balboa, just to document"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#reseda",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#reseda",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Reseda",
    "text": "Reseda\nBefore getting to the Friends of CicLAvia lunch, I got to see the iconic Reseda sign in the median; it would be way harder to take a photo of it outside CicLAvia.\n\n\n\nReseda sign on Sherman Way\n\n\n\n\n\nEntering the Reseda pedestrian zone, the east end of the route\n\n\n\n\n\nDJs playing electronic music, unfortunately this photo doesn‚Äôt come with music. Apparently at least some of their equipment was solar powered. Not sure how well that works on this cloudy day.\n\n\n\n\n\nBike mechanics at Reseda Hub\n\n\nAlso the Reseda Theatre, which shuttered in 1988. Historical photos can be seen here. The facade was remodeled sometime between 1958 and 1963, the height of the atompunk era in retrofuturistic terms, hence the Googie atompunk style we see today.\n\n\n\nReseda Theatre, remember that guy in the yellow shirt on Orange Line bike path\n\n\n\n\n\nThe other side of Reseda Theatre, with murals"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#friends-of-ciclavia-lunch",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#friends-of-ciclavia-lunch",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Friends of CicLAvia lunch",
    "text": "Friends of CicLAvia lunch\nIt was a little past 12 pm when I got to the Vinh Loi Tofu restaurant for the Friends of CicLAvia lunch. I was not late.\n\n\n\nCicLAvia buttons at the restaurant for us monthly donors\n\n\nWe didn‚Äôt all sit down to start at the same time. Instead, we grabbed food as we came. Everything is vegan. The vegan meat substitutes in the bah mi and spring rolls were so good. Too bad they gave us disposable plates. Again, why didn‚Äôt I bring my own? But at least I didn‚Äôt have to pay for the food.\n\n\n\nMy lunch\n\n\nThis is a vegan restaurant, and the owner, ever grumpy and on the move, races Ironman, which is impressive by my standard even though I ride gran fondos quite often because in an Ironman you have to swim and run in addition to riding a gran fondo and there are no traffic lights and photo stops for you to rest. Because when riding more than 80 miles, I usually stop for lunch which often makes me so full that my stomach would get upset if I ride hard right after, how Ironman racers fuel during the lengthy race remains kind of a mystery to me. Proof that going vegan doesn‚Äôt make you weak and sick.\n\n\n\nThe grumpy restaurant owner and his Ironman medals; from the Buddha statue, I think he‚Äôs most likely vegan because of his Buddhist faith.\n\n\n\n\n\nProbably the owner‚Äôs wife, not so grumpy. Feeling too awkward to talk to them.\n\n\nAlso at lunch, I met a few East Side Riders whom I met on February 11. They remember me.\n\n\n\nEast Side Riders, also friends of CicLAvia"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#reseda-continued",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#reseda-continued",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Reseda, continued",
    "text": "Reseda, continued\nAcross the street from the restaurant is the Bridge Bible Fellowship, where the church band was performing during CicLAvia, in typical contemporary hymn style.\n\n\n\nBridge Bible Fellowship\n\n\nThen I crossed Aliso Canyon Wash, and came across the cool murals of the pediatric clinic, O&P in Motion. Yes, I have been to an upstream part of Aliso Canyon Wash, the Porter Ranch Park, after lunch at a Lebanese restaurant in the shopping mall during my second century, in December 2021.\n\n\n\nO&P mural\n\n\n\n\n\nThe other side of the clinic"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#winnetka",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#winnetka",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Winnetka",
    "text": "Winnetka\nThen I rode towards Winnetka, the neighborhood to the west of Reseda, with the Mid Century Modern DWP, the iconic Victorian building, and some beautiful churches. Some suburbian residential areas separate the mini-downtowns of the neighborhood.\n\n\n\nFrom Reseda to Winnetka\n\n\n\n\n\nMid Century Modern DWP building\n\n\n\n\n\nEven businesses near the iconic Victorian building are named Victoria. Also note that volunteer in yellow t-shirt wearing British royal guard hat asking cyclists to dismount in the pedestrian zone.\n\n\n\n\n\nGetting closer to the Victorian building\n\n\n\n\n\nYou might have noticed a church tower in the distance in the first photo of the Victorian building. Here it is up close."
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#canoga-park",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#canoga-park",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Canoga Park",
    "text": "Canoga Park\nAfter Winnetka was Canoga Park, with some Googie atompunk buildings, including the car wash and Wienerschnitzel at De Soto. I was looking for some Googie buildings so iconic of vintage car culture and juxtapose them with cyclists and pedestrians to signal rebellion, since car culture is so hostile to the latter.\n\n\n\nWienerschnitzel\n\n\n\n\n\nCanoga Park Hand Car Wash, probably going to be converted into a bike wash after we abolish car culture.\n\n\n\n\n\nHistorical USPS building, probably from the 1930s based on style, in Canoga Park, near Owensmouth\n\n\n\n\n\nCrossing Canoga Ave\n\n\nFurther west: Discount Tires and the historical Madrid Theatre (and one of the photos on the linked website was taken during the 2019 CicLAvia) at Owensmouth (yes, because of the aqueduct bringing Owens Valley water to the SFV), and the legacy Cavaretta‚Äôs Italian Deli a little west of Topanga Canyon Blvd.\n\n\n\nI took a photo of someone else taking a photo with a real camera at Madrid Theatre. So I‚Äôm not the only one.\n\n\n\n\n\nDiscount Tire with the cool mural. Behold the lowrider in action.\n\n\n\n\n\nCavaretta‚Äôs Italian Deli\n\n\nAfter spending some time at the Canoga Park hub, where I got to sample some different bike cultures, I left the route at Owensmouth and headed to my own adventure, to ride on as much of LA River bike paths as possible.\n\n\n\nHeading to the last pedestrian zone, Canoga Park\n\n\n\n\n\nBMX? I thought BMX bikes would be shorter, but these bikes have BMX handlebars.\n\n\n\n\n\nCicLAvia map and more from the BMX culture, which I don‚Äôt know much about and I was too shy to talk to those people.\n\n\n\n\n\nBMX again? Also note the flooded road. This was a blessed opening in the midst of storm.\n\n\n\n\n\nJust to document\n\n\n\n\n\nSpecial tandem cruiser bike and special Metro Art Bus. Caveat: how well can passengers see out of that bus?\n\n\n\n\n\nSomeone must be really obsessed with Coca Cola. BTW, it‚Äôs unthinkable how much sugar there is in those drinks consumed by sedentary people. They are sweeter than my sports drinks which I only drink for at least tempo efforts when I begin to burn more glycogen. That‚Äôs how unhealthy those sugary drinks are.\n\n\n\n\n\nBike mechanic fixing a flat at Canoga Park Hub\n\n\nI made a U turn and made a right on Owensmouth to depart CicLAvia, leading to LA River. BTW, this is the most upstream place where LA River is called LA River. Further upstream, in the Santa Monica Mountains, there are Arroyo Calabassas and Bell Breek.\n\n\n\nCool mural of Canoga Park Florist on Owensmouth\n\n\n\n\n\nThis part of Owensmouth south of Sherman Way was also at least in part closed to cars, looking south towards Woodland Hills.\n\n\nPhotography lessons learnt: I made mistakes and learn from mistakes. Number one, one thing CicLAvia taught me is that it turns out that shooting environmental portraits is fun. Which I totally didn‚Äôt expect given that I‚Äôm introverted and don‚Äôt like talking to strangers. Still no courage to get strangers to pose though. Here‚Äôs how it got started: Last December, I went to Samy‚Äôs Camera in Pasadena for Mark Edward Harris‚Äôs class on travel photography, which happened to be free as part of Nikon Day. He talked about environmental portraits as part of the photo essay about a place, such as LA. He also said that it would not be possible to do a photo essay of a place that is too complex, which I totally agree, but I disagree with him that LA is simple enough to be able to be well-represented in a photo essay. The next day, I tried to practice what I learnt in CicLAvia, and tried to take an environmental portrait of a bike mechanic at the Exposition Park hub, and of a family playing giant chess.\nMy greatest cycling achievement is that it helped me to overcome years of social anxiety, because the aerobic exercise induced endorphin made me less nervous and over time the evidence built up that talking to people isn‚Äôt scary. It didn‚Äôt make me extraverted, but it did make me less scared of talking to people. Also, probably especially because LA is so bike unfriendly, cyclists tend to be nice to each other. At least for us Lycra road warriors, we culturally greet each other on the road even if we don‚Äôt know each other, as if saying, ‚ÄúHey, we have the same mental illness.‚Äù In contrast, when I went to more bike friendly cities such as Seattle, Portland, Sacramento, and Davis, there were so many cyclists that nobody thinks twice, so we generally didn‚Äôt greet each other.\nSo long story short, I got opened up to people and find it fun to take photos of them, especially when it comes to different aspects of cycling culture. When learning photography, I prioritized landscape and city, since presumably that‚Äôs what I expect in my voyages; generally I want the entire scene to be sharp, so smaller apertures and polarizing filter. This time I found out that my go to travel lens ‚Äì a lightweight and versatile Panasonic G Vario 12-60 mm zoom lens for micro four thirds (I chose MFT because it and its lenses are smaller so easier for me to carry when climbing thousands of feet in one trip) ‚Äì doesn‚Äôt have large enough an aperture to make that nice background blur. I was already using the largest aperture I had for the focal length and it couldn‚Äôt create enough of a background blur which would make those portraits nicer (f/3.5 and gets smaller as I zoom in so it kind of limits how shallow the depth of field I can get even if I compress the scene by standing back and zooming all the way in). So time to burn some money on some f/1.8 portrait lenses, second hand of course. While MAMILs are notorious for burning money on cycling gear, I find that photography gear gets really expensive much more quickly than cycling gear, so buying new with the bit of grad school stipend I saved by not flying, not driving, and not eating out is unthinkable. I suppose if with better photos, I can make cycling in LA look cool and change the way people think about LA so we can better work towards green transport and Vision Zero, then the few hundred bucks for the lenses are worth it.\nNumber two, I got to befriend shutter priority and burst mode. I made a mistake of not setting fast enough a shutter speed. While 1/250 second is good enough for cyclists further away and pedestrians, it‚Äôs too slow for cyclists that are closer, so I got a blurry shot that otherwise has great composition (not shown here) which I kept on my external HD as a record. I really should use 1/1000. Somehow I found that crazy fast, probably because I often use a polarizing filter and smaller aperture for landscape shots (actually f/8 rather than the conventional f/16 most of time as that‚Äôs the sharpest for my MFT lenses), leading to slower shutter speed, which makes me think 1/250 is fast enough.\nNumber three, I made a really dumb mistake that ruined an otherwise nice portrait in Canoga Park of BMX riders ‚Äì I focused the wrong area, and given that I used the largest aperture I had, intending to blur out the background with shallower depth of field, the riders got blurry. Then I just realized that my camera has a face priority mode that would automatically focus on detected faces. The riders are generally really happy and cooperative with me taking photos of them. It‚Äôs not that awkward.\nNumber four, I made the merger mistake again and didn‚Äôt realize until I looked at my photos at home on my laptop, but it‚Äôs so hard to avoid all mergers when there are so many things in the background. Be more careful next time, and burst mode might help. Also, I wonder how pros get all the settings ready in a changing situation so they don‚Äôt miss the shot by the time they‚Äôre done with the settings. I suppose for the next CicLAvia in April, I‚Äôll change to a portrait lens and get the settings ready before I enter the first pedestrian zone."
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#encino-velodrome",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#encino-velodrome",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Encino Velodrome",
    "text": "Encino Velodrome\nWe in LA are blessed with two velodromes. One in Encino, within the Sepulveda Basin recreation area grouped together with baseball fields, and another in Carson, the only Olympic grade indoor velodrome in North America. While the Carson velodrome is deemed cool and hosts world championships and plans to host track cycling races in the 2028 Olympics, the Encino velodrome struggles to keep up with maintenance. Classes at the Encino velodrome are also much cheaper than those at the Carson velodrome. Last time, in December 2021, I visited the Encino Velodrome, which was closed. This time I visited again to see if I had any luck to enter it. No, no luck. I wonder if it would only open during its classes. Or maybe it closed because of the rain, which may make the track slippery and unsafe for riding. Anyway, I peeked inside and took some photos.\n\n\n\nOlympic rings on the concrete track of the Encino velodrome. The red (black in Carson) line is the pole or sprinter‚Äôs line, for hard efforts when training, and blue line above is the relief line, for tempo efforts and for relief in Madison races. This track isn‚Äôt as steep as the on in Carson, where it takes me threshold effort just not to slip down when riding above the blue line especially that I have to go up and down on that line. So Encino is probably more suitable for us mortals, while the Carson velodrome is for Olympians.\n\n\n\n\n\nIn the dilapidated parking lot of the Encino velodrome\n\n\nAfter the velodrome, I continued on the south side of the basin, and saw a memorial of someone hit and killed by a car around the golf course.\n\n\n\nThe memorial for Noe. THe green poster on the left side of the tree says that he was hit."
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#muddy-flooded-bike-path",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#muddy-flooded-bike-path",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Muddy flooded bike path",
    "text": "Muddy flooded bike path\nI‚Äôm so sorry, Voyager. The flooding must have been worst on the south side of the basin. The bike path got flooded at one point, and got really muddy for quite a long stretch. Voyager‚Äôs road slicks didn‚Äôt have enough traction, so I had to walk. I thought that the plant roots could better support my weight in the mud, so I walked on the grass away from the bike path, but I got really muddy anyway. Mud got caught on Voyager‚Äôs rims and frame, and clogged up my road cleats that really aren‚Äôt meant for this situation, which I didn‚Äôt really expect. It took me a while to wipe off most of the mud from the wheels, frame, and cleats.\n\n\n\nMuddy bike path\n\n\n\n\n\nSepulveda wildlife reserve, just past the nasty muddy part\n\n\n\n\n\nSepulveda wildlife reserve and snowy peaks"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#inside-the-dam",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#inside-the-dam",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "Inside the dam",
    "text": "Inside the dam\nMy effort to wipe off the mud was in vain, as I realized that I was going into the Sepulveda dam dirt trails, following the route. Why have I been so stupid in planning the route this way? Well, when it‚Äôs dry, the dirt trails might be ridable when the dirt is tightly packed. Somehow I wasn‚Äôt thinking that I planned to go to some dirt trail this time, as I initially planned this part of the route a long time ago. The tunnel leading to the dam was flooded, and lined with graffiti, to my delight.\n\n\n\nGraffiti in the tunnel towards the inside of the dam, the water was still a little disturbed from me riding there, hoping to wash off a little mud.\n\n\n\n\n\nLooking into the dam\n\n\nAt some point, so much mud was caught between Voyager‚Äôs rear wheel and the frame that the wheel couldn‚Äôt turn, so I effectively dragged Voyager around in the mud. Nevertheless, I was determined to get to where LA River exits the dam. While my pants and shoes got very muddy, my camera was mostly spared, though mud kind of clogged up the rotating mechanism of my polarizing filter.\n\n\n\nInside the dam\n\n\n\n\n\nSeeing the dam\n\n\nI felt so relieved when I got to the ramp leading to the dam top, finally away from the mud. The dam top is paved, though not really a bike path like on Santa Fe, Hansen, and Whittier Narrows dams. I saw an old photo at the LA Public Library of cat faces painted on the flood outlet caps at Sepulveda Dam. It might be on the other side, so I walked down a grass slope to the other side of the dam, to the south, where someone was riding a motorcycle.\n\n\n\nDam top and snowy peaks in the distance"
  },
  {
    "objectID": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#the-rainbow",
    "href": "posts/2023-03-14-palm-trees-snowy-peaks-and-sepulveda-mud/index.html#the-rainbow",
    "title": "Palm trees, snowy peaks, and Sepulveda mud",
    "section": "The rainbow",
    "text": "The rainbow\nI saw 3 graffiti artists this side of the dam, walking under the giant arches. I rode and walked to the western edge of the concrete on the southern side of the dam. I also saw the 405 freeway chocked by traffic. It began to rain a little, but not much.\n\n\n\nGraffiti artists on the dam\n\n\nThe rain stopped, and a rainbow appeared to the east, as the afternoon sun was shining from the west. I rushed to the west as far as I could to see if I could capture the entire arch of the rainbow. I couldn‚Äôt. But I took a panorama. The graffiti artists were walking away from dam, but I caught them right beneath the rainbow.\n\n\n\nGraffiti artists beneath the rainbow\n\n\n\n\n\nThe whole rainbow, and my shadow\n\n\n\n\n\nThe rainbow stayed for a while, and the graffiti artists walked to the grass\n\n\n\n\n\nAt that little pond by the excavater\n\n\nThe rainbow stayed for quite a while. I was heading out of the dam. It turns out that there‚Äôs an official ramp from this side to the dam top as well. I scraped off more mud with sticks I found on the dirt ground, sometimes breaking the stick as the mud was too stubborn, and rode towards the road, towards Sepulveda Blvd.\n\n\n\nBack on dam top. Bike rock!\n\n\n\n\n\nZooming into that building\n\n\nBummer: there‚Äôs a gate from the dam to the road, and it was closed, though I could walk around it. I saw two flowers stuck in the wood of a traffic barrier, not sure if they grew there or if someone put them there.\n\n\n\nFlowers at this interesting place"
  },
  {
    "objectID": "posts/2023-03-17-multispati-part-1/index.html",
    "href": "posts/2023-03-17-multispati-part-1/index.html",
    "title": "Spatially informed PCA",
    "section": "",
    "text": "Due to the large number of genes quantified in single cell and spatial transcriptomics, dimension reduction is part of the standard workflow to analyze such data, to visualize, to help interpreting the data, to distill relevant information and reduce noise, to facilitate downstream analyses such as clustering and pseudotime, to project different samples into a shared latent space for data integration, and so on.\nThe first dimension reduction methods we learn about, such as good old principal component analysis (PCA), tSNE, and UMAP, don‚Äôt use spatial information. With the rise of spatial transcriptomics, some dimension reduction methods that take spatial dependence into account have been written. Some, such as SpatialPCA (Shang and Zhou 2022), NSF (Townes and Engelhardt 2023), and MEFISTO (Velten et al. 2022) use factor analysis or probabilistic PCA which is related to factor analysis, and model the factors as Gaussian processes, with a spatial kernel for the covariance matrix, so the factors have positive spatial autocorrelation and can be used for downstream clustering where the clusters can be more spatially coherent. Some use graph convolution networks on a spatial neighborhood graph to find spatially informed embeddings of the cells, such as conST (Zong et al. 2022) and SpaceFlow (Ren et al. 2022). SpaSRL (Zhang et al. 2023) finds a low dimension projection of spatial neighborhood augmented data.\nSpatially informed dimension reduction is actually not new, and dates back to at least 1985, with Wartenberg‚Äôs crossover of Moran‚Äôs I and PCA (Wartenberg 1985), which was generalized and further developed as MULTISPATI PCA (Dray, Saƒ±Ãàd, and D√©bias 2008), implemented in the adespatial package on CRAN. In short, while PCA tries to maximize the variance explained by each PC, MULTISPATI maximizes the product of Moran‚Äôs I and variance explained. Also, while all the eigenvalues from PCA are non-negative, because the covariance matrix is positive semidefinite, MULTISPATI can give negative eigenvalues, which represent negative spatial autocorrelation, which can be present and interesting but is not as common as positive spatial autocorrelation and is often masked by the latter (Griffith 2019).\nIn single cell -omics conventions, let \\(X\\) denote a gene count matrix whose columns are cells or Visium spots and whose rows are genes, with \\(n\\) columns. Let \\(W\\) denote the row normalized \\(n\\times n\\) adjacency matrix of the spatial neighborhood graph of the cells or Visium spots, which does not have to be symmetric. MULTISPATI diagonalizes a symmetric matrix\n\\[\nH = \\frac 1 {2n} X(W^t+W)X^t\n\\]\nHowever, the implementation in adespatial is more general and can be used for other multivariate analyses in the duality diagram paradigm, such as correspondence analysis; the equation above is simplified just for PCA, without having to introduce the duality diagram here.\nIn this blog post, I use adespatial to run MULTISPATI PCA, compare the results to those of non-spatial PCA, and in Part 2 of the post, try a faster implementation using RSpectra. The faster implementation will be added to the next release of Voyager in Bioconductor 3.17 in May. This will be the first multivariate spatial analysis method in Voyager, as the implementation is straightforward and all packages required are on CRAN or Bioconductor. This blog post itself will be edited to become a new vignette. I‚Äôm writing it here in the process to think before I code. So the code here isn‚Äôt meant to remain runnable in the future after the next release comes out, because the user interface of devel functions in Voyager can change in the next few weeks.\nHere we load the packages:\n\nlibrary(ade4)\nlibrary(adespatial)\nlibrary(SFEData)\nlibrary(scater)\nlibrary(scran)\nlibrary(Voyager)\nlibrary(sparseMatrixStats)\nlibrary(SingleCellExperiment)\nlibrary(tidyverse)\nlibrary(bluster)\ntheme_set(theme_bw())\n\nThe development version of Voyager is used here, and I will note code that doesn‚Äôt work with the current release version in Bioconductor 3.16. In Bioconductor version numbering conventions, an odd minor version number (the second number) means devel.\n\npackageVersion(\"Voyager\")\n\n[1] '1.1.10'"
  },
  {
    "objectID": "posts/2023-03-17-multispati-part-1/index.html#morans-i-of-multispati-and-non-spatial-pca-embeddings",
    "href": "posts/2023-03-17-multispati-part-1/index.html#morans-i-of-multispati-and-non-spatial-pca-embeddings",
    "title": "Spatially informed PCA",
    "section": "Moran‚Äôs I of MULTISPATI and non-spatial PCA embeddings",
    "text": "Moran‚Äôs I of MULTISPATI and non-spatial PCA embeddings\nHere we compute Moran‚Äôs I for the spot embeddings. Note that this is a devel feature, not implemented in the Bioconductor 3.16 version of Voyager, and might change before the release of Bioconductor 3.17.\n\n# non-spatial\nsfe <- reducedDimMoransI(sfe, dimred = \"PCA\", components = 1:30)\n# spatial\nsfe <- reducedDimMoransI(sfe, dimred = \"multispati\", components = 1:60)\n\n\ndf_moran <- tibble(PCA = reducedDimFeatureData(sfe, \"PCA\")$moran_Vis5A[1:30],\n                   MULTISPATI_pos = reducedDimFeatureData(sfe, \"multispati\")$moran_Vis5A[1:30],\n                   MULTISPATI_neg = reducedDimFeatureData(sfe,\"multispati\")$moran_Vis5A[31:60] |> \n                       rev(),\n                   index = 1:30)\n\nThe lower bound of Moran‚Äôs I given the spatial neighborhood graph is usually greater than -1, while the upper bound is usually around 1. The bounds given this particular spatial neighborhood graph can be found here:\n\n(mb <- moran.bounds(colGraph(sfe, \"visium\")))\n\n      Imin       Imax \n-0.5762132  1.0021884 \n\n\n\ndf_moran |> \n    pivot_longer(cols = -index, values_to = \"value\", names_to = \"name\") |> \n    ggplot(aes(index, value, color = name)) +\n    geom_line() +\n    scale_color_manual(values = ditto_colors) +\n    geom_hline(yintercept = 0) +\n    geom_hline(yintercept = mb, linetype = 2) +\n    scale_y_continuous(breaks = scales::breaks_pretty()) +\n    scale_x_continuous(breaks = scales::breaks_width(5)) +\n    labs(y = \"Moran's I\", color = \"Type\", x = \"Component\")\n\n\n\n\nMULTISPATI‚Äôs PCs do have higher Moran‚Äôs I than those of non-spatial PCA, when the eigenvalues are positive. The difference is much larger after the first 2 PCs. Moran‚Äôs I drops quickly towards 0 as we move on to the subsequent non-spatial PCs, while the decay is much more gradual for MULTISPATI. The negative Moran‚Äôs I‚Äôs for the components with the most negative eigenvalues are actually very strong considering the bounds (shown in dashed horizontal lines)."
  },
  {
    "objectID": "posts/2023-03-17-multispati-part-1/index.html#clustering-with-non-spatial-pca",
    "href": "posts/2023-03-17-multispati-part-1/index.html#clustering-with-non-spatial-pca",
    "title": "Spatially informed PCA",
    "section": "Clustering with non-spatial PCA",
    "text": "Clustering with non-spatial PCA\n\nset.seed(29)\nsfe$clusts_nonspatial <- clusterCells(sfe, use.dimred = \"PCA\", \n                                      BLUSPARAM = NNGraphParam(\n                                          cluster.fun = \"leiden\",\n                                          cluster.args = list(\n                                              objective_function = \"modularity\",\n                                              resolution_parameter = 1\n                                          )\n                                      ))\n\nColor the PCA scatter plot with the clusters:\n\nplotPCA(sfe, ncomponents = 3, colour_by = \"clusts_nonspatial\") +\n    scale_color_manual(values = ditto_colors)\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\n\n\n\nPlot the clusters in space:\n\nplotSpatialFeature(sfe, \"clusts_nonspatial\")\n\n\n\n\nClusters 1, 3, 5, 6, 7 are myofibers, while 2 and 4 are in the leukocyte infiltrated injury region. Cluster 6 may be related to the muscle tendon junction, based on location. We use the silhouette index to score how well separated the clusters are in histological space:\n\nsil <- approxSilhouette(spatialCoords(sfe), clusters = sfe$clusts_nonspatial)\n\n\nmean(sil$width)\n\n[1] -0.009435808\n\n\nA positive number closer to 1 indicates that the clusters are well-separated. Here the number is close to 0 and is negative, which means that the clusters are not well-separated in space and many spots are closer to spots from other clusters than those from its own cluster, as in the visual impression."
  },
  {
    "objectID": "posts/2023-03-17-multispati-part-1/index.html#with-multispati-pca",
    "href": "posts/2023-03-17-multispati-part-1/index.html#with-multispati-pca",
    "title": "Spatially informed PCA",
    "section": "With MULTISPATI PCA",
    "text": "With MULTISPATI PCA\nHere we use the top positive MULTISPATI PCs for clustering, with the same Leiden parameters.\n\nset.seed(29)\nsfe$clusts_multispati <- clusterRows(reducedDim(sfe, \"multispati\")[,1:30],\n                                     BLUSPARAM = NNGraphParam(\n                                          cluster.fun = \"leiden\",\n                                          cluster.args = list(\n                                              objective_function = \"modularity\",\n                                              resolution_parameter = 1\n                                          )\n                                      ))\n\nColor MULTISPATI scatter plot with the clusters:\n\nplotReducedDim(sfe, \"multispati\", ncomponents = 3, colour_by = \"clusts_multispati\") +\n    scale_color_manual(values = ditto_colors)\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\n\n\n\nThe shapes of the scatter plots look similar to those in non-spatial PCA, at least for the first 3 PCs.\nColor the MULTISPATI scatter plot with non-spatial PCA clustering:\n\nplotReducedDim(sfe, \"multispati\", ncomponents = 3, colour_by = \"clusts_nonspatial\") +\n    scale_color_manual(values = ditto_colors)\n\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n\n\n\n\n\nThe clusters seem similar except for the numbering.\nPlot the MULTISPATI clusters in space, side by side with the non-spatial ones:\n\np1 <- plotSpatialFeature(sfe, \"clusts_multispati\") +\n    ggtitle(\"MULTISPATI\")\np2 <- plotSpatialFeature(sfe, \"clusts_nonspatial\") +\n    ggtitle(\"Non-spatial PCA\")\np1 + p2\n\n\n\n\nMULTISPATI clusters (left) do appear more spatially coherent than non-spatial PCA clustering (right). Also compute the silhouette index here:\n\nsil2 <- approxSilhouette(spatialCoords(sfe), clusters = sfe$clusts_multispati)\n\n\nmean(sil2$width)\n\n[1] 0.07191857\n\n\nWhile it‚Äôs not a very high value because there‚Äôs only so much that can fit into 2 dimensions, it indicates that the MULTISPATI clusters are better separated in histological space than non-spatial PCA clusters.\nWhat do these clusters mean? Clusters are supposed to be groups of different spots that are more similar within a group, sharing some characteristics. Non-spatial and MULTISPATI PCA use different characteristics for the clustering. Non-spatial PCA finds genes that are good for telling cell types apart, although those genes may happen to be very spatially structured. Non-spatial clustering aims to find these groups only from gene expression, and cells with similar gene expression can be surrounded by cells of other types in histological space. This is just like mapping Art Deco buildings, which are often near Spanish revival and Beaux Art buildings whose styles are quite different and perform different functions, thus not necessarily forming a coherent spatial region.\nIn contrast, MULTISPATI‚Äôs positive components find genes that must characterize spatial regions in addition to distinguishing between different cell types. Which genes are involved in each MULTISPATI component may be as interesting as the clusters. It would be interesting to perform gene set enrichment analysis, or to interpret this as some sort of spatial patterns of spatially variable genes. This is like mapping when the buildings were built, so Art Deco, Spanish revival, Beaux Art popular in the 1920s and 1930s will end up in the same cluster and form a more spatially coherent region, which can be found in DTLA Historical Core and Jewelry District, and Old Pasadena. Hence non-spatial clustering of spatial data isn‚Äôt necessarily bad. Rather, it tells a different story and reveals different aspects of the data from spatial clustering."
  },
  {
    "objectID": "posts/2023-03-17-multispati-part-1/index.html#smaller-scale-clusters",
    "href": "posts/2023-03-17-multispati-part-1/index.html#smaller-scale-clusters",
    "title": "Spatially informed PCA",
    "section": "Smaller scale clusters",
    "text": "Smaller scale clusters\nSpatial regions can come in hierarchies. In geographical space, using an example familiar to me from the voyages of starship Voyager, this can be Southern California (SoCal) at a higher level, defined by culture and climate, followed by the metropolitan region of LA and Orange Counties (OC) and perhaps urgan regions of western San Bernardino County, followed by different regions of LA County such as Eastside, Westside, South Bay, Harbor Cities, South LA, Central LA, San Fernando Valley (SFV), Northeast LA, San Gabriel Valley (SGV), Pomona Valley, Angeles National Forest, Antelope Valley, Santa Monica Mountains, and etc., followed by neighborhoods and small cities within those regions, such as Boyle Heights, Highland Park, Mt Washington, Westwood, and etc. which in practice are similar in scale and function to most smaller cities like San Marino, Beverly Hills, Culver City, Arcadia, San Gabriel, and etc., each of which have sub-regions.\nSuppose we perform MULTISPATI PCA on LA County, not really quantitatively, just based on my own familiarity and types of interactions with these places. I think PC1 would separate the wilderness of Angeles National Forest, Santa Monica Mountains, Griffith Park, much of San Rafael Hills, and much of Puente hills from the urban and suburban regions. PC2 might separate the mostly Black and Hispanic regions that are usually less affluent such as Eastside, South LA, and NELA, from affluent mostly White and sometimes Asian regions like Westside, South Bay, Beverly Hills, southern SFV, northern SGV, La Canada Flintridge, and etc. but it might not distinguish between different Latino regions such as Highland Park and El Sereno. PC2 and PC3 may also pick up the Asian regions in much of the SGV and in Koreatown. Subsequent PCs may pick up some industrial regions, such as Arts District, Vernon, City of Industry, Carson, Wilmington, and perhaps smaller racialized regions, such as those within Pasadena and DTLA, different vibes of neighborhoods with similar socioeconomic status, mini-downtowns of neighborhoods, smaller but very distinct regions such as the Aerospace Corridor near LAX, and architectural styles from different eras.\nClustering with the first few PCs will give you Angeles National Forest, Eastside, Westside, and etc., which might not answer a specific question about LA, such as different types of Latino neighborhoods, redistricting Pasadena, and different ecosystems within the Angeles National Forest. These questions would benefit from the ‚Äúlater‚Äù PCs with smaller length scales of spatial autocorrelation. Another moral of this thought experiment is that the PCs that explain a smaller percentage of variance aren‚Äôt necessarily uninteresting. That something else shows a more drastic difference doesn‚Äôt mean that smaller differences are irrelevant. I personally find these more local differences very interesting. However, those unfamiliar with the region won‚Äôt ask these questions to begin with. Moral: as a bioinformatician not specialized in any particular tissue or disease, each of which seems to be its own field of study, I desperately need the help of experts in those tissues and diseases to make sense of data. I might not be using the most relevant way to find spatial regions when it comes to the more relevant questions about those tissues and diseases.\nAnyway, biological interpretations aside, what if we cluster with MULTISPATI components with shorter length scales of spatial autocorrelation?\nFirst, what do those components look like?\n\nspatialReducedDim(sfe, \"multispati\", ncomponents = 9:30, \n                  divergent = TRUE, diverge_center = 0, ncol = 6)\n\n\n\n\nAlso plot top gene loadings for some of these MULTISPATI components:\n\nplotDimLoadings(sfe, dims = 8:13, reduction = \"multispati\", \n                swap_rownames = \"symbol\", ncol = 3)\n\n\n\n\nSome genes with high loading in these ‚Äúlater‚Äù components are known to be involved in muscle regeneration, such as Myog, Xirp1, and Cxcl9, and potentially Bicd2, Csrp3, and Nek6. The slingshot package performs pseudotime analysis on any dimension reduction. It would be interesting to see what if we perform pseudotime analysis on MULTISPATI rather than non-spatial PCA, with the later two timepoints and more biological replica. This dataset comes from the first time point after notexin injury, and this study only has one biological replicate per time point.\nThese components tend to highlight heterogeneity within the leukocyte infiltrated injury region when plotting the embeddings in space, which is consistent with the muscle regeneration genes with high. This seems to be the case, based on visual inspection, for CS8 and later. What if I only use CS8 and later components for clustering?\n\nset.seed(29)\nsfe$clusts_multispati2 <- clusterRows(reducedDim(sfe, \"multispati\")[,8:30],\n                                     BLUSPARAM = NNGraphParam(\n                                          cluster.fun = \"leiden\",\n                                          cluster.args = list(\n                                              objective_function = \"modularity\",\n                                              resolution_parameter = 1\n                                          )\n                                      ))\n\nHere‚Äôs the H&E image for reference: \n\np1 <- plotSpatialFeature(sfe, \"clusts_multispati2\") +\n    ggtitle(\"CS8-30\")\np2 <- plotSpatialFeature(sfe, \"clusts_multispati\") +\n    ggtitle(\"CS1-30\")\np1 + p2\n\n\n\n\nIt seems that when using all of the top 30 PCs from MULTISPATI, while PC1 by far explains much more variance than other PCs, the heterogeneity from the later PCs is not all overwhelmed and lost. When using only 8-30, perhaps due to the shorter length scale of spatial autocorrelation, the clusters are less spatially contiguous, and there are smaller, more local clusters such as clusters 5 and 6 that might mark distinct muscle regions adjacent to the injury region."
  },
  {
    "objectID": "posts/2023-03-25-multispati-part-2/index.html",
    "href": "posts/2023-03-25-multispati-part-2/index.html",
    "title": "A faster implementation of MULTISPATI PCA",
    "section": "",
    "text": "Last time, I used the implementation of MULTISPATI PCA in adespatial on the mouse skeletal muscle Visium dataset. The dataset is small by scRNA-seq standards, with only 900 something spots. It too about half a minute to run MULTISPATI PCA, to obtain 30 PCs with the most positive eigenvalues and 30 with the most negative eigenvalues. It might not sound too bad, but it only took less than one second to run non-spatial PCA with the IRLBA algorithm to obtain 30 PCs.\nThe adespatial implementation is slow because it performs full spectrum decomposition twice, with base R‚Äôs eigen() function. The first is to perform non-spatial PCA, whose output contains row and column weights and the original data that are then used by the multispati() function. The second time is for the spatially weighted covariance matrix in multispati(). Although only the top 30 positive and negative eigenvalues and their corresponding eigenvectors are retained in the results, all the 900 something eigenvalues and eigenvector were computed, doing a lot of unnecessary work.\nI would like to perform MULTISPATI PCA on single cell resolution datasets with over 100,000 cells, so I need a more efficient implementation, which is what I do here.\nHere we load the packages. Note that the devel version of SpatialFeatureExperiment and Voyager are used here.\n\nlibrary(Voyager)\nlibrary(ade4)\nlibrary(adespatial)\nlibrary(SFEData)\nlibrary(RSpectra)\nlibrary(tidyverse)\nlibrary(bench)\nlibrary(sf)\nlibrary(scater)\nlibrary(scran)\nlibrary(profvis)\nlibrary(spdep)\nlibrary(Matrix)\ntheme_set(theme_bw())\n\n\npackageVersion(\"SpatialFeatureExperiment\")\n\n[1] '1.1.5'\n\n\n\npackageVersion(\"Voyager\")\n\n[1] '1.1.10'\n\n\n\nDataset\nThe dataset used here is a MERFISH dataset from healthy mouse liver from Vizgen. It is available in the SFEData package.\n\n(sfe <- VizgenLiverData())\n\nsnapshotDate(): 2022-10-31\n\n\nsee ?SFEData and browseVignettes('SFEData') for documentation\n\n\nloading from cache\n\n\nrequire(\"SpatialFeatureExperiment\")\n\n\nclass: SpatialFeatureExperiment \ndim: 385 395215 \nmetadata(0):\nassays(1): counts\nrownames(385): Comt Ldha ... Blank-36 Blank-37\nrowData names(3): means vars cv2\ncolnames(395215): 10482024599960584593741782560798328923\n  111551578131181081835796893618918348842 ...\n  92389687374928708938472537234969690424\n  96399783859933548456002372694492036651\ncolData names(9): fov volume ... nCounts nGenes\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nspatialCoords names(2) : center_x center_y\nimgData names(1): sample_id\n\nGeometries:\ncolGeometries: centroids (POINT), cellSeg (POLYGON) \n\nGraphs:\nsample01: \n\n\nPlot cell density in histological space:\n\nplotCellBin2D(sfe, bins = 300)\n\n\n\n\nThe cells are fairly uniformly distributed in space, but some structure with higher cell density, perhaps related to blood vessels, can be discerned.\nQC was already performed in the Voyager MERFISH vignette so I won‚Äôt go into details here. I remove low quality cells that have too many transcript counts from the blank probes as I did in that vignette.\n\nis_blank <- str_detect(rownames(sfe), \"^Blank-\")\nsfe <- addPerCellQCMetrics(sfe, subset = list(blank = is_blank))\n\n\nget_neg_ctrl_outliers <- function(col, sfe, nmads = 3, log = FALSE) {\n    inds <- colData(sfe)$nCounts > 0 & colData(sfe)[[col]] > 0\n    df <- colData(sfe)[inds,]\n    outlier_inds <- isOutlier(df[[col]], type = \"higher\", nmads = nmads, log = log)\n    outliers <- rownames(df)[outlier_inds]\n    col2 <- str_remove(col, \"^subsets_\")\n    col2 <- str_remove(col2, \"_percent$\")\n    new_colname <- paste(\"is\", col2, \"outlier\", sep = \"_\")\n    colData(sfe)[[new_colname]] <- colnames(sfe) %in% outliers\n    sfe\n}\n\n\nsfe <- get_neg_ctrl_outliers(\"subsets_blank_percent\", sfe, log = TRUE)\n(sfe <- sfe[, !sfe$is_blank_outlier & sfe$nCounts > 0])\n\nclass: SpatialFeatureExperiment \ndim: 385 390348 \nmetadata(0):\nassays(1): counts\nrownames(385): Comt Ldha ... Blank-36 Blank-37\nrowData names(3): means vars cv2\ncolnames(390348): 10482024599960584593741782560798328923\n  111551578131181081835796893618918348842 ...\n  92389687374928708938472537234969690424\n  96399783859933548456002372694492036651\ncolData names(16): fov volume ... total is_blank_outlier\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nspatialCoords names(2) : center_x center_y\nimgData names(1): sample_id\n\nGeometries:\ncolGeometries: centroids (POINT), cellSeg (POLYGON) \n\nGraphs:\nsample01: \n\n\n\n# Remove the blanks\nsfe <- sfe[!is_blank,]\n\nNormalize the data:\n\nsfe <- logNormCounts(sfe)\n\nBecause this dataset only has 385 curated genes, it‚Äôs unnecessary to find highly variable genes.\n\n\nImplementation\nTo recap, MULTISPATI diagonalizes a symmetric matrix\n\\[\nH = \\frac 1 {2n} X(W^t+W)X^t,\n\\]\nwhere \\(X\\) denotes a gene count matrix whose columns are cells or Visium spots and whose rows are genes, with \\(n\\) columns. \\(W\\) is the row normalized \\(n\\times n\\) adjacency matrix of the spatial neighborhood graph of the cells or Visium spots, which does not have to be symmetric.\nThere‚Äôre over 390,000 cells and I‚Äôll use a small subset to test the implementation before a more systematic benchmark.\n\nbbox <- st_as_sfc(st_bbox(c(xmin = 6500, ymin = 3750, xmax = 7000, ymax = 4250)))\ninds <- st_intersects(centroids(sfe), bbox, sparse = FALSE)\n(sfe_sub <- sfe[,inds])\n\nclass: SpatialFeatureExperiment \ndim: 347 1425 \nmetadata(0):\nassays(2): counts logcounts\nrownames(347): Comt Ldha ... Pdha2 Hsd17b3\nrowData names(3): means vars cv2\ncolnames(1425): 1090737716093966147093269971771778743\n  116394482990407538610204487800212441420 ...\n  300214274088721611056184746460936395547\n  336480762885429101958042577061602745945\ncolData names(17): fov volume ... is_blank_outlier sizeFactor\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nspatialCoords names(2) : center_x center_y\nimgData names(1): sample_id\n\nGeometries:\ncolGeometries: centroids (POINT), cellSeg (POLYGON) \n\nGraphs:\nsample01: \n\n\nPlot the cells of this subset:\n\nplotGeometry(sfe_sub, \"cellSeg\")\n\n\n\n\nMost tessellations of the 2D plane in real data are somewhere between a square (4 rook neighbors) and a hexagonal (6 neighbors) grid. Uncertainties in cell segmentation means that cell segmentation polygon contiguity might have many false negatives so a polygon contiguity graph may miss many actual neighbors. Hence we use the k nearest neighbor method to find a spatial neighborhood graph, with \\(k = 5\\), which appears reasonable from visual inspections. Furthermore, k nearest neighbor is more scalable to larger datasets compared to some other methods such as triangulation following by edge pruning. The devel (Bioconductor 3.17) version of SpatialFeatureExperiment can find k nearest neighbors much more efficiently than the release (Bioconductor 3.16) version. Inverse distance weighting is used so neighbors further away have less contribution, and the weighted spatial neighborhood adjacency matrix is row normalized as is customary for MULTISPATI and default in spdep so the spatially lagged values are comparable to the original values.\n\ncolGraph(sfe_sub, \"knn\") <- findSpatialNeighbors(sfe_sub, method = \"knearneigh\", \n                                                 k = 5, dist_type = \"idw\", \n                                                 style = \"W\")\n\nHere we plot the spatial neighborhood graph, where transparency of the edges corresponds to edge weight:\n\nplotColGraph(sfe_sub, \"knn\", colGeometryName = \"centroids\", weights = TRUE) +\n    theme_void()\n\n\n\n\nWrapping everything needed to get MULTISPATI results from adespatial ready to be added to reducedDims(sfe_sub) in one function:\n\ncalc_multispati_ade <- function(sfe, colGraphName, nfposi = 30, nfnega = 30) {\n    df <- logcounts(sfe) |> # Don't need highly variable genes here\n        as.matrix() |> t() |> \n        as.data.frame()\n    pca <- dudi.pca(df, scannf = FALSE, nf = nfposi) # scales data by default\n    multispati_res <- multispati(pca, colGraph(sfe, colGraphName), scannf = FALSE,\n                             nfposi = nfposi, nfnega = nfnega)\n    multispati_mat <- as.matrix(multispati_res$li)\n    rownames(multispati_mat) <- colnames(sfe)\n    loadings <- as.matrix(multispati_res$c1)\n    rownames(loadings) <- rownames(sfe)\n    colnames(loadings) <- str_replace(colnames(loadings), \"CS\", \"PC\")\n    attr(multispati_mat, \"rotation\") <- loadings\n    attr(multispati_mat, \"eig\") <- multispati_res$eig\n    multispati_mat\n}\n\nHere I use profvis to profile the code, to see the time and memory taken by each function called:\n\nprofvis({ade_res <- calc_multispati_ade(sfe_sub, \"knn\")})\n\n\n\n\n\n\nThis usually takes from 50 seconds to about a minute and 200 to 300 something MB of RAM on my lab‚Äôs server where R does NOT use an optimized BLAS (the results would be slightly different every time I run it). According to the profile, the vast majority of time was spent on eigen(), which was called twice and performed the full eigen decomposition, although only a small subset of eigenvectors are retained in the results.\nI ran the same code on my laptop which uses the optimized Apple vecLib BLAS. My laptop is a 2017 MacBook Pro with 8 GB of RAM and 2 physical CPU cores. The adespatial implementation took 390 ms (eigen() used 30 ms) and 257.5 MB of RAM. Using an optimized BLAS drastically speeds up matrix operations. See this page for instructions on changing to an optimized BLAS in Ubuntu. For Fedora, it‚Äôs possible to change BLAS without leaving the R session with flexiblas. For Mac, R 4.2 comes with vecLib so you no longer have to locate the vecLib from the system. Here‚Äôs the official instruction for Mac to make R use vecLib. Unfortunately, from my online search as I don‚Äôt personally use Windows, there is no better option than Microsoft R Open for Windows.\nHere is my implementation of MULTISPATI, with everything I can do to improve efficiency I can think of. In the spdep package, the listw2mat() function converts a listw spatial neighborhood graph object into an adjacency matrix, but it‚Äôs a dense matrix with mostly 0‚Äôs, so using a sparse matrix will save memory.\n\n# Convert listw to sparse matrix to save memory\nlistw2sparse <- function(listw) {\n    i <- rep(seq_along(listw$neighbours), times = card(listw$neighbours))\n    j <- unlist(listw$neighbours)\n    x <- unlist(listw$weights)\n    sparseMatrix(i = i, j = j, x = x)\n}\n\nThen wrap everything needed to get MULTISPATI results ready to be added to reducedDims(sfe_sub) in one function:\n\n# nf positive and negative eigenvalues\ncalc_multispati_rspectra <- function(sfe, colGraphName, nf = 30) {\n    # Scaled matrix is no longer sparse\n    X <- as.matrix(t(logcounts(sfe)))\n    X <- sweep(X, 2, colMeans(X))\n    # Note that dudi.pca divides by n instead of n-1 when scaling data\n    n <- nrow(X)\n    X <- sweep(X, 2, sqrt(colVars(X)*(n-1)/n), FUN = \"/\")\n    W <- listw2sparse(colGraph(sfe, colGraphName))\n    mid <- W + t(W)\n    covar <- t(X) %*% mid %*% X / (2*nrow(X))\n    res <- eigs_sym(covar, k = nf * 2, which = \"BE\")\n    loadings <- res$vectors\n    out <- X %*% loadings\n    colnames(out) <- paste0(\"PC\", seq_len(ncol(out)))\n    attr(out, \"rotation\") <- loadings\n    attr(out, \"eig\") <- res$values\n    out\n}\n\nI noted that ade4::dudi.pca(), whose output is used in multispati(), divides by n when computing the variance when scaling the data. This is the maximum likelihood estimate, while dividing by n-1 is the unbiased estimate. Shall I use n or n-1? For the typical size of spatial transcriptomics data, this shouldn‚Äôt cause very much of a difference\nAgain, I profile this run:\n\nprofvis({rsp_res <- calc_multispati_rspectra(sfe_sub, \"knn\")})\n\n\n\n\n\nThis usually takes 500 something ms and around 40 MB of RAM, without optimized BLAS. It is indeed much faster than the adespatial implementation, over 80 times faster. Much of the time was spent on matrix multiplication. On my laptop with vecLib, this took 90 ms and 42.5 MB of RAM, over 4 times faster than the adespatial implementation run with vecLib. Using vecLib does not reduce memory usage.\nNow check if the results are the same:\n\n# Eigenvalues\nall.equal(head(attr(rsp_res, \"eig\"), 30), head(attr(ade_res, \"eig\"), 30))\n\n[1] TRUE\n\nall.equal(tail(attr(rsp_res, \"eig\"), 30), tail(attr(ade_res, \"eig\"), 30))\n\n[1] TRUE\n\n\nSo the eigenvalues are the same. Plot the eigenvalues:\n\nplot(attr(rsp_res, \"eig\"), ylab = \"Eigenvalue\")\n\n\n\n\nNote that unlike in non-spatial PCA, the eigenvalues here don‚Äôt correspond to variance explained. Rather, it‚Äôs the product of variance explained and Moran‚Äôs I of the eigenvector. The eigenvalue drops sharply from PC1 to PC4, then levels off after PC7. The most negative eigenvalue is about -2 and the absolute value drops sharply in the next most negative eigenvalue. Given the magnitude of the eigenvalue, the most negative eigenvector might be interesting, as the Voyager MERFISH vignette hints at the presence of negative spatial autocorrelation in this dataset at the cellular level, as Moran‚Äôs I for total transcript counts per cell is somewhat negative, at around -0.1, which might not be weak given that the lower bound of Moran‚Äôs I given the spatial neighborhood graph is usually closer to -0.5 than -1, while the upper bound is usually approximately 1.\nAlso note that spatial autocorrelation in datasets with single cell resolution should be interpreted differently from that in Visium which does not have single cell resolution, because of different length scales. In a geographical analogy, this is just like comparing houses as opposed to comparing neighborhoods, or comparing cities as opposed to comparing states.\nThen we compare the eigenvectors, allowing for flipping (i.e.¬†multiplied by -1), which is OK, because an eigenvector multiplied by a scalar is still an eigenvector of the same matrix with the same eigenvalue.\n\nplot_pc_diffs <- function(mat1, mat2, npcs = 30, tail = FALSE, title = NULL) {\n    diffs <- numeric(npcs)\n    if (tail) {\n        ind1 <- tail(seq_len(ncol(mat1)), npcs)\n        ind2 <- tail(seq_len(ncol(mat2)), npcs)\n    } else {\n        ind1 <- ind2 <- seq_len(npcs)\n    }\n    for (i in seq_len(npcs)) {\n        pc1 <- mat1[,ind1[i]]\n        pc2 <- mat2[,ind2[i]]\n        diffs[i] <- min(mean(abs(pc1 - pc2)), mean(abs(pc1 + pc2))) # flipped\n    }\n    tibble(difference = diffs,\n           PC = seq_len(npcs)) |> \n        ggplot(aes(PC, difference)) +\n        geom_line() +\n        geom_hline(yintercept = sqrt(.Machine$double.eps), linetype = 2) +\n        scale_y_log10() +\n        scale_x_continuous(breaks = scales::breaks_width(5)) +\n        annotation_logticks(sides = \"l\") +\n        labs(title = title, y = \"Mean absolute difference\")\n}\n\nCompare the eigenvectors with positive eigenvalues:\n\nplot_pc_diffs(attr(rsp_res, \"rotation\"), attr(ade_res, \"rotation\"),\n              title = \"Differences in eigenvectors, adespatial vs. RSpectra, positive\")\n\n\n\n\nCompare the eigenvectors with negative eigenvalues:\n\nplot_pc_diffs(attr(rsp_res, \"rotation\"), attr(ade_res, \"rotation\"), tail = TRUE,\n              title = \"Differences in eigenvectors, adespatial vs. RSpectra, negative\")\n\n\n\n\nThe differences are well below epsilon for all 30 PCs on both ends of the spectrum, mostly below 1e-14, i.e.¬†can be accounted for by machine precision (the dashed line around 1.5e-8). The difference somewhat increases for eigenvalues with smaller absolute values, but still well below epsilon.\nCompare the cell embeddings, first for positive eigenvalues: In theory, because the eigenvectors are the same (allowing for flipping) and the embeddings are found by the dot product of the gene expression profile of each cell with each PC, the embeddings should be the same. However, I‚Äôm plotting the differences here just in case adespatial does something extra behind the scene.\n\nplot_pc_diffs(rsp_res, ade_res,\n              title = \"Differences in embeddings, adespatial vs. RSpectra, positive\")\n\n\n\n\n\nplot_pc_diffs(rsp_res, ade_res, tail = TRUE,\n              title = \"Differences in embeddings, adespatial vs. RSpectra, negative\")\n\n\n\n\nThe embeddings are also well below epsilon and the differences have the same patterns as those of eigenvectors, so adespatial simply computed the dot product without doing anything else. So in conclusion, my RSpectra implementation gives consistent results as the adespatial implementation but 80 times faster without optimized BLAS and 4 times faster with optimized BLAS.\nThat said, the adespatial implementation allows for different column and row weighting for other types of duality diagram multivariate analyses. For now, I‚Äôm only concerned with PCA, so my implementation is simplified.\n\n\nBenchmark\nSince the default is non-optimized BLAS and those using a server most likely can‚Äôt change the BLAS, I perform the benchmark without optimized BLAS. I use different sized bounding boxes to spatially subset the data and compare the time and memory usage of the two implementations of MULTISPATI, with 30 most positive and 30 most negative eigenvalues. This dataset has 385 genes, which should not make this benchmark irrelevant because in spatial transcriptomics, the datasets with the most cells come from smFISH based methods such as MERFISH, which typically have a few hundred curated genes. Transcriptome wide datasets with hundreds of thousands of cells or spots are less common, but with subcellular NGS based methods such as PIXEL-seq and Stereo-seq, these datasets may be coming. MULTISPATI is a spatial method.\nHere I get the sizes of boxes spanning orders of magnitude, to get a wide range of numbers of cells:\n\n(diffs <- 2^seq(7, 13, length.out = 7))\n\n[1]  128  256  512 1024 2048 4096 8192\n\n\nHere I run the benchmark using the different sized subsets. I‚Äôm not checking if the results match here as is default in bench::mark(), because I have already checked, and because the eigenvectors can be flipped so the comparison is more involved than all.equal(). Both time and memory usage are recorded.\n\nbenchmark_multispati <- function(sfe, diff) {\n    xmin <- 3000\n    ymin <- 3000\n    bbox <- st_as_sfc(st_bbox(c(xmin = xmin, ymin = ymin, \n                                xmax = xmin + diff, ymax = ymin + diff)))\n    inds <- st_intersects(centroids(sfe), bbox, sparse = FALSE)\n    sfe_sub <- sfe[,inds]\n    colGraph(sfe_sub, \"knn\") <- findSpatialNeighbors(sfe_sub, method = \"knearneigh\",\n                                                     k = 5, dist_type = \"idw\", \n                                                     style = \"W\")\n    df <- bench::mark(adespatial = calc_multispati_ade(sfe_sub, \"knn\"),\n                      rspectra = calc_multispati_rspectra(sfe_sub, \"knn\"),\n                      max_iterations = 1, check = FALSE)\n    df$ncells <- ncol(sfe_sub)\n    df\n}\n\nReformat the results for plotting:\n\nif (!file.exists(\"benchmark_res.rds\")) {\n    benchmark_res <- map_dfr(diffs, benchmark_multispati, sfe = sfe)\n    benchmark_res <- benchmark_res |> \n        mutate(expression = as.character(expression),\n               mem_alloc = as.numeric(mem_alloc)/(1024^2))\n    saveRDS(benchmark_res, \"benchmark_res.rds\")\n} else {\n    benchmark_res <- readRDS(\"benchmark_res.rds\")\n}\n\n\n# Get colorblind friendly palette\ndata(\"ditto_colors\")\n\nHere I plot the time taken vs.¬†the number of cells for both implementations:\n\nggplot(benchmark_res, aes(ncells, total_time, color = expression)) +\n    geom_line() +\n    scale_x_log10() +\n    annotation_logticks() +\n    labs(x = \"Number of cells\", y = \"Time\", color = \"Implementation\") +\n    scale_color_manual(values = ditto_colors)\n\n\n\n\nWhen run non-interactively in this benchmark, both implementations were much faster than the initial profiles above. But RSpectra is overall an order of magnitude faster than adespatial, though the gap shrinks with increasing number of cells, from over 20 times faster at around 100 cells to about 7 times faster at over 200,000 cells. For 200,000 cells, adespatial took 50 seconds when run non-interactively, while RSpectra took 7.79 seconds.\nAlso plot memory usage vs.¬†number of cells:\n\nggplot(benchmark_res, aes(ncells, mem_alloc, color = expression)) +\n    geom_line() +\n    scale_x_log10() +\n    scale_y_log10(breaks = scales::breaks_log()) +\n    annotation_logticks() +\n    labs(x = \"Number of cells\", y = \"Memory (MB)\", color = \"Implementation\") +\n    scale_color_manual(values = ditto_colors)\n\n\n\n\nRSpectra also uses about 7 times less memory than adespatial across different number of cells. For the largest subset, with over 200,000 cells, adespatial used 36 GB of RAM, while RSpectra used about 5.2 GB, so while the latter can be run on my laptop, the former cannot.\nSo the RSpectra implementation of MULTISPATI looks promising. It will be added to Voyager for the Bioconductor 3.17 release. In addition, I should modify the PCA-related plotting functions in Voyager to improve user experiences around negative eigenvalues. In the sequel of this post, I‚Äôll apply the now more scalable MULTISPATI PCA to the entire dataset with nearly 400,000 cells and try to do some biological interpretations.\n\n\nSession info\n\nsessionInfo()\n\nR version 4.2.1 (2022-06-23)\nPlatform: x86_64-redhat-linux-gnu (64-bit)\nRunning under: CentOS Stream 8\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblaso-r0.3.12.so\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] SpatialFeatureExperiment_1.1.5 Matrix_1.5-3                  \n [3] spdep_1.2-8                    spData_2.2.2                  \n [5] profvis_0.3.7                  scran_1.26.1                  \n [7] scater_1.27.3                  scuttle_1.8.4                 \n [9] SingleCellExperiment_1.20.1    SummarizedExperiment_1.28.0   \n[11] Biobase_2.58.0                 GenomicRanges_1.50.2          \n[13] GenomeInfoDb_1.34.9            IRanges_2.32.0                \n[15] S4Vectors_0.36.2               BiocGenerics_0.44.0           \n[17] MatrixGenerics_1.10.0          matrixStats_0.63.0            \n[19] sf_1.0-12                      bench_1.1.2                   \n[21] lubridate_1.9.2                forcats_1.0.0                 \n[23] stringr_1.5.0                  dplyr_1.1.1                   \n[25] purrr_1.0.1                    readr_2.1.4                   \n[27] tidyr_1.3.0                    tibble_3.2.1                  \n[29] ggplot2_3.4.1                  tidyverse_2.0.0               \n[31] RSpectra_0.16-1                SFEData_1.1.1                 \n[33] adespatial_0.3-21              ade4_1.7-22                   \n[35] Voyager_1.1.10                \n\nloaded via a namespace (and not attached):\n  [1] utf8_1.2.3                    R.utils_2.12.2               \n  [3] tidyselect_1.2.0              RSQLite_2.3.0                \n  [5] AnnotationDbi_1.60.0          htmlwidgets_1.6.1            \n  [7] grid_4.2.1                    BiocParallel_1.32.6          \n  [9] RNeXML_2.4.11                 DropletUtils_1.18.1          \n [11] ScaledMatrix_1.6.0            munsell_0.5.0                \n [13] codetools_0.2-19              units_0.8-1                  \n [15] statmod_1.5.0                 interp_1.1-3                 \n [17] withr_2.5.0                   colorspace_2.1-0             \n [19] filelock_1.0.2                knitr_1.42                   \n [21] uuid_1.1-0                    rstudioapi_0.14              \n [23] wk_0.7.2                      labeling_0.4.2               \n [25] GenomeInfoDbData_1.2.9        farver_2.1.1                 \n [27] bit64_4.0.5                   rhdf5_2.42.0                 \n [29] vctrs_0.6.1                   generics_0.1.3               \n [31] xfun_0.37                     timechange_0.2.0             \n [33] BiocFileCache_2.6.1           adegenet_2.1.10              \n [35] adephylo_1.1-13               R6_2.5.1                     \n [37] ggbeeswarm_0.7.1              rsvd_1.0.5                   \n [39] locfit_1.5-9.7                bitops_1.0-7                 \n [41] rhdf5filters_1.10.0           cachem_1.0.7                 \n [43] DelayedArray_0.24.0           promises_1.2.0.1             \n [45] scales_1.2.1                  beeswarm_0.4.0               \n [47] gtable_0.3.3                  phylobase_0.8.10             \n [49] beachmat_2.14.0               rlang_1.1.0                  \n [51] splines_4.2.1                 scico_1.3.1                  \n [53] BiocManager_1.30.20           s2_1.1.2                     \n [55] yaml_2.3.7                    reshape2_1.4.4               \n [57] httpuv_1.6.9                  tools_4.2.1                  \n [59] SpatialExperiment_1.8.1       ellipsis_0.3.2               \n [61] RColorBrewer_1.1-3            proxy_0.4-27                 \n [63] Rcpp_1.0.10                   plyr_1.8.8                   \n [65] sparseMatrixStats_1.10.0      progress_1.2.2               \n [67] zlibbioc_1.44.0               classInt_0.4-9               \n [69] RCurl_1.98-1.10               prettyunits_1.1.1            \n [71] deldir_1.0-6                  viridis_0.6.2                \n [73] ggrepel_0.9.3                 cluster_2.1.4                \n [75] magrittr_2.0.3                magick_2.7.4                 \n [77] ggnewscale_0.4.8              hms_1.1.2                    \n [79] patchwork_1.1.2               mime_0.12                    \n [81] evaluate_0.20                 xtable_1.8-4                 \n [83] XML_3.99-0.13                 jpeg_0.1-10                  \n [85] gridExtra_2.3                 compiler_4.2.1               \n [87] KernSmooth_2.23-20            crayon_1.5.2                 \n [89] R.oo_1.25.0                   htmltools_0.5.4              \n [91] mgcv_1.8-42                   later_1.3.0                  \n [93] tzdb_0.3.0                    DBI_1.1.3                    \n [95] ExperimentHub_2.6.0           dbplyr_2.3.2                 \n [97] MASS_7.3-58.2                 rappdirs_0.3.3               \n [99] boot_1.3-28.1                 permute_0.9-7                \n[101] cli_3.6.1                     adegraphics_1.0-18           \n[103] R.methodsS3_1.8.2             metapod_1.6.0                \n[105] parallel_4.2.1                igraph_1.4.1                 \n[107] pkgconfig_2.0.3               rncl_0.8.7                   \n[109] sp_1.6-0                      xml2_1.3.3                   \n[111] vipor_0.4.5                   dqrng_0.3.0                  \n[113] XVector_0.38.0                digest_0.6.31                \n[115] vegan_2.6-4                   Biostrings_2.66.0            \n[117] rmarkdown_2.20                edgeR_3.40.2                 \n[119] DelayedMatrixStats_1.20.0     curl_5.0.0                   \n[121] shiny_1.7.4                   rjson_0.2.21                 \n[123] lifecycle_1.0.3               nlme_3.1-162                 \n[125] jsonlite_1.8.4                Rhdf5lib_1.20.0              \n[127] BiocNeighbors_1.16.0          seqinr_4.2-23                \n[129] viridisLite_0.4.1             limma_3.54.2                 \n[131] fansi_1.0.4                   pillar_1.9.0                 \n[133] lattice_0.20-45               KEGGREST_1.38.0              \n[135] fastmap_1.1.1                 httr_1.4.5                   \n[137] interactiveDisplayBase_1.36.0 glue_1.6.2                   \n[139] png_0.1-8                     bluster_1.8.0                \n[141] BiocVersion_3.16.0            bit_4.0.5                    \n[143] class_7.3-21                  stringi_1.7.12               \n[145] HDF5Array_1.26.0              blob_1.2.4                   \n[147] BiocSingular_1.14.0           AnnotationHub_3.6.0          \n[149] latticeExtra_0.6-30           memoise_2.0.1                \n[151] irlba_2.3.5.1                 e1071_1.7-13                 \n[153] ape_5.7-1"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html",
    "title": "Voyager 1.2.0",
    "section": "",
    "text": "Space, the current frontier. These are the voyages of starship Voyager. This is the second release of R package Voyager with the Bioconductor 3.17 release. I miss starship Voyager1 and its awesome voyages in geographical space, and if it can think it probably also misses me Captain Lambda Janeway. Because I spent my time turning geospatial ideas from starship Voyager into new features in R package Voyager, which I‚Äôm announcing here.\nIn addition, we are getting more like the USS Voyager crew in Star Trek ‚Äì we now have a team working on this project after the first release. While I‚Äôm still pretty much the only author of the code, the team made awesome contributions to the vignettes and documentation website.\nYou can install the new release from Bioconductor, and note that R 4.3 is required:\nThis will also install SpatialFeatureExperiment (SFE), an S4 class that brings Simple Feature to SpatialExperiment and SingleCellExperiment (SCE). Voyager to SFE is just like scater and scran to SCE and Seurat to SeuratObject, performing exploratory spatial data analysis (ESDA) and data visualization based on the data structure SFE. The SFEData package is for example datasets used extensively in Voyager‚Äôs vignettes, code examples, and some unit tests.\nFirst load the packages used to demonstrate the new features; all of these packages are imported or suggested by Voyager unless noted otherwise.\nThe mouse skeletal muscle Visium dataset from (McKellar et al. 2021) is used to demonstrate the new features:"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#plotting-the-image",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#plotting-the-image",
    "title": "Voyager 1.2.0",
    "section": "Plotting the image",
    "text": "Plotting the image\nIf the SFE object has images, they can be plotted behind geometries in all functions that plot geometries, so histology can be seen. However, note that doing so can change color perception of the palette that colors the geometries. For example, we can plot the image when plotting gene expression just like in Seurat, although I personally don‚Äôt like using a divergent palette as in Seurat while the variable plotted does not have a meaningful divergence. The argument image_id must be specified to plot an image.\n\nplotSpatialFeature(sfe, c(\"Myh2\", \"Ftl1\"), image_id = \"lowres\", maxcell = 5e4,\n                   swap_rownames = \"symbol\")\n\n\n\n\nThe maxcell argument is the maximum of pixels to plot in the image; if the image has more pixels than this then it will be downsampled to speed up plotting. A lower number is recommended when plotting many genes in multiple panels because a lower resolution is sufficient for the small size of the panels.\nPlot the image with dimension reduction:\n\nspatialReducedDim(sfe, \"multispati\", ncomponents = 2, image_id = \"lowres\",\n                  maxcell = 5e4, divergent = TRUE, diverge_center = 0)\n\n\n\n\n\nplotGeometry()\nOr just plot the geometries without coloring. The plotGeometry() function was introduced to cut boiler plate and to make it easier to plot geometries from multiple samples in different facets.\n\nplotGeometry(sfe, \"spotPoly\", image_id = \"lowres\") +\n    plotGeometry(sfe, \"spotPoly\")"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#dark-theme",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#dark-theme",
    "title": "Voyager 1.2.0",
    "section": "Dark theme",
    "text": "Dark theme\nWe introduced the dark theme to make plots more visually appealing when the background is a fluorescent image, but it can be used without an image as well. In the light theme, as used above, higher values have darker color, as if staining. In divergent palettes, the diverge center has a light color to emphasize values away from the center. In the dark theme, higher values have lighter color as if glowing, and in divergent palettes, the diverge center has a dark color to emphasize values away from the center.\nHere we plot a gene from the MERFISH dataset, with light theme:\n\nplotSpatialFeature(sfe_mer, \"Aldh3a2\", colGeometryName = \"cellSeg\",\n                   image_id = \"PolyT\", exprs_values = \"counts\", \n                   alpha = 0.7) # though the cells are covered up\n\n\n\n\nThe darker color for higher value gets harder to see with the dark image background. Here‚Äôs the dark theme:\n\nplotSpatialFeature(sfe_mer, \"Aldh3a2\", colGeometryName = \"cellSeg\",\n                   image_id = \"PolyT\", exprs_values = \"counts\", \n                   alpha = 0.7, dark = TRUE)\n\n\n\n\nThe higher values have lighter color so get more emphasized.\nFrom the first release, Voyager can plot a feature associated with a column (cell or Visium spot) geometry and a feature associated with an annotation (e.g.¬†myofibers) geometry simultaneously, with different palettes. While the individual palettes are designed to be colorblind friendly, it‚Äôs much more difficult to make the combination of two palettes colorblind friendly, but I tried pick palettes to distinct colors so they are less likely to get mixed up. The light theme has 2 default linear palettes, one for the column geometries and one for annotation geometries and 2 divergent palettes. The dark theme also has 2 default linear palettes and 2 divergent palettes, chosen from the scico package. In divergent palettes, warm colors denote values higher than the center, and cool colors denote values lower than the center. Here we use the two palettes on light and dark theme:\n\np1 <- plotSpatialFeature(sfe, \"Myh2\", colGeometryName = \"spotPoly\", \n                         annotGeometryName = \"myofiber_simplified\", \n                         annot_aes = list(fill = \"area\"), \n                         aes_use = \"color\", # plot empty circles to not to cover\n                         fill = NA, swap_rownames = \"symbol\", linewidth = 0.5)\np2 <- plotSpatialFeature(sfe, \"Myh2\", colGeometryName = \"spotPoly\", \n                         annotGeometryName = \"myofiber_simplified\", \n                         annot_aes = list(fill = \"area\"), aes_use = \"color\",\n                         fill = NA, swap_rownames = \"symbol\", linewidth = 0.5,\n                         dark = TRUE)\np1 + p2\n\n\n\n\nAlso to show the divergent palettes; the myofiber areas don‚Äôt have meaninful divergence, but a divergent palette is used just to show both divergent palettes. Whether to use divergent palette needs to be set separately for colGeometry and annotGeometry, because as in this case, one can have meaningful divergence while the other does not.\n\narea_median <- median(annotGeometry(sfe, \"myofiber_simplified\")$area)\np1 <- spatialReducedDim(sfe, \"multispati\", components = 2, \n                        colGeometryName = \"spotPoly\",\n                        annotGeometryName = \"myofiber_simplified\", \n                        annot_aes = list(fill = \"area\"), aes_use = \"color\",\n                        fill = NA, swap_rownames = \"symbol\", linewidth = 0.5,\n                        divergent = TRUE, diverge_center = 0,\n                        annot_divergent = TRUE, \n                        annot_diverge_center = area_median)\np2 <- spatialReducedDim(sfe, \"multispati\", components = 2, \n                        colGeometryName = \"spotPoly\",\n                        annotGeometryName = \"myofiber_simplified\", \n                        annot_aes = list(fill = \"area\"), aes_use = \"color\",\n                        fill = NA, swap_rownames = \"symbol\", linewidth = 0.5,\n                        divergent = TRUE, diverge_center = 0,\n                        annot_divergent = TRUE, \n                        annot_diverge_center = area_median,\n                        dark = TRUE)\np1 + p2\n\n\n\n\nAgain, just like when plotting the image behind the geometries, plotting with two color palettes can distort color perception of either palette and can result into colors from different palettes that are hard to tell apart, so use with caution."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#zoom-into-a-bounding-box",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#zoom-into-a-bounding-box",
    "title": "Voyager 1.2.0",
    "section": "Zoom into a bounding box",
    "text": "Zoom into a bounding box\nSome spatial -omics dataset cover large areas of tissue. Moreover, there are different length scales of spatial dependence. Plotting the entire tissue will make the smaller scale spatial patterns more difficult to see. So we introduced the bbox argument in all functions that plot the geometry, to zoom into a small area.\nFirst specify a bounding box, which should be a named numeric vector:\n\nbbox_use <- c(xmin = 6000, xmax = 8000, ymin = 10000, ymax = 12000)\n\nThen plot as usual:\n\nspatialReducedDim(sfe, \"multispati\", ncomponents = 2, image_id = \"lowres\",\n                  divergent = TRUE, diverge_center = 0, bbox = bbox_use)"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#deprecate-plotcoldatabin2d",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#deprecate-plotcoldatabin2d",
    "title": "Voyager 1.2.0",
    "section": "Deprecate plotColDataBin2D()",
    "text": "Deprecate plotColDataBin2D()\nThe first release has functions plotColDataBin2D() and plotRowDataBin2D() to avoid overplotting when there are so many cells or genes that the numerous points in the scatter plot form solid black blocks whose density can‚Äôt be discerned.\n\nplotColDataBin2D(sfe, x = \"nCounts\", y = \"nGenes\", bins = 50, hex = TRUE)\n\nWarning: plotCol/RowDataBin2D() was deprecated in Voyager 1.2.0.\n‚Ñπ Please use scater::plotCol/RowData() instead.\n‚Ñπ Set `bins` argument to enable binning.\n\n\n\n\n\nThese functions are deprecated in Voyager 1.2.0, because they are now part of scater in Bioconductor 3.17:\n\nplotColData(sfe, x = \"nCounts\", y = \"nGenes\", bins = 50, hex = TRUE) +\n    # Change palette\n    scale_fill_distiller(palette = \"Blues\", direction = 1)\n\nScale for fill is already present.\nAdding another scale for fill, which will replace the existing scale.\n\n\n\n\n\nWhen bins = NULL, which is the default, the points are plotted. I find scater a more appropriate place for these functions because they apply to SingleCellExperiment in general and are irrelevant to plotting in histological space. It should not be necessary for users who analyze non-spatial scRNA-seq data to install Voyager just for this function."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#gene-symbols-vs.-ensembl-ids",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#gene-symbols-vs.-ensembl-ids",
    "title": "Voyager 1.2.0",
    "section": "Gene symbols vs.¬†Ensembl IDs",
    "text": "Gene symbols vs.¬†Ensembl IDs\nSometimes different Ensembl IDs match the same gene symbol. It‚Äôs better to perform the analysis on Ensembl IDs because they more unambiguously refer to a certain genomic region than gene symbols. Furthermore, gene symbols often have alises. However, it would be nice to show the more human readable gene symbols on plots.\nIn version 1.2.0, we introduced the swap_rownames argument, to be consistent with scater‚Äôs plotting functions, whenever one may wish to use gene symbols to query data while the underlying data has Ensembl IDs. This includes localResult() getters in SFE, calculateUnivariate(), runUnivariate(), calculateBivariate(), runBivariate(), all plotting functions that can plot gene information, and plotting functions of spatial analysis results of gene expression. This is already used in the sections above.\nIn the previous release, whether to show gene symbol was indicated by the show_symbol argument and the column in rowData(sfe) for gene symbols is assumed to be named ‚Äúsymbol‚Äù. Now show_symbol is deprecated, as swap_rownames allows any name of the symbol column and makes it explicit when gene symbols are plotted while the data uses Ensembl IDs. A warning is issued when a gene symbol matches multiple Ensembl IDs.\nIn addition, calculateUnivariate() and calculateBivariate() can return gene symbols in the results with swap_rownames specified even if the input features argument is Ensembl IDs."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#multiple-results-from-the-same-method",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#multiple-results-from-the-same-method",
    "title": "Voyager 1.2.0",
    "section": "Multiple results from the same method",
    "text": "Multiple results from the same method\nIn the previous release, the standard name of the method (name column in listSFEMethods() output) is used to store results. However, sometimes one may wish to run the same method on the same genes but with different parameters and compare the results. Doing so will overwrite the existing results with different parameters.\nIn this release, we allow users to specify the name under which to store the results, with the name argument in runUnivariate() and runBivariate() so results from the same method but different parameters can coexist in the same SFE object. The standard name is used by default.\nIn addition, the parameters are stored and checked the next time the same method is run. There‚Äôs the argument overwrite, to indicate whether to overwrite existing results when the new results were generated from different parameters. If overwrite = FALSE, then runUnivariate() or runBivariate() will throw an error when there‚Äôs existing results under the same name but with different parameters. Note that overwrite was introduced in a bug fix after 1.2.0. There already is Voyager 1.2.2 as I discovered some bugs last night after the creation of the RELEASE_3_17 branch on Bioconductor.\nHere is an example of using different names:\n\n# Getis-Ord Gi*\nsfe <- runUnivariate(sfe, \"localG\", features = c(\"Myh1\", \"Ftl1\"), \n                     include_self = TRUE, swap_rownames = \"symbol\")\n\n\n# Getis-Ord Gi, no star\n# Will throw error\nsfe <- runUnivariate(sfe, \"localG\", features = c(\"Myh1\", \"Ftl1\"), \n                     include_self = FALSE, swap_rownames = \"symbol\")\n\n\n# Works\nsfe <- runUnivariate(sfe, \"localG\", features = c(\"Myh1\", \"Ftl1\"), \n                     include_self = FALSE, swap_rownames = \"symbol\",\n                     name = \"Gi\")\n\n\np1 <- plotLocalResult(sfe, \"localG\", features = c(\"Myh1\", \"Ftl1\"),\n                      colGeometryName = \"spotPoly\",\n                      image_id = \"lowres\", maxcell = 5e4,\n                      swap_rownames = \"symbol\", divergent = TRUE,\n                      diverge_center = 0)\np2 <- plotLocalResult(sfe, \"Gi\", features = c(\"Myh1\", \"Ftl1\"),\n                      colGeometryName = \"spotPoly\",\n                      image_id = \"lowres\", maxcell = 5e4,\n                      swap_rownames = \"symbol\", divergent = TRUE,\n                      diverge_center = 0)\np1 / p2 + plot_annotation(tag_levels = \"A\")\n\n\n\n\nTop row, A and B: Getis-Ord Gi*, bottom row, C and D: Getis-Ord Gi, the results are similar"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#faster-distance-based-edge-weights",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#faster-distance-based-edge-weights",
    "title": "Voyager 1.2.0",
    "section": "Faster distance based edge weights",
    "text": "Faster distance based edge weights\nNewer versions of spdep support distance based edge weights, such as inverse distance weighting. However, spdep‚Äôs distance based edge weights is very inefficient, because spdep does not keep the distance among neighbors returned by dbscan (which is very efficient) when computing k nearest or distance based neighbors, so when computing the edge weights, spdep has to call st_distance() to re-compute the distances, which can be very time consuming.\nIn SpatialFeatureExperiment 1.2.0, we use BiocNeighbors to find k nearnest and distance based neighbors, which has a uniform user interface for multiple neighbor finding algorithms such as Annoy, Hnsw, and etc. We also keep the distances returned by BiocNeighbors to calculate distance based edge weights. All the distance weighting methods in spdep are supported.\nHere is a benchmark:\n\nres <- \n    bench::mark(\n        bioc = {\n            g <- findSpatialNeighbors(\n                sfe, type = \"myofiber_simplified\", \n                MARGIN = 3L,\n                method = \"knearneigh\", dist_type = \"idw\",\n                style = \"W\", nn_method = \"bioc\"\n            )\n        },\n        spdep = {\n            g2 <- findSpatialNeighbors(\n                sfe, type = \"myofiber_simplified\", \n                MARGIN = 3L,\n                method = \"knearneigh\", dist_type = \"idw\",\n                style = \"W\", nn_method = \"spdep\"\n            )\n        },\n        # Attributes like call from spdep don't matter\n        check = function(x,y) all.equal(x,y, check.attributes = FALSE)\n    )\n\nWarning: Some expressions had a GC in every iteration; so filtering is\ndisabled.\n\n\n\nres\n\n# A tibble: 2 √ó 6\n  expression      min   median `itr/sec` mem_alloc `gc/sec`\n  <bch:expr> <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>\n1 bioc       124.56ms  127.2ms     7.83         NA     0   \n2 spdep         1.99s    1.99s     0.502        NA     1.51\n\n\n\nplot(res) +\n    annotation_logticks(sides = \"b\")\n\n\n\n\nThe impementation in SFE is an order of magnitude faster than the one in spdep. Also, while the spdep implementation performed garbage collection (gc), the SFE method did not."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#reduceddimunivariate",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#reduceddimunivariate",
    "title": "Voyager 1.2.0",
    "section": "reducedDimUnivariate()",
    "text": "reducedDimUnivariate()\nWhen comparing non-spatial PCA to MULTISPATI PCA, I would like to compute Moran‚Äôs I on the cell embeddings in each PC. This led to reducedDimUnivariate() and reducedDimMoransI() is a convenience wrapper just like runMoransI() for gene expression. In Voyager, there is already colDataUnivariate(), colGeometryUnivariate(), and annotGeometryUnivariate() to compute univariate statistics for data outside gene expression. The results can be accessed with reducedDimFeatureData(), which is analogous to colFeatureData() for spatial results for colData(sfe), which is a DataFrame each column of which is one kind of results and each row is a feature. Here I compute Moran‚Äôs I for MULTISPATI PC‚Äôs:\n\nsfe <- reducedDimMoransI(sfe, dimred = \"multispati\", components = 1:40)\n\n\ndf_hlines <- tibble(y = c(0, mb),\n                    lty = c(\"a\", \"b\", \"b\"))\n\nHere we plot Moran‚Äôs I for each MULTISPATI PC computed. PCs 1-20 have positive eigenvalues, and 21-40 have negative eigenvalues; there should be over 900 something PCs from full spectrum decomposition, but only the 20 most positive and negative components were computed.\n\ntibble(moran = reducedDimFeatureData(sfe, \"multispati\")$moran_Vis5A,\n       index = 1:40, \n       sign = case_when(\n           index > 20 ~ \"n\",\n           index <= 20 ~ \"p\"\n       )) |> \n    ggplot() +\n    geom_line(aes(index, moran, group = sign)) +\n    geom_hline(aes(yintercept = y, linetype = lty), data = df_hlines,\n               show.legend = FALSE)\n\n\n\n\nThe dashed line shows the bounds of Moran‚Äôs I given the spatial neighborhood graph.\nWhen it comes to dimension reduction, if a univariate method is applied to the components and there is a plotting function for the results, the results for each component will be plotted in a sequential palette:\n\nsfe <- reducedDimUnivariate(sfe, \"sp.correlogram\", dimred = \"multispati\",\n                            components = 1:4, order = 5)\n\n\nplotCorrelogram(sfe, features = 1:4, reducedDimName = \"multispati\")"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#sfe-object-versions",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#sfe-object-versions",
    "title": "Voyager 1.2.0",
    "section": "SFE object versions",
    "text": "SFE object versions\nThe SCE object has gone through multiple versions, and has a updateObject() method to update older versions of SCE objects. As SFE is still quite new, I anticipate that it will change in the future. For example, I‚Äôm thinking about reimplementing the spatialGraphs with sfdep so the edge list can be decoupled from edge weights, because for larger datasets, it can be time consuming to find the edges, such as from triangulation followed by pruning, so it would be nice to not to recompute the edges if one wants to change a weighting scheme. Furthermore, I would also like to use udunits for the spatial length units so we can convert units. These will lead to new versions of the SFE object.\nFor now, I haven‚Äôt made these changes yet, except that the object version is stored in the object; if the version is absent, then it will be the current version of SFE package:\n\nSFEVersion(sfe)\n\n[1] '1.2.1'"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#listsfemethods",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#listsfemethods",
    "title": "Voyager 1.2.0",
    "section": "listSFEMethods()",
    "text": "listSFEMethods()\nIn Voyager 1.2.0 we added the listSFEMethods() function to show all spatial methods implemented in Voyager. For instance, to show all univariate global methods, use\n\nlistSFEMethods(\"uni\", \"global\")\n\n             name                                           description\n1           moran                                             Moran's I\n2           geary                                             Geary's C\n3        moran.mc                    Moran's I with permutation testing\n4        geary.mc                    Geary's C with permutation testing\n5    sp.mantel.mc Mantel-Hubert spatial general cross product statistic\n6      moran.test                                        Moran's I test\n7      geary.test                                        Geary's C test\n8    globalG.test                                         Global G test\n9  sp.correlogram                                           Correlogram\n10      variogram                                  Variogram with model\n11  variogram_map                                         Variogram map\n\n\nWhen calling a function like calculate*variate() or run*variate(), the type (2nd) argument should match an entry in the name column.\nThese are all univariate local methods:\n\nlistSFEMethods(\"uni\", \"local\")\n\n              name                                          description\n1       localmoran                                      Local Moran's I\n2  localmoran_perm                  Local Moran's I permutation testing\n3           localC                                      Local Geary's C\n4      localC_perm                  Local Geary's C permutation testing\n5           localG                                      Getis-Ord Gi(*)\n6      localG_perm             Getis-Ord Gi(*) with permutation testing\n7             LOSH                     Local spatial heteroscedasticity\n8          LOSH.mc Local spatial heteroscedasticity permutation testing\n9          LOSH.cs     Local spatial heteroscedasticity Chi-square test\n10      moran.plot                                   Moran scatter plot"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#multivariate",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#multivariate",
    "title": "Voyager 1.2.0",
    "section": "Multivariate",
    "text": "Multivariate\nThe first release of Voyager only supported univariate spatial methods. However interesting the results may be, nobody wants to manually check local Moran‚Äôs I results for thousands of genes. Furthermore, there are gene programs and co-expression modules, which univariate methods miss. Voyager 1.2.0 added multivariate spatial data analysis methods, including MULTISPATI PCA (Dray, Saƒ±Ãàd, and D√©bias 2008) (a spatially informed version of PCA) and multivariate local Geary‚Äôs C (Anselin 2019). These are all the multivariate methods:\n\nlistSFEMethods(\"multi\")\n\n               name                                      description\n1        multispati                                   MULTISPATI PCA\n2      localC_multi                     Multivariate local Geary's C\n3 localC_perm_multi Multivariate local Geary's C permutation testing\n\n\nIn the first release, I created a uniform user interface, calculateUnivariate() and runUnivariate() to call a variety of spatial analysis methods. Multivariate methods also have a uniform user interface in calculateMultivariate() to directly return the results, and runMultivariate() to store the results in reducedDims(sfe), or if applicable, colData(sfe).\nHere we run MULTISPATI PCA with 20 positive and 20 negative eigenvalues on highly variable genes:\n\nhvgs <- getTopHVGs(sfe, n = 1000)\n\n\nsfe <- runMultivariate(sfe, \"multispati\", nfposi = 20, nfnega = 20,\n                       subset_row = hvgs)\n\nPlot the eigenvalues: The ElbowPlot() function has been updated to plot negative eigenvalues which signify negative spatial autocorrelation and to color and facet when a spatial dimension reduction is run on different samples (i.e.¬†tissue sections) separately.\n\nElbowPlot(sfe, ndims = 20, nfnega = 20, reduction = \"multispati\")\n\n\n\n\nPlot projections of Visium spot gene expression profiles into each MULTISPATI PC:\n\nspatialReducedDim(sfe, \"multispati\", 2, divergent = TRUE, diverge_center = 0)\n\n\n\n\nSee the MULTISPATI vignette for an intro to MULTISPATI PCA and more in depth discussions. Voyager has an implementation of MULTISPATI PCA based on RSpectra that is much faster than the original implementation in adespatial, to meet the demands to analyze larger spatial -omics data. It is efficient enough to be performed on over 390,000 cells in the MERFISH dataset shown in the MULTISPATI vignette. See benchmark here.\nRelated to MULTISPATI PCA is moranBounds(), which is a more efficient implementation of adespatial::moran.bounds() to find the upper and lower bounds of Moran‚Äôs I given a spatial neighborhood graph. Basically it diagonalizes the double centered adjacency matrix of the graph. However, because the double centered matrix is dense, this can take a lot of memory for larger datasets. Here we find the Moran bounds for this Visium dataset:\n\n(mb <- moranBounds(colGraph(sfe, \"visium\")))\n\n      Imin       Imax \n-0.5762132  1.0021884 \n\n\nUsually the lower bound is closer to -0.5 than -1, and negative Moran‚Äôs I should be interpreted accordingly."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#bivariate",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#bivariate",
    "title": "Voyager 1.2.0",
    "section": "Bivariate",
    "text": "Bivariate\nBivariate methods are used to explore pairwise relationships among genes while taking spatial autocorrelation into account. These are all the bivariate global methods:\n\nlistSFEMethods(\"bi\", \"global\")\n\n                 name                                     description\n1                 lee                       Lee's bivariate statistic\n2              lee.mc Lee's bivariate static with permutation testing\n3            lee.test                                    Lee's L test\n4     cross_variogram                                 Cross variogram\n5 cross_variogram_map                             Cross variogram map\n\n\nThese are all the bivariate local methods:\n\nlistSFEMethods(\"bi\", \"local\")\n\n           name                     description\n1      locallee Local Lee's bivariate statistic\n2 localmoran_bv       Local bivariate Moran's I\n\n\nJust like for univariate and multivariate methods, there is a uniform user interface to run various bivariate methods: calculateBivariate() to directly return the results and runBivariate() to store the results in localResults(sfe). Note that because bivariate global results have many different formats that might not be nicely stored in the SFE object, global bivariate methods can only be called with calculateBivariate(), while runBivariate() is only for bivariate local methods. Here we compute Lee‚Äôs L (Lee 2001) which comes from the similaries and diffences between Moran‚Äôs I and Pearson correlation to top HVGs:\n\nhvgs <- getTopHVGs(sfe, fdr.threshold = 0.01)\n\nBecause bivariate global results can have very different formats (matrix for Lee‚Äôs L and lists for many other methods), the results are not stored in the SFE object.\n\nres <- calculateBivariate(sfe, type = \"lee\", feature1 = hvgs)\n\nThis gives a spatially informed correlation matrix among the genes, which can be plotted as a heatmap:\n\npal_rng <- getDivergeRange(res)\npal <- scico(256, begin = pal_rng[1], end = pal_rng[2], palette = \"vik\")\n\n\npheatmap(res, color = pal, show_rownames = FALSE, \n         show_colnames = FALSE, cellwidth = 1, cellheight = 1)\n\n\n\n\nThe implementation of Lee‚Äôs L in Voyager is designed for making correlation matrices for a larger number of genes. It‚Äôs based on matrix operations and is much faster than the spdep implementation. See the bivariate vignette for more info and other bivariate methods."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#variogram",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#variogram",
    "title": "Voyager 1.2.0",
    "section": "Variogram",
    "text": "Variogram\nThe variogram is used to model the covariance function in kriging, which uses a Gaussian process model to interpolate between spatial observations in geostatistical data. The variogram can also be an ESDA tool to show length scale of spatial autocorrelation.\nThe variogram shows the variance of differences in values across a range of distances. When there is positive spatial autocorrelation, the variogram increases with distance, because spatial autocorrelation reduces variance among nearby locations, until it levels off, showing the distance where spatial autocorrelation no longer has an effect. It can also show spatial autocorrelation in different directions, when there‚Äôs anisotropy. The correlogram can also show different length scales of spatial autocorrelation, but it‚Äôs not scalable to larger spatial distances.\nHere we demonstrate variogram map on one gene. The variogram map shows the variogram in all directions.\n\nsfe <- runUnivariate(sfe, \"variogram_map\", features = \"Ftl1\",\n                     swap_rownames = \"symbol\", width = 500, cutoff = 3000)\n\nNote the swap_rownames argument. It was introduced in 1.2.0. In the first release, the column in rowData(sfe) for gene symbols when the row names are in fact Ensembl is assumed to be ‚Äúsymbol‚Äù, and the show_symbol argument is used to show the more human readable gene symbols while everything behind the scene is Ensembl IDs because the latter is more unambiguous. In 1.2.0, the show_symbol argument is deprecated, and any column can be specified in swap_rownames. This is elaborated on in the Miscellaneous section.\n\nplotVariogramMap(sfe, \"Ftl1\", swap_rownames = \"symbol\")\n\n\n\n\nHere the data is scaled by default before computing the variogram so the variograms of different genes are comparable. Here we see some anisotropy, that spatial autocorrelation decays more slowly in the east-west direction and more quickly in the northeast-southwest direction. See the variogram vignette for more details, and for bivariate cross variograms."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#run-your-own-spatial-methods-with-sfemethod",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#run-your-own-spatial-methods-with-sfemethod",
    "title": "Voyager 1.2.0",
    "section": "Run your own spatial methods with SFEMethod",
    "text": "Run your own spatial methods with SFEMethod\nThe uniform user interface in Voyager is inspired by caret and tidymodels (Kuhn and Wickham 2020) that provide a uniform user interface to many different machine learning methods from different R packages, the future (Bengtsson 2021), foreach, and BiocParallel packages for different parallel processing backends, and bluster for different clustering algorithms. This can greatly reduce redundant code and learning curve for the users.\nA bit more of Star Trek Voyager: We are the Borg, lower your shield and surrender your ship. You can now assimilate new spatial analysis methods. The SFEMethod S4 class was introduced so users can make Voyager run their own custom spatial analysis methods. The S4 class collects the function that runs the method, functions that reorganize the results to store in the SFE object, and metadata indicating characteristics of the methods. Build a new SFEMethod object for the custom method, and Voyager‚Äôs uniform interface can run the method and organize the results in the SFE object. See the SFEMethod vignette for how to construct an SFEMethod object."
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#images",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#images",
    "title": "Voyager 1.2.0",
    "section": "Images",
    "text": "Images\nThe images are read as SpatRaster objects from the terra R package, so the images are not loaded into memory unless necessary. When plotting, if the images are very large, they will not be entirely loaded into memory but will be downsampled if a lower resolution is sufficient. When converting a SpatialExperiment object to SFE, the existing images will be converted to SpatRaster.\nThis mouse skeletal muscle dataset was not originally in standard Space Ranger output format. Also, because the first release didn‚Äôt support images, the example datasets don‚Äôt have images. But the images can be read in later:\n\nsfe <- addImg(sfe, file = \"tissue_lowres_5a.jpeg\", sample_id = \"Vis5A\", \n              image_id = \"lowres\", \n              scale_fct = 1024/22208)\nsfe <- mirrorImg(sfe, sample_id = \"Vis5A\", image_id = \"lowres\")\n\nWe also implemented functions to transform the images, like mirrorImg, to flip the image because the origin is the top left in images but bottom left in the geometries in Cartesian coordinates.\nThe image is cropped when the SFE object is subsetted or cropped.\n\nterra::plot(imgRaster(getImg(sfe)))\n\n\n\n\nInitially we have the full image. Then the subsetting operation will crop it to the extent of the geometries:\n\nsfe <- sfe[,colnames(sfe)]\nterra::plot(imgRaster(getImg(sfe)))"
  },
  {
    "objectID": "posts/2023-04-26-voyager-1-2-0/index.html#spatial-statistics-on-dimension-reduction",
    "href": "posts/2023-04-26-voyager-1-2-0/index.html#spatial-statistics-on-dimension-reduction",
    "title": "Voyager 1.2.0",
    "section": "Spatial statistics on dimension reduction",
    "text": "Spatial statistics on dimension reduction\nWhen comparing non-spatial PCA to MULTISPATI PCA, I would like to compute Moran‚Äôs I on the cell embeddings in each PC. This led to reducedDimUnivariate() and reducedDimMoransI() is a convenience wrapper just like runMoransI() for gene expression. In Voyager, there is already colDataUnivariate(), colGeometryUnivariate(), and annotGeometryUnivariate() to compute univariate statistics for data outside gene expression. The results can be accessed with reducedDimFeatureData(), which is analogous to colFeatureData() for spatial results for colData(sfe), which is a DataFrame each column of which is one kind of results and each row is a feature. Here I compute Moran‚Äôs I for MULTISPATI PC‚Äôs:\n\nsfe <- reducedDimMoransI(sfe, dimred = \"multispati\", components = 1:40)\n\n\ndf_hlines <- tibble(y = c(0, mb),\n                    lty = c(\"a\", \"b\", \"b\"))\n\nHere we plot Moran‚Äôs I for each MULTISPATI PC computed. PCs 1-20 have positive eigenvalues, and 21-40 have negative eigenvalues; there should be 900 something PCs from full spectrum decomposition, but only the 20 most positive and negative components were computed.\n\ntibble(moran = reducedDimFeatureData(sfe, \"multispati\")$moran_Vis5A,\n       index = 1:40, \n       sign = case_when(\n           index > 20 ~ \"n\",\n           index <= 20 ~ \"p\"\n       )) |> \n    ggplot() +\n    geom_line(aes(index, moran, group = sign)) +\n    geom_hline(aes(yintercept = y, linetype = lty), data = df_hlines,\n               show.legend = FALSE)\n\n\n\n\nThe dashed line shows the bounds of Moran‚Äôs I given the spatial neighborhood graph.\nWhen it comes to dimension reduction, if a univariate method is applied to the components and there is a plotting function for the results, the results for each component will be plotted in a sequential palette:\n\nsfe <- reducedDimUnivariate(sfe, \"sp.correlogram\", dimred = \"multispati\",\n                            components = 1:4, order = 5)\n\n\nplotCorrelogram(sfe, features = 1:4, reducedDimName = \"multispati\")"
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "",
    "text": "Captain‚Äôs Log, stardate 100770.18, or Earth date March 4, 2023. I didn‚Äôt finish writing this until May because I‚Äôve been busy writing the second release of the R package Voyager and my thesis. Now that I have turned in my thesis, I can finally finish up the Captain‚Äôs Logs.\nI had a week of bad sleep, in large part due to the cold storm. I regret not using the heater. It sounds crazy, but many LA apartment buildings have heaters, because the buildings are often not very well-insulated and California law requires that a home must be able to sustain 70 degrees Farenheit in the winter. I have never used the heater because it burns gas and I try not to burn fossil fuels. Usually putting on more clothes would help. Except that I didn‚Äôt keep my feet warm enough. I got chilblains back in winter 2020. Basically the blood vessels in my toes vasoconstricted so hard that they broke themselves, so when my feet warm back up, my toes would get really itchy as blood flowed into the broken vessels. It went away, but would come back in subsequent winters, sometimes waking me up at night. While I would try to go to bed earlier, with Frozen Turkey locking myself out of my laptop, I still struggled to fall asleep, even with melatonin, because of my nocturnal circadian rhythm. When I finally fell asleep, I soon woke up from toe itch. As a result, I ended up with poor sleep.\nThe chilblains was gone. Yet I had another night of bad sleep. I knew that I had to get up at 6:30 and leave by around 7 am to get to the 8:30 am ride on time, so I tried to go to bed earlier but nevertheless couldn‚Äôt fall asleep until midnight. Initially I slept well, but sometime before 5 am, the siren and some really fast cars woke me up. I don‚Äôt know what was happening. It sounded like cops chasing a speeding driver. Or just emergency vehicles going fast for any reason just because the roads were empty. Then I couldn‚Äôt fall back asleep no matter what. So another zombie day."
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#the-climb",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#the-climb",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "The climb",
    "text": "The climb\n\n\n\nThe hike begins\n\n\nI definitely don‚Äôt want to hike in road cycling shoes, so I brought my hiking shoes in a large saddle bag meant for tents. We walked up a dirt trail, but eventually got to a paved road. It was steep. I got pretty good at sensing the grade. Much of the climb is at least 10%, and some parts, including the top part, at least 15%. Some of the ActiveSGV folks rode the GoSGV e-bikes. They did well though the riders still walked the bikes at times, but they were not out of breath. I wonder if I can ride all the way to the top without getting out of RAM and CPU; it can‚Äôt be that much worse than Baldy Village to Ski Lift, Wildwood Canyon, and Baldwin Hills Scenic Overlook, right? I survived those without getting out of RAM and CPU. But not now when I felt like a zombie.\n\n\n\nLooking back at the FedEx facility as we gained altitude\n\n\n\n\n\nWhittier Narrows dam, and DTLA way in the distance\n\n\n\n\n\nI was so behind! That‚Äôs a steep part ahead.\n\n\n\n\n\nSo this is where that smoke stack comes from. It‚Äôs not a fire at all, but a power station converting the landfill methane into electricity.\n\n\n\n\n\nI finally got to that steep part that feels likt 15%. Here some people were climbing with e-bikes, though they eventually also walked.\n\n\n\n\n\nLast steep part to the top"
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#at-the-top",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#at-the-top",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "At the top",
    "text": "At the top\nBecause I stopped for photos, I was among the last to arrive at the top of Nike Hill. There we had Mexican food for lunch. I‚Äôm glad that they had a vegan burrito with something like soyrizo, which I got. I also got salsa, tortilla chips, and jamaica. I sat down on the wood chipped ground to eat while soaking in the panoramic view of the SGV to the east. It was cloudy in the morning, but the sun was coming out.\n\n\n\nA couple enjoying the view of the SGV while having lunch; I sat near them.\n\n\n\n\n\nWhittier Narrows dam and DTLA from afar\n\n\n\n\n\nThe San Gabriel River, full after the storms\n\n\n\n\n\nNothing very remarkable about this photo in and of itself, but I need to show it because that white patch of buidings is downtown Pasadena where I live, and the hills to the left of the patch is the San Rafael Hills, which is popular among cyclists in the Verdugos and northwest SGV.\n\n\n\n\n\nThe landfill proper, I suppose, still closed to visitors\n\n\nWe got a raffle ticket when getting food, and the raffle was drawn while we were eating. The winners got outdoor gear such as backpacks and trekking poles. While I didn‚Äôt expect to get anything, I won a picnic blanket. As I wasn‚Äôt sure how to carry it on Voyager, I thought about giving it away.\n\n\n\nAnnouncing the raffle ticket\n\n\n\n\n\nHow I carried the picnic blanket; it looks awkward, but it works."
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#the-descent",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#the-descent",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "The descent",
    "text": "The descent\nBecause I arrived at the top late, I didn‚Äôt get to stay very long before we descended the hill, back to the park where we put our bikes. The folded blanket has a handle loop. Maybe I can put that through one of the saddle bag straps. It didn‚Äôt work. I ended up putting my handlebar Garmin mount through the loop so the blanket sat on Voyager‚Äôs handlebar and stem without adding much drag. It worked.\n\n\n\nLooking down that last steep part. Pretty steep, isn‚Äôt it?\n\n\n\n\n\nLooking back up people ascending the hill, and Whittier Narrows and DTLA in the distance\n\n\n\n\n\nAs I descended further, the DTLA skyline was partially hidden behind the Monterey Park hills\n\n\n\n\n\nThe Atompunk Rose Hills cemetery chapel. I would like to visit in my next trip to this region.\n\n\n\n\n\nEquestrians ascending, when we were almost at the bottom\n\n\n\n\n\nLooking back at our bikes\n\n\nIn order not to make a left turn out of that park onto a dangerous busy road, we walked down that muddy tunnel to a parking lot across the street, where we made a right turn to ride back to the Avocado Heights park as a group. The group got very stretched out. Dale and I were in the front of the pack and we had to wait at some point. Which is why there were multiple ride marshals to make sure that nobody was dropped."
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#san-jose-creek-and-san-gabriel-river",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#san-jose-creek-and-san-gabriel-river",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "San Jose Creek and San Gabriel River",
    "text": "San Jose Creek and San Gabriel River\nWe were back at the park. Then what? I originally planned a lot of climbing, to the Turnbull Canyon and Hacienda Heights, but my sleep deprivation caught up with me. I felt like a zombie and didn‚Äôt feel like climbing. So I headed straight to San Jose Creek, a tributary of the San Gabriel River, where there‚Äôs a bike path, which was after the climbs in my original plan. Again, there was a homeless encampment at the eastern end. I saw a horde of little birds in the river, covered by shallow water from side to side after the storm, and tried to take a photo. However, when I walked closer to get a better spot, the birds noticed and all flew away, so no photo.\n\n\n\nAt the east end of the San Jose Creek bike path\n\n\n\n\n\nHomeless encampment at the east end of San Jose Creek, which is fully lined with concrete\n\n\nI have ridden the full length of the San Gabriel River bike path from Azusa to Seal Beach (though not in one single trip), and have ridden as much of the LA River bike paths as possible from Canoga Park to Glendale Narrows to Maywood to Long Beach. I have also seen much of upstream parts in the Angeles National Forest. so I have seen a lot of the two great rivers of LA County. Overall, the San Gabriel River is much less clad in concrete as LA River. Arguably Santa Clara River north of the San Gabriel Mountains is a third great river of LA County. Santa Ana River could be another as it‚Äôs culturally relevant to the Tongva further to the east, although its watershed is almost all outside LA County. The arbitrary straight borders of LA County don‚Äôt make cultural and geographical sense.\nDue to the great 1938 flood, the LA River was channelized for flood control, which was completed in 1960. Among all of LA River and its tributaries downstream of the foothill dams (e.g.¬†Hansen Dam for Tujunga Wash, Devil‚Äôs Gate Dam for Arroyo Seco, Pacoima Reservoir for Pacoima Wash) I have visited, it‚Äôs almost all concrete, except for Sepulveda Basin, Glendale Narrows, Long Beach estuary where LA River empties into the ocean for the main LA River, a little stretch downstream of the Devil‚Äôs Gate Dam and a little beneath Colorado St Bridge for Arroyo Seco, a little bit of Compton Wash, and the Peck Rd Water Conservation Area and when entering the Whittier Narrows Dam for Rio Hondo.\nIn contrast, San Gabriel River is not channelized upstream of Rio San Gabriel Park in Downey, already downstream of Whittier Narrows, though it does have concrete banks to prevent it from changing course. As a result, I find the ride down San Gabriel River all the way to Seal Beach more interesting than the ride down Rio Hondo and LA River to Long Beach. I wonder if it‚Äôs because the Cogswell, San Gabriel, Morris, and Santa Fe Dams already do a good job for flood control upstream so more channelization is unnecessary, or the San Gabriel River watershed was less populated than the LA River watershed, or the San Gabriel River tends not to flood as badly as LA River. Nevertheless, the concrete channels of LA River can attract many birds and get quite interesting. Graffiti also livens up the concrete. I don‚Äôt know nearly as much about tributaries of the San Gabriel River south of Santa Fe Dam simply because they are too far east for me to visit very often.\n\n\n\nThe part of San Jose Creek where the concrete ended, which looks kind of like Glendale Narrows of LA River.\n\n\nBut this part of San Jose Creek was concrete. The concrete bottom soon ended, making the river look so much like the Glendale Narrows. Spatial statistics lesson: the importance of spatially structured covariates. This part of San Jose Creek is not connected to the Glendale Narrows, but they look similar because of the interaction between similar climates, landscapes, and riparian ecosystems. The bike paths add to the similarity. The similar climates and landscapes must interact with being rivers to create the similar looks. This is what creates the spatial autocorrelation in the river appearance. But how would I know had I not known the covariates? Suppose I partition LA into pixels and perform univariate spatial analyses for all variables I can think of. The variables for river ecosystems would show local negative spatial autocorrelation and high local spatial heteroscedasticity because the built communities on the banks of the rivers are very different from the river itself. However, if we compute Moran‚Äôs I only for the rivers, the results would be very different.\nMoral for histological space: I don‚Äôt think we can capture all relevant covariates from transcriptomics. Such covariates might be better captured by studying the extracellular matrix, metabolomics, proteomics, and etc. But sometimes we can get covariates from transcriptomics. Perhaps well-established cell type marker genes cab be used as covariates. For example, markers for blood vessels can be thought of as akin to marking which areas are rivers. What if we perform spatial analysis on different cell types separately, especially for the very distinctive ones like blood vessels? Now we have spatial transcriptomics datasets covering large tissue areas, with hundreds of thousands of cells. What are the length scales of spatial autocorrelation for genes, computed separately for very distinctive cell types? How do say blood vessels differ within the vast tissue section?\nIt‚Äôs somewhat like comparing rivers in SoCal. As of writing, I have already returned from the Green Fondo in Santa Barbara County. The Santa Ynez River, at least the parts I visited, was not channelized. Morphologically, and in terms of some of the plant species, it looks a lot like some of the upstream, unchannelized parts of Pacoima Wash, Big Tujunga Wash, Santa Clara River, San Gabriel River a little upstream of the San Gabriel Reservoir, some of modern Arroyo Seco, and some of Arroyo Seco and LA River in historical photos prior to channelization. But surely there are differences among those rivers. For example, the steep grades of the San Gabriel River washing rocks down gave rise to the Irwindale gravel pits, whose rocks were used to build many LA landmarks, and the Prado region of the Santa Ana River has distinctive clay used by Indigenous people for pottery. While I did see the familiar oak groves, California poppies, arroyo lupines, and invasive mustard that I also see in LA during Green Fondo, I saw a lot of small yellow flowers that I did not see in LA. The geomorphology there is also quite different from that of LA south of the San Gabriel River, but it‚Äôs more reminiscent of Soledad Canyon and Ojai. Now I wish that I were a geologist.\n\n\n\nLooking back from the west end of the San Jose Creek bike path\n\n\nOK, that‚Äôs it for my digression in thought. There‚Äôs a dirt trail the other side of San Jose Creek, apparently for equestrians, as I saw horses there. From what I heard from mountain bikers, horses and bikes don‚Äôt mix very well. After this little stretch of bike path by the San Jose Creek, I braved some traffic and got to the San Gabriel River bike path, where I saw two guys riding time trisl bikes. The river, not channelized, looked like a lake. The unusually high water submerged many of the trees I used to see in the more wetland-like parts when there was less water. I exited the bike path at Valley Blvd, at the railroad bridge full of graffiti, which is a Pacific Electric relic. I saw a cyclist with a child trailer on Valley Blvd from beneath the road; it could have been a great photo, but I missed it.\n\n\n\nThis part of the San Gabriel River is not lined with concrete. After the storm it looked like a lake, so weird by LA standards.\n\n\n\n\n\nGraffiti railroad bridge crossing the San Gabriel River a little north of Valley Blvd"
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#el-monte",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#el-monte",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "El Monte",
    "text": "El Monte\nI took Valley Blvd to downtown El Monte, to check out some public art at the Metrolink and Metro Silver Line stations. The public art at the Metrolink station has a very interesting back story. In brief, the Whittier Narrows area has a Hollywood heritage. There were lion farms and jungle movies were shot in this region. The public art commemorates this forgotten heritage. Though I‚Äôm sure that PETA is so glad that it‚Äôs no longer there, since I‚Äôm sure that lion farms aren‚Äôt very humane.\n\n\n\nDowntown El Monte, entering Main St from Ramona Blvd\n\n\n\n\n\nPublic art at El Monte Metrolink Station.\n\n\nAlso to revisit the Main St mall, with murals sponsored by the new fast fashion company Shein. Those are good murals, though I‚Äôm not a fan of fast fashion in general because it‚Äôs inherently unsustainable. I proudly wear clothes that are over 10 years old. I bought a second hand Pearl Izumi long sleeve jersey for more casual rides; based on the style of the Pearl Izumi logo and that it was made in the US, I guess it was probably made in the 1980s or 1990s, so it‚Äôs probably older than I am and must be full of stories I most likely never get to hear. It might not be specifically made for women though it was small enough to fit me. Also consistent with its age, it stinks pretty easily while my 2020s jersies have modern odor resistant tech.\n\n\n\nOne of the Shein murals. Note that Main St was not very prosperous as many shops there were closed.\n\n\n\n\n\nPublic art at El Monte Silver Line station. One more reason why transit rocks!"
  },
  {
    "objectID": "posts/2023-05-12-activesgv-puente-hills/index.html#rio-hondo",
    "href": "posts/2023-05-12-activesgv-puente-hills/index.html#rio-hondo",
    "title": "ActiveSGV Puente Hill ride and hike",
    "section": "Rio Hondo",
    "text": "Rio Hondo\nIt turns out that, unlike on Strava‚Äôs map, I actually could direct access the Rio Hondo bike path from the Silver Line station. Rio Hondo was covered side to side with water, and that‚Äôs a lot of water by LA standards. Normally the river was mostly dry so we could walk in it, with water only in the narrow central ditch and maybe a little bit beyond. So I almost forgot that in many other parts of the world, rivers can be so large that they can carry ships.\n\n\n\nOn Rio Hondo\n\n\n\n\n\nA man riding on the sloped concrete bank of Rio Hondo\n\n\n\n\n\nAs he approached the Arcadia Wash confluence that disruped the sloped bank, he had to dismount and walk into the river.\n\n\n\n\n\nHe continued riding into Arcadia Wash\n\n\nI saw a man riding a bike on the concrete bank. I rode faster than he did so I could dial in camera settings and take photos of him when he caught up. The sloped concrete bank was interrupted by the Arcadia Wash, so he had to dismount and walk into the river, which wasn‚Äôt deep. Then he continued riding on the river bed into Arcadia Wash. I wonder how he could get out as the river bank was perpendicular to the ground.\n\n\n\nThe San Gabriel Valley Airport\n\n\n\n\n\nAn airplane about to land\n\n\nThe mountains were shrouded in cloud, but a little bit of the snowy peaks peeked out. It was unusual to see so much snow, after the cold February storm. An airplane was landing at the San Gabriel Valley Airport. I know that I can see Mt San Antonio from here, but it was hidden behind clouds.\n\n\n\nThe submerged bike path\n\n\n\n\n\nMap of LA River and San Gabriel River at the park\n\n\n\n\n\nSnowy peak peeking out of the cloud, from the Peck Rd park\n\n\nPeck Rd Water Conservation Area is a reservoir where the Sawpit Wash and Santa Anita Wash meet and form Rio Hondo. There‚Äôs a bike path south of the lake, which was flooded. So I rode into the park, just to take a look since it‚Äôs been a while since I last visited. There was a map of LA and San Gabriel Rivers etched on the ground. I stood in such a way that my shadow pointed to Peck Rd Water Conservation Area.\nBecause that part of the bike path was flooded, I had to exit the park on Peck Rd, braving the traffic, before I turned left on Live Oak Ave, where I crossed Foss Ave. Yep, join us now and share that software, you‚Äôll be free hackers, you‚Äôll be free. I mean Free and Open Source Software (FOSS). After that, I went on Longden, standard route returning from the eastern part of the SGV."
  }
]