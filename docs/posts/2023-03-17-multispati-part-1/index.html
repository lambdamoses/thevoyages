<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lambda Moses">
<meta name="dcterms.date" content="2023-03-17">

<title>These R the Voyages - Spatially informed PCA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">These R the Voyages</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">Lambda Moses</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lambdamoses"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@lambdamoses"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Spatially informed PCA</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">spatial-omics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Lambda Moses </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 17, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#preprocess-data" id="toc-preprocess-data" class="nav-link" data-scroll-target="#preprocess-data">Preprocess data</a></li>
  <li><a href="#multispati-pca" id="toc-multispati-pca" class="nav-link" data-scroll-target="#multispati-pca">MULTISPATI PCA</a>
  <ul class="collapse">
  <li><a href="#morans-i-of-multispati-and-non-spatial-pca-embeddings" id="toc-morans-i-of-multispati-and-non-spatial-pca-embeddings" class="nav-link" data-scroll-target="#morans-i-of-multispati-and-non-spatial-pca-embeddings">Moran’s I of MULTISPATI and non-spatial PCA embeddings</a></li>
  </ul></li>
  <li><a href="#clustering-with-multispati-pca" id="toc-clustering-with-multispati-pca" class="nav-link" data-scroll-target="#clustering-with-multispati-pca">Clustering with MULTISPATI PCA</a>
  <ul class="collapse">
  <li><a href="#clustering-with-non-spatial-pca" id="toc-clustering-with-non-spatial-pca" class="nav-link" data-scroll-target="#clustering-with-non-spatial-pca">Clustering with non-spatial PCA</a></li>
  <li><a href="#with-multispati-pca" id="toc-with-multispati-pca" class="nav-link" data-scroll-target="#with-multispati-pca">With MULTISPATI PCA</a></li>
  <li><a href="#smaller-scale-clusters" id="toc-smaller-scale-clusters" class="nav-link" data-scroll-target="#smaller-scale-clusters">Smaller scale clusters</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Due to the large number of genes quantified in single cell and spatial transcriptomics, dimension reduction is part of the standard workflow to analyze such data, to visualize and to extract a smaller number of more relevant features for further analyses, and to speed up computation.</p>
<p>The first dimension reduction methods we learn about, such as good old principal component analysis (PCA), tSNE, and UMAP, don’t use spatial information. With the rise of spatial transcriptomics, some dimension reduction methods that take spatial dependence into account have been written. Some, such as <code>SpatialPCA</code> <span class="citation" data-cites="Shang2022-qy">(<a href="#ref-Shang2022-qy" role="doc-biblioref">Shang and Zhou 2022</a>)</span>, <code>NSF</code> <span class="citation" data-cites="Townes2023-bi">(<a href="#ref-Townes2023-bi" role="doc-biblioref">Townes and Engelhardt 2023</a>)</span>, and <code>MEFISTO</code> <span class="citation" data-cites="Velten2022-gv">(<a href="#ref-Velten2022-gv" role="doc-biblioref">Velten et al. 2022</a>)</span> use factor analysis or probabilistic PCA which is related to factor analysis, and model the factors as Gaussian processes, with a spatial kernel for the covariance matrix, so the factors have positive spatial autocorrelation and can be used for downstream clustering where the clusters can be more spatially coherent. Some use graph convolution networks on a spatial neighborhood graph to find spatially informed embeddings of the cells, such as <code>conST</code> <span class="citation" data-cites="Zong2022-tb">(<a href="#ref-Zong2022-tb" role="doc-biblioref">Zong et al. 2022</a>)</span> and <code>SpaceFlow</code> <span class="citation" data-cites="Ren2022-qx">(<a href="#ref-Ren2022-qx" role="doc-biblioref">Ren et al. 2022</a>)</span>. <code>SpaSRL</code> <span class="citation" data-cites="Zhang2023-kf">(<a href="#ref-Zhang2023-kf" role="doc-biblioref">Zhang et al. 2023</a>)</span> finds a low dimension projection of spatial neighborhood augmented data.</p>
<p>Spatially informed dimension reduction is actually not new, and dates back to at least 1985, with Wartenberg’s crossover of Moran’s I and PCA <span class="citation" data-cites="Wartenberg1985-fk">(<a href="#ref-Wartenberg1985-fk" role="doc-biblioref">Wartenberg 1985</a>)</span>, which was generalized and further developed as MULTISPATI PCA <span class="citation" data-cites="Dray2008-en">(<a href="#ref-Dray2008-en" role="doc-biblioref">Dray, Saı̈d, and Débias 2008</a>)</span>, implemented in the <a href="https://cran.r-project.org/web/packages/adespatial/index.html"><code>adespatial</code></a> package on CRAN. In short, while PCA tries to maximize the variance explained by each PC, MULTISPATI maximizes the product of Moran’s I and variance explained. Also, while all the eigenvalues from PCA are non-negative, because the covariance matrix is positive semidefinite, MULTISPATI can give negative eigenvalues, which represent negative spatial autocorrelation, which can be present and interesting but is not as common as positive spatial autocorrelation and is often masked by the latter <span class="citation" data-cites="Griffith2019-bo">(<a href="#ref-Griffith2019-bo" role="doc-biblioref">Griffith 2019</a>)</span>.</p>
<p>In single cell -omics conventions, let <span class="math inline">\(X\)</span> denote a gene count matrix whose columns are cells or Visium spots and whose rows are genes, with <span class="math inline">\(n\)</span> columns. Let <span class="math inline">\(W\)</span> denote the row normalized <span class="math inline">\(n\times n\)</span> adjacency matrix of the spatial neighborhood graph of the cells or Visium spots, which does not have to be symmetric. MULTISPATI diagonalizes a symmetric matrix</p>
<p><span class="math display">\[
H = \frac 1 {2n} X(W^t+W)X^t
\]</span></p>
<p>However, the implementation in <code>adespatial</code> is more general and can be used for other multivariate analyses in the <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3265363/">duality diagram</a> paradigm, such as correspondence analysis; the equation above is simplified just for PCA, without having to introduce the duality diagram here.</p>
<p>In this blog post, I use <code>adespatial</code> to run MULTISPATI PCA, compare the results to those of non-spatial PCA, and in <a href="https://lambdamoses.github.io/thevoyages/posts/2023-03-19-multispati-part-2/">Part 2</a> of the post, try a faster implementation using <a href="https://cran.r-project.org/web/packages/RSpectra/index.html"><code>RSpectra</code></a>. The faster implementation will be added to the next release of <code>Voyager</code> in Bioconductor 3.17 in May. This will be the first multivariate spatial analysis method in <code>Voyager</code>, as the implementation is straightforward and all packages required are on CRAN or Bioconductor. This blog post itself will be edited to become a new vignette. I’m writing it here in the process to think before I code. <strong>So the code here isn’t meant to remain runnable in the future after the next release comes out, because the user interface of devel functions in Voyager can change in the next few weeks.</strong></p>
<p>Here we load the packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ade4)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(adespatial)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SFEData)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Voyager)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sparseMatrixStats)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SingleCellExperiment)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bluster)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The development version of <code>Voyager</code> is used here, and I will note code that doesn’t work with the current release version in Bioconductor 3.16. In Bioconductor version numbering conventions, an odd minor version number (the second number) means devel.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">packageVersion</span>(<span class="st">"Voyager"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] '1.1.10'</code></pre>
</div>
</div>
</section>
<section id="preprocess-data" class="level1">
<h1>Preprocess data</h1>
<p>The Visium dataset used here comes from mouse skeletal muscle 2 days after notexin injury, published in <span class="citation" data-cites="McKellar2021-ek">(<a href="#ref-McKellar2021-ek" role="doc-biblioref">McKellar et al. 2021</a>)</span>. Quality control and basic exploratory data analysis are shown in <a href="https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html"><code>Voyager</code> vignettes</a> so are not reproduced here.</p>
<p>The H&amp;E image of this section: <img src="https://raw.githubusercontent.com/pachterlab/voyager/documentation/vignettes/tissue_lowres_5a.jpeg" class="img-fluid" alt="A cross section of mouse muscle is slightly off center to the lower left. In the middle of the tissue is the notexin injury site with leukocyte infiltration and fewer myofibers. The rest of the tissue section is tightly packed with myofibers."></p>
<p>Here we load the data into R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(sfe <span class="ot">&lt;-</span> <span class="fu">McKellarMuscleData</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>snapshotDate(): 2022-10-31</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>see ?SFEData and browseVignettes('SFEData') for documentation</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>loading from cache</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>require("SpatialFeatureExperiment")</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>class: SpatialFeatureExperiment 
dim: 15123 4992 
metadata(0):
assays(1): counts
rownames(15123): ENSMUSG00000025902 ENSMUSG00000096126 ...
  ENSMUSG00000064368 ENSMUSG00000064370
rowData names(6): Ensembl symbol ... vars cv2
colnames(4992): AAACAACGAATAGTTC AAACAAGTATCTCCCA ... TTGTTTGTATTACACG
  TTGTTTGTGTAAATTC
colData names(12): barcode col ... prop_mito in_tissue
reducedDimNames(0):
mainExpName: NULL
altExpNames(0):
spatialCoords names(2) : imageX imageY
imgData names(1): sample_id

Geometries:
colGeometries: spotPoly (POLYGON) 
annotGeometries: tissueBoundary (POLYGON), myofiber_full (POLYGON), myofiber_simplified (POLYGON), nuclei (POLYGON), nuclei_centroid (POINT) 

Graphs:
Vis5A: </code></pre>
</div>
</div>
<p>The data includes spots that are not on tissue. We only use the spots that overlap with the tissue here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> sfe[, sfe<span class="sc">$</span>in_tissue]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Normalize data and find highly variable genes with the <code>scran</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(sfe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(sfe)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>hvgs <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">n =</span> <span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the highly variable gene results for plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dec<span class="sc">$</span>symbol <span class="ot">&lt;-</span> <span class="fu">rowData</span>(sfe)[<span class="fu">match</span>(<span class="fu">rownames</span>(<span class="fu">rowData</span>(sfe)), <span class="fu">rownames</span>(dec)), <span class="st">"symbol"</span>]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fit_dec <span class="ot">&lt;-</span> <span class="fu">metadata</span>(dec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get colorblind friendly palette</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"ditto_colors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(fit_dec[<span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"var"</span>)]) <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">is_hvg =</span> <span class="fu">rownames</span>(dec) <span class="sc">%in%</span> hvgs) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(mean, var)) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> is_hvg), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_function</span>(<span class="at">fun =</span> fit_dec<span class="sc">$</span>trend, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean of log counts"</span>, <span class="at">y =</span> <span class="st">"Variance of log counts"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Highly</span><span class="sc">\n</span><span class="st">variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>According to the <a href="https://bioconductor.org/books/3.16/OSCA.basic/feature-selection.html#quantifying-per-gene-variation">Orchestrating Single Cell Analysis with Bioconductor (OSCA)</a> book, the log transformed values are used so Euclidean distances represent log fold changes, so genes with 100 counts in one cell type and 50 in another would be more emphasized than genes with 1100 counts in one cell type and 1000 in another. Most of the variation in gene expression is assumed to be technical and uninteresting biological variation, modeled by the curve fitted to the variance vs.&nbsp;mean plot. Highly variable genes have more variance than explained by that curve. Here we see that after log normalization, the highly variable genes have a wide range of levels of expression. Since <code>scran</code> uses log2 so differences in values can be interpreted as fold change and the scale factors are centered at 1 so the log normalized values can be more readily transformed back to original counts (<span class="math inline">\(x\)</span> in log transformed value would be roughly <span class="math inline">\(2^x\)</span> in counts), the range we see here is from nearly 0 to maybe 256. Here’s the range of expression levels of highly variable genes in raw counts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>hvg_means <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">counts</span>(sfe)[hvgs,])</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hvg_means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
  0.0011   0.1084   0.2141   1.2462   0.4802 356.0225 </code></pre>
</div>
</div>
<p>What are the most highly expressed highly variable genes?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(sfe)[hvgs[<span class="fu">order</span>(hvg_means, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]], <span class="st">"symbol"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "mt-Co1"  "Myh4"    "mt-Nd4"  "mt-Nd2"  "mt-Cytb" "mt-Nd3"  "Tnnc2"  
 [8] "Tpm1"    "Tnni2"   "Myl1"   </code></pre>
</div>
</div>
<p>These mitochondrial and skeletal muscle genes, which is not surprising given that this is a skeletal muscle dataset. Tnnc2 is troponin C2, fast skeletal type. Tpm1 is tropomyosin 1. Myh4 is myosin heavy chain 4. Tnni2 is troponin I2, fast skeletal type. Myl1 is myosin light chain 1.</p>
<p>What are the least highly expressed highly variable genes?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(sfe)[hvgs[<span class="fu">order</span>(hvg_means)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]], <span class="st">"symbol"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Gm25099"       "1700088E04Rik" "Dixdc1"        "Tesc"         
 [5] "Gldn"          "Ndnf"          "Gm13012"       "Kif13b"       
 [9] "Tmem255b"      "2310058D17Rik"</code></pre>
</div>
</div>
<p>Some unannotated and less studied genes.</p>
<p>What are the highly variable genes with the largest “biological” component?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dec) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dec[<span class="fu">order</span>(dec<span class="sc">$</span>bio, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ], <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 10 rows and 7 columns
        mean     total      tech       bio     p.value         FDR      symbol
   &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt; &lt;character&gt;
1    2.29638   4.01867   1.22416   2.79451 2.01788e-44 1.01183e-40        Spp1
2    2.71027   3.50818   1.27105   2.23712 3.23763e-27 4.05864e-24        Ftl1
3    2.21783   3.37962   1.21788   2.16174 1.20002e-27 1.64108e-24      Lgals3
4    3.22352   3.20809   1.29231   1.91578 7.31366e-20 5.00088e-17        Ctsb
5    2.12640   2.80889   1.21147   1.59742 4.22693e-16 1.98705e-13        Lgmn
6    2.29238   2.77378   1.22392   1.54987 5.44090e-15 2.33850e-12          Mb
7    3.56296   2.74445   1.25213   1.49232 1.74706e-13 5.47520e-11        Psap
8    3.67225   2.69356   1.24358   1.44998 5.55292e-13 1.60640e-10        Myh1
9    2.73703   2.72133   1.27389   1.44744 2.03761e-12 5.37751e-10         B2m
10   3.36722   2.70455   1.27026   1.43429 2.76503e-12 6.80421e-10        Actb</code></pre>
</div>
</div>
<p>They are not the most highly expressed genes, but still much more expressed than most other highly variable genes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_dec<span class="sc">$</span>mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.00000 0.01001 0.05144 0.16140 0.14853 8.06119 </code></pre>
</div>
</div>
<p>Here we run non-spatial PCA. To scale or not to scale? This is relevant to both spatial and non-spatial PCA. In Seurat, the log normalized data is scaled, or standardized, so the mean is 0 and variance is 1, before PCA. The purpose of scaling before PCA is that when different variables are measured in different units or different scales, scaling the data will prevent the variables with much larger values due to the units to dominate the variance simply because of the units.</p>
<p>If we don’t want genes with higher expression and thus higher variance to dominate the principal components simply because they tend to be more highly expressed across all cells or spots, and if the absolute level of expression itself is not of interest, then scaling would make sense. While log transform pulls the very long tail in, more highly expressed genes still have much larger values than less expressed genes. Given the wide range (though much wider before log transform) of values, scaling makes sense if all highly variable genes are deemed important. The less expressed genes may give more nuances not expected from the very highly expressed genes characteristic of the tissue and already well-studied. So I scale the data here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(sfe, <span class="at">ncomponents =</span> <span class="dv">30</span>, <span class="at">subset_row =</span> hvgs, <span class="at">scale =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>(pca_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="sc">-</span> start)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.610846 secs</code></pre>
</div>
</div>
<p>Here we plot the results: variance explained by each PC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(sfe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Top gene loadings for each PC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDimLoadings</span>(sfe, <span class="at">swap_rownames =</span> <span class="st">"symbol"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Plotting spot embeddings in each PC in histological space</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spatialReducedDim</span>(sfe, <span class="st">"PCA"</span>, <span class="dv">8</span>, <span class="at">divergent =</span> <span class="cn">TRUE</span>, <span class="at">diverge_center =</span> <span class="dv">0</span>,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>PC1 separates myofibers from the leukocyte filtrated injury site. PC2 and PC3 separate muscle tendon junctions from the rest of the tissue but PC2 also picks up more on the edges of the regions with myofibers while PC3 has more emphasis on the muscle tendon junctions. PC4 and after seem to pick up outliers. While spatial information is not used to compute PCA here, PCs 1-3 do exhibit spatial structure, because different cell types are located in different regions in this tissue.</p>
</section>
<section id="multispati-pca" class="level1">
<h1>MULTISPATI PCA</h1>
<p>Here I use the <code>adespatial</code> implementation of MULTISPATI to perform spatial PCA and time the execution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colGraph</span>(sfe, <span class="st">"visium"</span>) <span class="ot">&lt;-</span> <span class="fu">findVisiumGraph</span>(sfe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First I need to convert the data into a data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">logcounts</span>(sfe)[hvgs,] <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default, the <code>ade4::dudi.pca()</code> function centers and scales the data. The “dudi” in the name means duality diagram, the philosophy of the <code>ade4</code> and <code>adespatial</code> packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">dudi.pca</span>(df, <span class="at">scannf =</span> <span class="cn">FALSE</span>, <span class="at">nf =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here I get 30 top positive and 30 top negative PCs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>multispati_res <span class="ot">&lt;-</span> <span class="fu">multispati</span>(pca, <span class="fu">colGraph</span>(sfe, <span class="st">"visium"</span>), <span class="at">scannf =</span> <span class="cn">FALSE</span>,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nfposi =</span> <span class="dv">30</span>, <span class="at">nfnega =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Reformat and add the results to the SFE object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>multispati_mat <span class="ot">&lt;-</span> multispati_res<span class="sc">$</span>li</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(multispati_mat) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(sfe)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>loadings <span class="ot">&lt;-</span> multispati_res<span class="sc">$</span>c1</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(loadings) <span class="ot">&lt;-</span> hvgs</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(loadings) <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(<span class="fu">colnames</span>(loadings), <span class="st">"CS"</span>, <span class="st">"PC"</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(multispati_mat, <span class="st">"rotation"</span>) <span class="ot">&lt;-</span> loadings</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">reducedDim</span>(sfe, <span class="st">"multispati"</span>) <span class="ot">&lt;-</span> multispati_mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 19.3104 secs</code></pre>
</div>
</div>
<p>That may not seem too bad at first sight, even with R’s non-optimized BLAS, although all eigenvalues are computed while most are not saved to the results. There are only 900 something spots and 2000 highly variable genes in this dataset. My laptop will run out of RAM when there are 100,000 cells, such as in the CosMX and Xenium datasets in <code>SFEData</code>, because according to this <a href="https://slowkow.com/notes/pca-benchmark/">awesome benchmark of PCA methods in R</a>, base R’s <code>prcomp</code> uses 42 GB of RAM for 100,000 cells, which my laptop doesn’t have.</p>
<p>In addition, the eigen decomposition is done twice here. First in <code>dudi.pca()</code>, computing the full spectrum, from which <code>multispati()</code> grabs the original data and the duality diagram column and row weights but not the PCA results. Second in <code>multispati()</code> where we find all eigenvalues and eigenvectors of a different matrix with the spatial weights. This is very inefficient because a lot of unnecessary work is done. I’ll write a faster implementation with <code>RSpectra</code>; while unlike non-spatial PCA, MULTISPATI can’t be simply converted to singular value decomposition (SVD), <code>RSpectra</code> has an efficient algorithm to only find a small number of eigenvectors with the largest or smallest <span class="math inline">\(k\)</span> eigenvalues. Furthermore, <code>RSpectra</code> natively supports sparse matrix so I don’t have to convert the data into dense matrix and then data frame as I have done just now.</p>
<p>In contrast, finding 30 non-spatial PCs with <code>Irlba</code> in the previous section only took about 0.611 seconds; IRLBA is an approximate SVD method, and only 30 instead of 900 something PCs were computed.</p>
<p>Now look at the results: The eigenvalues can be negative.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(multispati_res<span class="sc">$</span>eig, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Eigenvalues of MULTISPATI"</span>, <span class="at">ylab =</span> <span class="cn">NA</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The top positive eigenvalues are much larger in magnitude than the top (or bottom?) negative ones. Here I got the eigenvectors and spot embeddings with the top 30 positive and negative eigenvalues. To better show a negative elbow plot not dwarfed by the positive one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">tail</span>(multispati_res<span class="sc">$</span>eig, <span class="dv">30</span>), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Eigenvalues of MULTISPATI"</span>, <span class="at">ylab =</span> <span class="cn">NA</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Reading this plot in the opposite direction from the regular PCA elbow plot: there’s an elbow at the 3rd to last component. Then the eigenvalues increase steadily.</p>
<p>How do the top positive eigenvalues compare to those of non-spatial PCA?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_eigs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PCA =</span> pca<span class="sc">$</span>eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">MULTISPATI =</span> multispati_res<span class="sc">$</span>eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_eigs <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>index, <span class="at">names_to =</span> <span class="st">"name"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(index, value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Eigenvalue"</span>, <span class="at">color =</span> <span class="st">"Type"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There’s the similar sharp drop from PC1 to PC2, and MULTISPATI eigenvalues tend to be smaller than their non-spatial PCA counterparts. In non-spatial PCA, the eigenvalue is variance explained by each PC, but this does not hold for MULTISPATI. So here I compare the actual variance of the MULTISPATI embeddings with the non-spatial PCA eigenvalues:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">ncol</span>(sfe)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>df_eigs2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PCA =</span> <span class="fu">attr</span>(<span class="fu">reducedDim</span>(sfe, <span class="st">"PCA"</span>), <span class="st">"percentVar"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]<span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">MULTISPATI =</span> <span class="fu">colVars</span>(<span class="fu">as.matrix</span>(multispati_mat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])) <span class="sc">/</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sum</span>(pca<span class="sc">$</span>eig),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_eigs2 <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>index, <span class="at">names_to =</span> <span class="st">"name"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(index, value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Percentage of variance explained"</span>, <span class="at">color =</span> <span class="st">"Type"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The loss of variance explained in MULTISPATI due to accounting for Moran’s I is small for the first 2 PCs. For the later PCs, MULTISPATI can still explain the majority of the amount of variance explained by the non-spatial PCs. Plot the genes with top loadings in the top 2 positive and negative PCs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDimLoadings</span>(sfe, <span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">932</span><span class="sc">:</span><span class="dv">933</span>), <span class="at">reduction =</span> <span class="st">"multispati"</span>,</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">swap_rownames =</span> <span class="st">"symbol"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we plot the 4 spatial PCs with the most positive eigenvalues and 4 PCs with the most negative eigenvalues. Here CS1 looks similar to PC1, but the other components look different from their non-spatial counterparts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spatialReducedDim</span>(sfe, <span class="st">"multispati"</span>, <span class="at">ncomponents =</span> <span class="dv">8</span>, </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">divergent =</span> <span class="cn">TRUE</span>, <span class="at">diverge_center =</span> <span class="dv">0</span>, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>What do these components mean? Each component is a linear combination of genes to maximize the product of variance explained and Moran’s I. The second component maximizes this product provided that it’s orthogonal to the first component, and so on. As the loss in variance explained isn’t huge, these components can be considered axes along which <em>spatially coherent</em> groups of spots are separated from each other as much as possible according to expression of the highly variable genes, so in theory, clustering with positive MULTISPATI components should give more spatially coherent clusters. Because of the spatial coherence, MULTISPATI might be more robust to outliers.</p>
<p>Also, it seems that the subsequent components highlight smaller spatial regions than PC1 and PC2, so potentially, by choosing different components, spatial regions of different scales can be discovered. Here we confirm this with a Moran’s I correlogram:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">reducedDimUnivariate</span>(sfe, <span class="st">"sp.correlogram"</span>, <span class="at">dimred =</span> <span class="st">"multispati"</span>,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">components =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">order =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotCorrelogram</span>(sfe, <span class="at">features =</span> <span class="fu">paste0</span>(<span class="st">"CS"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>), <span class="at">reducedDimName =</span> <span class="st">"multispati"</span>) <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">option =</span> <span class="st">"E"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In Visium’s regular hexagonal grid, orders of neighbors – i.e.&nbsp;second order means neighbors of neighbors and 3rd order means neighbors of neighbors of neighbors – are a proxy of distance. Indeed, spatial autocorrelation, as measured by Moran’s I, tends to decay over shorter distance for the “later” components.</p>
<p>Next plot the projection of each spot on the top negative components:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spatialReducedDim</span>(sfe, <span class="st">"multispati"</span>, <span class="at">ncomponents =</span> <span class="dv">53</span><span class="sc">:</span><span class="dv">60</span>, </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">divergent =</span> <span class="cn">TRUE</span>, <span class="at">diverge_center =</span> <span class="dv">0</span>, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>The components with negative eigenvalues tend to highlight the leukocyte infiltrated region and the edge of the muscle. How shall they be interpreted? The component with the most negative eigenvalue minimizes the product of variance explained and Moran’s I. Because the eigenvalues can be negative while variance can’t be negative, a larger variance explained coupled with a more negative Moran’s I will make the product more negative, hence minimizing it. So these negative components can shed light on local spatial heterogeneity, perhaps caused by local competition or colocalization of different cell types whose differences contribute to tissue function, such as myofibers and satellite cells in the skeletal muscle, and hepatocytes and Kupffer cells in the liver. Here we plot percentage of variance explained by the top negative components:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>inds <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(multispati_mat), <span class="dv">30</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>df_neg <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">percentVar =</span> <span class="fu">colVars</span>(<span class="fu">as.matrix</span>(multispati_mat[, inds])) <span class="sc">/</span> <span class="fu">sum</span>(pca<span class="sc">$</span>eig),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> inds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_neg, <span class="fu">aes</span>(index, percentVar)) <span class="sc">+</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Percentage variance explained"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this dataset, the percentage of variance explained by each of the top negative components is minuscule, around 0.3%, and is higher for components with more negative eigenvalues. However, this might not be so minuscule for some other datasets with single cell resolution, which I’ll look at in Part 2, to see how relevant negative spatial autocorrelation is to spatial transcriptomics. But we are looking at the global variance here, which can be diminished because most spots take homogeneous values while some smaller regions are very heterogeneous. The new spatially informed dimension reduction methods using Gaussian process all impose positive spatial autocorrelation on the factors or components, which can be problematic if negative spatial autocorrelation is relevant to some tissues.</p>
<p>However, negative spatial autocorrelation at the scale of Visium spots does not seem very relevant to this particular dataset, possibly due to the lower spatial resolution averaging out some local competitions and heterogeneity at the single cell level. Or maybe while individual negative components don’t seem to matter, they collectively matter.</p>
<section id="morans-i-of-multispati-and-non-spatial-pca-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="morans-i-of-multispati-and-non-spatial-pca-embeddings">Moran’s I of MULTISPATI and non-spatial PCA embeddings</h2>
<p>Here we compute Moran’s I for the spot embeddings. Note that this is a devel feature, not implemented in the Bioconductor 3.16 version of Voyager, and might change before the release of Bioconductor 3.17.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># non-spatial</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">reducedDimMoransI</span>(sfe, <span class="at">dimred =</span> <span class="st">"PCA"</span>, <span class="at">components =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">reducedDimMoransI</span>(sfe, <span class="at">dimred =</span> <span class="st">"multispati"</span>, <span class="at">components =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>df_moran <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">PCA =</span> <span class="fu">reducedDimFeatureData</span>(sfe, <span class="st">"PCA"</span>)<span class="sc">$</span>moran_Vis5A[<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>],</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">MULTISPATI_pos =</span> <span class="fu">reducedDimFeatureData</span>(sfe, <span class="st">"multispati"</span>)<span class="sc">$</span>moran_Vis5A[<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>],</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">MULTISPATI_neg =</span> <span class="fu">reducedDimFeatureData</span>(sfe,<span class="st">"multispati"</span>)<span class="sc">$</span>moran_Vis5A[<span class="dv">31</span><span class="sc">:</span><span class="dv">60</span>] <span class="sc">|&gt;</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">rev</span>(),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The lower bound of Moran’s I given the spatial neighborhood graph is usually greater than -1, while the upper bound is usually around 1. The bounds given this particular spatial neighborhood graph can be found here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(mb <span class="ot">&lt;-</span> <span class="fu">moran.bounds</span>(<span class="fu">colGraph</span>(sfe, <span class="st">"visium"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Imin       Imax 
-0.5762132  1.0021884 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df_moran <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>index, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"name"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(index, value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors) <span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> mb, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_pretty</span>()) <span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Moran's I"</span>, <span class="at">color =</span> <span class="st">"Type"</span>, <span class="at">x =</span> <span class="st">"Component"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>MULTISPATI’s PCs do have higher Moran’s I than those of non-spatial PCA, when the eigenvalues are positive. The difference is much larger after the first 2 PCs. Moran’s I drops quickly towards 0 as we move on to the subsequent non-spatial PCs, while the decay is much more gradual for MULTISPATI. The negative Moran’s I’s for the components with the most negative eigenvalues are actually very strong considering the bounds (shown in dashed horizontal lines).</p>
</section>
</section>
<section id="clustering-with-multispati-pca" class="level1">
<h1>Clustering with MULTISPATI PCA</h1>
<p>In the standard scRNA-seq data analysis workflow, a k nearest neighbor graph is found in the PCA space, which is then used for graph based clustering such as Louvain and Leiden, which is used to perform differential expression. Spatial dimension reductions can similarly be used to perform clustering, to identify spatial regions in the tissue, as done in <span class="citation" data-cites="Shang2022-qy Ren2022-qx Zhang2023-kf">(<a href="#ref-Shang2022-qy" role="doc-biblioref">Shang and Zhou 2022</a>; <a href="#ref-Ren2022-qx" role="doc-biblioref">Ren et al. 2022</a>; <a href="#ref-Zhang2023-kf" role="doc-biblioref">Zhang et al. 2023</a>)</span>. This type of studies often use a manual segmentation as ground truth to compare different methods that identify spatial regions.</p>
<p>The problem with this is that spatial region methods are meant to help us to identify novel spatial regions based on new -omics data, which might reveal what’s previously unknown from manual annotations. If the output from a method doesn’t match manual annotations, it might simply be pointing out a previously unknown aspect of the tissue rather than wrong. Depending on the questions being asked, there can simultaneously be multiple spatial partitions. This happens in geographical space, which I’ll elaborate on in a future blog post. For instance, there’s land use and neighborhood boundaries, but equally valid are watershed boundaries and types of rock formation. Which one is relevant depends on the questions asked.</p>
<p>Here we perform Leiden clustering with non-spatial and MULTISPATI PCA and compare the results. For the k nearest neighbor graph, I used the default k = 10.</p>
<section id="clustering-with-non-spatial-pca" class="level2">
<h2 class="anchored" data-anchor-id="clustering-with-non-spatial-pca">Clustering with non-spatial PCA</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">29</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>sfe<span class="sc">$</span>clusts_nonspatial <span class="ot">&lt;-</span> <span class="fu">clusterCells</span>(sfe, <span class="at">use.dimred =</span> <span class="st">"PCA"</span>, </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">BLUSPARAM =</span> <span class="fu">NNGraphParam</span>(</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.fun =</span> <span class="st">"leiden"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.args =</span> <span class="fu">list</span>(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">objective_function =</span> <span class="st">"modularity"</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">resolution_parameter =</span> <span class="dv">1</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                                          )</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                                      ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Color the PCA scatter plot with the clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotPCA</span>(sfe, <span class="at">ncomponents =</span> <span class="dv">3</span>, <span class="at">colour_by =</span> <span class="st">"clusts_nonspatial"</span>) <span class="sc">+</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Plot the clusters in space:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpatialFeature</span>(sfe, <span class="st">"clusts_nonspatial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Clusters 1, 3, 5, 6, 7 are myofibers, while 2 and 4 are in the leukocyte infiltrated injury region. Cluster 6 may be related to the muscle tendon junction, based on location. We use the silhouette index to score how well separated the clusters are in histological space:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>sil <span class="ot">&lt;-</span> <span class="fu">approxSilhouette</span>(<span class="fu">spatialCoords</span>(sfe), <span class="at">clusters =</span> sfe<span class="sc">$</span>clusts_nonspatial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sil<span class="sc">$</span>width)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.009435808</code></pre>
</div>
</div>
<p>A positive number closer to 1 indicates that the clusters are well-separated. Here the number is close to 0 and is negative, which means that the clusters are not well-separated in space and many spots are closer to spots from other clusters than those from its own cluster, as in the visual impression.</p>
</section>
<section id="with-multispati-pca" class="level2">
<h2 class="anchored" data-anchor-id="with-multispati-pca">With MULTISPATI PCA</h2>
<p>Here we use the top positive MULTISPATI PCs for clustering, with the same Leiden parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">29</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>sfe<span class="sc">$</span>clusts_multispati <span class="ot">&lt;-</span> <span class="fu">clusterRows</span>(<span class="fu">reducedDim</span>(sfe, <span class="st">"multispati"</span>)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>],</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">BLUSPARAM =</span> <span class="fu">NNGraphParam</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.fun =</span> <span class="st">"leiden"</span>,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.args =</span> <span class="fu">list</span>(</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">objective_function =</span> <span class="st">"modularity"</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">resolution_parameter =</span> <span class="dv">1</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                                          )</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                                      ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Color MULTISPATI scatter plot with the clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(sfe, <span class="st">"multispati"</span>, <span class="at">ncomponents =</span> <span class="dv">3</span>, <span class="at">colour_by =</span> <span class="st">"clusts_multispati"</span>) <span class="sc">+</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The shapes of the scatter plots look similar to those in non-spatial PCA, at least for the first 3 PCs.</p>
<p>Color the MULTISPATI scatter plot with non-spatial PCA clustering:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(sfe, <span class="st">"multispati"</span>, <span class="at">ncomponents =</span> <span class="dv">3</span>, <span class="at">colour_by =</span> <span class="st">"clusts_nonspatial"</span>) <span class="sc">+</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> ditto_colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The clusters seem similar except for the numbering.</p>
<p>Plot the MULTISPATI clusters in space, side by side with the non-spatial ones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">plotSpatialFeature</span>(sfe, <span class="st">"clusts_multispati"</span>) <span class="sc">+</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"MULTISPATI"</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">plotSpatialFeature</span>(sfe, <span class="st">"clusts_nonspatial"</span>) <span class="sc">+</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Non-spatial PCA"</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>MULTISPATI clusters (left) do appear more spatially coherent than non-spatial PCA clustering (right). Also compute the silhouette index here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>sil2 <span class="ot">&lt;-</span> <span class="fu">approxSilhouette</span>(<span class="fu">spatialCoords</span>(sfe), <span class="at">clusters =</span> sfe<span class="sc">$</span>clusts_multispati)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sil2<span class="sc">$</span>width)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07191857</code></pre>
</div>
</div>
<p>While it’s not a very high value because there’s only so much that can fit into 2 dimensions, it indicates that the MULTISPATI clusters are better separated in histological space than non-spatial PCA clusters.</p>
<p>What do these clusters mean? Clusters are supposed to be groups of different spots that are more similar within a group, sharing some characteristics. Non-spatial and MULTISPATI PCA use different characteristics for the clustering. Non-spatial PCA finds genes that are good for telling cell types apart, although those genes may happen to be very spatially structured. Non-spatial clustering aims to find these groups only from gene expression, and cells with similar gene expression can be surrounded by cells of other types in histological space. This is just like mapping Art Deco buildings, which are often near Spanish revival and Beaux Art buildings whose styles are quite different and perform different functions, thus not necessarily forming a coherent spatial region.</p>
<p>In contrast, MULTISPATI’s positive components find genes that must characterize spatial regions in addition to distinguishing between different cell types. Which genes are involved in each MULTISPATI component may be as interesting as the clusters. It would be interesting to perform gene set enrichment analysis, or to interpret this as some sort of spatial patterns of spatially variable genes. This is like mapping when the buildings were built, so Art Deco, Spanish revival, Beaux Art popular in the 1920s and 1930s will end up in the same cluster and form a more spatially coherent region, which can be found in DTLA Historical Core and Jewelry District, and Old Pasadena. Hence non-spatial clustering of spatial data isn’t necessarily bad. Rather, it tells a different story and reveals different aspects of the data from spatial clustering.</p>
</section>
<section id="smaller-scale-clusters" class="level2">
<h2 class="anchored" data-anchor-id="smaller-scale-clusters">Smaller scale clusters</h2>
<p>Spatial regions can come in hierarchies. In geographical space, using an example familiar to me from the voyages of starship Voyager, this can be Southern California (SoCal) at a higher level, defined by culture and climate, followed by the metropolitan region of LA and Orange Counties (OC) and perhaps urgan regions of western San Bernardino County, followed by different regions of LA County such as Eastside, Westside, South Bay, Harbor Cities, South LA, Central LA, San Fernando Valley (SFV), Northeast LA, San Gabriel Valley (SGV), Pomona Valley, Angeles National Forest, Antelope Valley, Santa Monica Mountains, and etc., followed by neighborhoods and small cities within those regions, such as Boyle Heights, Highland Park, Mt Washington, Westwood, and etc. which in practice are similar in scale and function to most smaller cities like San Marino, Beverly Hills, Culver City, Arcadia, San Gabriel, and etc., each of which have sub-regions.</p>
<p>Suppose we perform MULTISPATI PCA on LA County, not really quantitatively, just based on my own familiarity and types of interactions with these places. I think PC1 would separate the wilderness of Angeles National Forest, Santa Monica Mountains, Griffith Park, much of San Rafael Hills, and much of Puente hills from the urban and suburban regions. PC2 might separate the mostly Black and Hispanic regions that are usually less affluent such as Eastside, South LA, and NELA, from affluent mostly White and sometimes Asian regions like Westside, South Bay, Beverly Hills, southern SFV, northern SGV, La Canada Flintridge, and etc. but it might not distinguish between different Latino regions such as Highland Park and El Sereno. PC2 and PC3 may also pick up the Asian regions in much of the SGV and in Koreatown. Subsequent PCs may pick up some industrial regions, such as Arts District, Vernon, City of Industry, Carson, Wilmington, and perhaps smaller racialized regions, such as those within Pasadena and DTLA, different vibes of neighborhoods with similar socioeconomic status, mini-downtowns of neighborhoods, smaller but very distinct regions such as the Aerospace Corridor near LAX, and architectural styles from different eras.</p>
<p>Clustering with the first few PCs will give you Angeles National Forest, Eastside, Westside, and etc., which might not answer a specific question about LA, such as different types of Latino neighborhoods, redistricting Pasadena, and different ecosystems within the Angeles National Forest. These questions would benefit from the “later” PCs with smaller length scales of spatial autocorrelation. Another moral of this thought experiment is that the PCs that explain a smaller percentage of variance aren’t necessarily uninteresting. That something else shows a more drastic difference doesn’t mean that smaller differences are irrelevant. I personally find these more local differences very interesting. However, those unfamiliar with the region won’t ask these questions to begin with. Moral: as a bioinformatician not specialized in any particular tissue or disease, each of which seems to be its own field of study, I desperately need the help of experts in those tissues and diseases to make sense of data. I might not be using the most relevant way to find spatial regions when it comes to the more relevant questions about those tissues and diseases.</p>
<p>Anyway, biological interpretations aside, what if we cluster with MULTISPATI components with shorter length scales of spatial autocorrelation?</p>
<p>First, what do those components look like?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spatialReducedDim</span>(sfe, <span class="st">"multispati"</span>, <span class="at">ncomponents =</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">30</span>, </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">divergent =</span> <span class="cn">TRUE</span>, <span class="at">diverge_center =</span> <span class="dv">0</span>, <span class="at">ncol =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>Also plot top gene loadings for some of these MULTISPATI components:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDimLoadings</span>(sfe, <span class="at">dims =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">13</span>, <span class="at">reduction =</span> <span class="st">"multispati"</span>, </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">swap_rownames =</span> <span class="st">"symbol"</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Some genes with high loading in these “later” components are known to be involved in muscle regeneration, such as Myog, Xirp1, and Cxcl9, and potentially Bicd2, Csrp3, and Nek6. The <a href="https://bioconductor.org/packages/release/bioc/html/slingshot.html"><code>slingshot</code></a> package performs pseudotime analysis on any dimension reduction. It would be interesting to see what if we perform pseudotime analysis on MULTISPATI rather than non-spatial PCA, with the later two timepoints and more biological replica. This dataset comes from the first time point after notexin injury, and this study only has one biological replicate per time point.</p>
<p>These components tend to highlight heterogeneity within the leukocyte infiltrated injury region when plotting the embeddings in space, which is consistent with the muscle regeneration genes with high. This seems to be the case, based on visual inspection, for CS8 and later. What if I only use CS8 and later components for clustering?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">29</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>sfe<span class="sc">$</span>clusts_multispati2 <span class="ot">&lt;-</span> <span class="fu">clusterRows</span>(<span class="fu">reducedDim</span>(sfe, <span class="st">"multispati"</span>)[,<span class="dv">8</span><span class="sc">:</span><span class="dv">30</span>],</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">BLUSPARAM =</span> <span class="fu">NNGraphParam</span>(</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.fun =</span> <span class="st">"leiden"</span>,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">cluster.args =</span> <span class="fu">list</span>(</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">objective_function =</span> <span class="st">"modularity"</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">resolution_parameter =</span> <span class="dv">1</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                                          )</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>                                      ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the H&amp;E image for reference: <img src="https://raw.githubusercontent.com/pachterlab/voyager/documentation/vignettes/tissue_lowres_5a.jpeg" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">plotSpatialFeature</span>(sfe, <span class="st">"clusts_multispati2"</span>) <span class="sc">+</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"CS8-30"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">plotSpatialFeature</span>(sfe, <span class="st">"clusts_multispati"</span>) <span class="sc">+</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"CS1-30"</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>It seems that when using all of the top 30 PCs from MULTISPATI, while PC1 by far explains much more variance than other PCs, the heterogeneity from the later PCs is not all overwhelmed and lost. When using only 8-30, perhaps due to the shorter length scale of spatial autocorrelation, the clusters are less spatially contiguous, and there are smaller, more local clusters such as clusters 5 and 6 that might mark distinct muscle regions adjacent to the injury region.</p>
</section>
</section>
<section id="session-info" class="level1">
<h1>Session info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.2 (2022-10-31)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Big Sur ... 10.16

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] SpatialFeatureExperiment_1.1.5 bluster_1.8.0                 
 [3] lubridate_1.9.2                forcats_1.0.0                 
 [5] stringr_1.5.0                  dplyr_1.1.0                   
 [7] purrr_1.0.1                    readr_2.1.4                   
 [9] tidyr_1.3.0                    tibble_3.1.8                  
[11] tidyverse_2.0.0                sparseMatrixStats_1.10.0      
[13] Voyager_1.1.10                 scran_1.26.2                  
[15] scater_1.27.6                  ggplot2_3.4.1                 
[17] scuttle_1.8.4                  SingleCellExperiment_1.20.0   
[19] SummarizedExperiment_1.28.0    Biobase_2.58.0                
[21] GenomicRanges_1.50.2           GenomeInfoDb_1.34.9           
[23] IRanges_2.32.0                 S4Vectors_0.36.1              
[25] BiocGenerics_0.44.0            MatrixGenerics_1.10.0         
[27] matrixStats_0.63.0             SFEData_1.0.2                 
[29] adespatial_0.3-20              ade4_1.7-22                   

loaded via a namespace (and not attached):
  [1] utf8_1.2.3                    R.utils_2.12.2               
  [3] tidyselect_1.2.0              RSQLite_2.3.0                
  [5] AnnotationDbi_1.60.0          htmlwidgets_1.6.1            
  [7] grid_4.2.2                    BiocParallel_1.32.5          
  [9] RNeXML_2.4.11                 DropletUtils_1.18.1          
 [11] munsell_0.5.0                 ScaledMatrix_1.6.0           
 [13] codetools_0.2-19              units_0.8-1                  
 [15] interp_1.1-3                  statmod_1.5.0                
 [17] withr_2.5.0                   colorspace_2.1-0             
 [19] filelock_1.0.2                knitr_1.42                   
 [21] uuid_1.1-0                    rstudioapi_0.14              
 [23] wk_0.7.1                      labeling_0.4.2               
 [25] GenomeInfoDbData_1.2.9        farver_2.1.1                 
 [27] bit64_4.0.5                   rhdf5_2.42.0                 
 [29] vctrs_0.5.2                   generics_0.1.3               
 [31] xfun_0.37                     timechange_0.2.0             
 [33] BiocFileCache_2.6.1           adegenet_2.1.10              
 [35] adephylo_1.1-13               R6_2.5.1                     
 [37] ggbeeswarm_0.7.1              rsvd_1.0.5                   
 [39] locfit_1.5-9.7                bitops_1.0-7                 
 [41] rhdf5filters_1.10.0           cachem_1.0.7                 
 [43] DelayedArray_0.24.0           promises_1.2.0.1             
 [45] scales_1.2.1                  beeswarm_0.4.0               
 [47] gtable_0.3.1                  phylobase_0.8.10             
 [49] beachmat_2.14.0               rlang_1.0.6                  
 [51] splines_4.2.2                 scico_1.3.1                  
 [53] BiocManager_1.30.20           s2_1.1.2                     
 [55] yaml_2.3.7                    reshape2_1.4.4               
 [57] httpuv_1.6.9                  tools_4.2.2                  
 [59] spData_2.2.2                  SpatialExperiment_1.8.0      
 [61] ellipsis_0.3.2                RColorBrewer_1.1-3           
 [63] proxy_0.4-27                  Rcpp_1.0.10                  
 [65] plyr_1.8.8                    progress_1.2.2               
 [67] zlibbioc_1.44.0               classInt_0.4-9               
 [69] RCurl_1.98-1.10               prettyunits_1.1.1            
 [71] dbscan_1.1-11                 deldir_1.0-6                 
 [73] viridis_0.6.2                 ggrepel_0.9.3                
 [75] cluster_2.1.4                 magrittr_2.0.3               
 [77] magick_2.7.3                  ggnewscale_0.4.8             
 [79] patchwork_1.1.2               hms_1.1.2                    
 [81] mime_0.12                     evaluate_0.20                
 [83] xtable_1.8-4                  XML_3.99-0.13                
 [85] jpeg_0.1-10                   gridExtra_2.3                
 [87] compiler_4.2.2                KernSmooth_2.23-20           
 [89] crayon_1.5.2                  R.oo_1.25.0                  
 [91] htmltools_0.5.4               tzdb_0.3.0                   
 [93] mgcv_1.8-41                   later_1.3.0                  
 [95] spdep_1.2-8                   DBI_1.1.3                    
 [97] ExperimentHub_2.6.0           dbplyr_2.3.1                 
 [99] MASS_7.3-58.2                 rappdirs_0.3.3               
[101] sf_1.0-9                      boot_1.3-28.1                
[103] Matrix_1.5-3                  permute_0.9-7                
[105] cli_3.6.0                     adegraphics_1.0-17           
[107] R.methodsS3_1.8.2             parallel_4.2.2               
[109] metapod_1.6.0                 igraph_1.4.1                 
[111] pkgconfig_2.0.3               rncl_0.8.7                   
[113] sp_1.6-0                      xml2_1.3.3                   
[115] vipor_0.4.5                   dqrng_0.3.0                  
[117] XVector_0.38.0                digest_0.6.31                
[119] vegan_2.6-4                   Biostrings_2.66.0            
[121] rmarkdown_2.20                edgeR_3.40.2                 
[123] DelayedMatrixStats_1.20.0     curl_5.0.0                   
[125] shiny_1.7.4                   rjson_0.2.21                 
[127] lifecycle_1.0.3               nlme_3.1-162                 
[129] jsonlite_1.8.4                Rhdf5lib_1.20.0              
[131] BiocNeighbors_1.16.0          seqinr_4.2-23                
[133] viridisLite_0.4.1             limma_3.54.1                 
[135] fansi_1.0.4                   pillar_1.8.1                 
[137] lattice_0.20-45               KEGGREST_1.38.0              
[139] fastmap_1.1.1                 httr_1.4.5                   
[141] interactiveDisplayBase_1.36.0 glue_1.6.2                   
[143] png_0.1-8                     BiocVersion_3.16.0           
[145] bit_4.0.5                     class_7.3-21                 
[147] stringi_1.7.12                HDF5Array_1.26.0             
[149] blob_1.2.3                    BiocSingular_1.14.0          
[151] AnnotationHub_3.6.0           latticeExtra_0.6-30          
[153] memoise_2.0.1                 irlba_2.3.5.1                
[155] e1071_1.7-13                  ape_5.7                      </code></pre>
</div>
</div>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Dray2008-en" class="csl-entry" role="doc-biblioentry">
Dray, Stéphane, Sonia Saı̈d, and Françis Débias. 2008. <span>“Spatial Ordination of Vegetation Data Using a Generalization of Wartenberg’s Multivariate Spatial Correlation.”</span> <em>J. Veg. Sci.</em> 19 (1): 45–56.
</div>
<div id="ref-Griffith2019-bo" class="csl-entry" role="doc-biblioentry">
Griffith, Daniel A. 2019. <span>“Negative Spatial Autocorrelation: One of the Most Neglected Concepts in Spatial Statistics.”</span> <em>Stats</em> 2 (3): 388–415.
</div>
<div id="ref-McKellar2021-ek" class="csl-entry" role="doc-biblioentry">
McKellar, David W, Lauren D Walter, Leo T Song, Madhav Mantri, Michael F Z Wang, Iwijn De Vlaminck, and Benjamin D Cosgrove. 2021. <span>“Large-Scale Integration of Single-Cell Transcriptomic Data Captures Transitional Progenitor States in Mouse Skeletal Muscle Regeneration.”</span> <em>Commun Biol</em> 4 (1): 1280.
</div>
<div id="ref-Ren2022-qx" class="csl-entry" role="doc-biblioentry">
Ren, Honglei, Benjamin L Walker, Zixuan Cang, and Qing Nie. 2022. <span>“Identifying Multicellular Spatiotemporal Organization of Cells with <span>SpaceFlow</span>.”</span> <em>Nat. Commun.</em> 13 (1): 4076.
</div>
<div id="ref-Shang2022-qy" class="csl-entry" role="doc-biblioentry">
Shang, Lulu, and Xiang Zhou. 2022. <span>“Spatially Aware Dimension Reduction for Spatial Transcriptomics.”</span> <em>Nat. Commun.</em> 13 (1): 1–22.
</div>
<div id="ref-Townes2023-bi" class="csl-entry" role="doc-biblioentry">
Townes, F William, and Barbara E Engelhardt. 2023. <span>“Nonnegative Spatial Factorization Applied to Spatial Genomics.”</span> <em>Nat. Methods</em> 20 (2): 229–38.
</div>
<div id="ref-Velten2022-gv" class="csl-entry" role="doc-biblioentry">
Velten, Britta, Jana M Braunger, Ricard Argelaguet, Damien Arnol, Jakob Wirbel, Danila Bredikhin, Georg Zeller, and Oliver Stegle. 2022. <span>“Identifying Temporal and Spatial Patterns of Variation from Multimodal Data Using <span>MEFISTO</span>.”</span> <em>Nat. Methods</em> 19 (2): 179–86.
</div>
<div id="ref-Wartenberg1985-fk" class="csl-entry" role="doc-biblioentry">
Wartenberg, Daniel. 1985. <span>“Multivariate Spatial Correlation: A Method for Exploratory Geographical Analysis.”</span> <em>Geogr. Anal.</em> 17 (4): 263–83.
</div>
<div id="ref-Zhang2023-kf" class="csl-entry" role="doc-biblioentry">
Zhang, Chuanchao, Xinxing Li, Wendong Huang, Lequn Wang, and Qianqian Shi. 2023. <span>“Spatially Aware Self-Representation Learning for Tissue Structure Characterization and Spatial Functional Genes Identification.”</span> <em>bioRxiv</em>, March.
</div>
<div id="ref-Zong2022-tb" class="csl-entry" role="doc-biblioentry">
Zong, Yongshuo, Tingyang Yu, Xuesong Wang, Yixuan Wang, Zhihang Hu, and Yu Li. 2022. <span>“<span class="nocase">conST</span>: An Interpretable Multi-Modal Contrastive Learning Framework for Spatial Transcriptomics.”</span> <em>bioRxiv</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="lambdamoses/thevoyagesComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>